(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=o(n);fetch(n.href,a)}})();const Ne={diesel:{price:8900,calorific:42.6,factor:3090,priceTooltip:"<b>默认值: 8900 元/吨</b><br>参考国内0号柴油市场价格及密度（约0.84kg/L）折算。",calorificTooltip:"<b>默认值: 42.6 MJ/kg</b><br>国标中0号柴油的典型低位发热量参考值。",factorTooltip:"<b>默认值: 3090 kgCO₂/吨</b><br>参考《省级温室气体清单编制指南》中柴油的排放因子。"},heavy_oil:{price:6500,calorific:41.8,factor:3170,priceTooltip:"<b>默认值: 6500 元/吨</b><br>参考国内燃料油（重油）市场平均价格。",calorificTooltip:"<b>默认值: 41.8 MJ/kg</b><br>国标中燃料油（5-7号）的典型低位发热量参考值。",factorTooltip:"<b>默认值: 3170 kgCO₂/吨</b><br>参考《省级温室气体清单编制指南》中燃料油的排放因子。"},residual_oil:{price:5500,calorific:40.2,factor:3250,priceTooltip:"<b>默认值: 5500 元/吨</b><br>参考国内渣油市场平均价格。",calorificTooltip:"<b>默认值: 40.2 MJ/kg</b><br>国标中渣油的典型低位发热量参考值。",factorTooltip:"<b>默认值: 3250 kgCO₂/吨</b><br>参考《省级温室气体清单编制指南》中渣油的排放因子。"}},le=.004184,re=860.42,Pe=[{selectId:"heatingLoadUnit",inputId:"heatingLoad",conversions:{kW:1,"kcal/h":re}},{selectId:"annualHeatingUnit",inputId:"annualHeating",conversions:{kWh:1,KJ:3600,MJ:3.6,GJ:.0036,TJ:36e-7,万大卡:re/1e4,Mkcal:re/1e6}},{selectId:"gridFactorUnit",inputId:"gridFactor",conversions:{"kgCO2/kWh":1,"tCO2/MWh":1}},{selectId:"steamFactorUnit",inputId:"steamFactor",conversions:{"kgCO2/kWh":1,"tCO2/MWh":1,"kgCO2/GJ":1/(3.6/1e3)}},{selectId:"gasFactorUnit",inputId:"gasFactor",dynamicConversions:()=>({"kgCO2/m3":1,"kgCO2/GJ":1/((parseFloat(document.getElementById("gasCalorific").dataset.baseValue)||35.57)/1e3)})},{selectId:"fuelFactorUnit",inputId:"fuelFactor",dynamicConversions:()=>{const e=parseFloat(document.getElementById("fuelCalorific").dataset.baseValue)||42.6;return{"kgCO2/t":1,"kgCO2/kg":1/1e3,"kgCO2/GJ":1e3/e}}},{selectId:"coalFactorUnit",inputId:"coalFactor",dynamicConversions:()=>{const e=parseFloat(document.getElementById("coalCalorific").dataset.baseValue)||29.3;return{"kgCO2/t":1,"kgCO2/kg":1/1e3,"kgCO2/GJ":1e3/e}}},{selectId:"biomassFactorUnit",inputId:"biomassFactor",dynamicConversions:()=>{const e=parseFloat(document.getElementById("biomassCalorific").dataset.baseValue)||16.32;return{"kgCO2/t":1,"kgCO2/kg":1/1e3,"kgCO2/GJ":1e3/e}}},{selectId:"gasCalorificUnit",inputId:"gasCalorific",conversions:{"MJ/m3":1,"kWh/m3":1/3.6,"GJ/m3":1/1e3,"kcal/m3":1/le}},{selectId:"fuelCalorificUnit",inputId:"fuelCalorific",conversions:{"MJ/kg":1,"GJ/t":1,"kWh/kg":1/3.6,"kcal/kg":1/le}},{selectId:"coalCalorificUnit",inputId:"coalCalorific",conversions:{"MJ/kg":1,"GJ/t":1,"kWh/kg":1/3.6,"kcal/kg":1/le}},{selectId:"biomassCalorificUnit",inputId:"biomassCalorific",conversions:{"MJ/kg":1,"kcal/kg":1/le,"GJ/t":1,"kWh/kg":1/3.6}},{selectId:"steamCalorificUnit",inputId:"steamCalorific",conversions:{"kWh/t":1,"GJ/t":3.6/1}}],Q={projectName:"示例项目",calcModeAnnualHours:!0,heatingLoad:"1000",operatingHours:"2000",annualHeating:"2000000",dailyHours:"8",annualDays:"300",loadFactor:"70",modeStandard:!0,hpCapex:"200",storageCapex:"0",hpSalvageRate:"5",hybridLoadShare:"50",hybridAuxHeaterType:"electric",hybridAuxHeaterCapex:"30",hybridAuxHeaterOpex:"0.5",botAnnualRevenue:"150",botAnnualEnergyCost:"60",botAnnualOpexCost:"5",botEquityRatio:"30",botLoanInterestRate:"5",botDepreciationYears:"10",botVatRate:"13",botSurtaxRate:"12",botIncomeTaxRate:"25",compare_gas:!0,gasBoilerCapex:"80",gasSalvageRate:"5",compare_fuel:!0,fuelBoilerCapex:"70",fuelSalvageRate:"5",compare_coal:!0,coalBoilerCapex:"60",coalSalvageRate:"5",compare_biomass:!0,biomassBoilerCapex:"75",biomassSalvageRate:"5",compare_electric:!0,electricBoilerCapex:"50",electricSalvageRate:"5",compare_steam:!0,steamCapex:"0",steamSalvageRate:"0",hpCop:"3.0",gasBoilerEfficiency:"92",fuelBoilerEfficiency:"90",coalBoilerEfficiency:"80",biomassBoilerEfficiency:"85",electricBoilerEfficiency:"98",steamEfficiency:"98",gasCalorific:"35.57",fuelCalorific:"42.6",coalCalorific:"29.3",biomassCalorific:"16.32",steamCalorific:"700",gridFactor:"0.57",gasPrice:"4.2",fuelPrice:"8900",coalPrice:"1000",biomassPrice:"850",steamPrice:"300",gasFactor:"1.97",fuelFactor:"3090",coalFactor:"2420",biomassFactor:"0",steamFactor:"0.35",hpOpexCost:"2.5",gasOpexCost:"1.8",fuelOpexCost:"1.9",coalOpexCost:"6.8",biomassOpexCost:"6.3",electricOpexCost:"0.4",steamOpexCost:"0",lccYears:"15",discountRate:"8",energyInflationRate:"3",opexInflationRate:"5"},_e=Object.keys(Q),he="heatPumpAnalyzerProData_v1";function Ie(e){try{const t=JSON.stringify(e);localStorage.setItem(he,t)}catch(t){console.error("无法保存数据到 localStorage:",t)}}function He(){try{const e=localStorage.getItem(he);return e?JSON.parse(e):null}catch(e){return console.error("无法从 localStorage 加载数据:",e),null}}function Ae(){try{localStorage.removeItem(he),console.log("本地存储已清除")}catch(e){console.error("无法从 localStorage 清除数据:",e)}}const Be={isPositive:e=>{const t=parseFloat(e);return isNaN(t)||t<0?"必须是一个非负数。":null},isStrictlyPositive:e=>{const t=parseFloat(e);return isNaN(t)||t<=0?"必须是一个大于零的数。":null},isPercentage:e=>{const t=parseFloat(e);return isNaN(t)||t<0||t>100?"必须在 0 和 100 之间。":null},isRequired:e=>e.trim()===""?"此项为必填项。":null};function we(e,t){const o=e.nextElementSibling;o&&o.classList.contains("error-message")&&(o.textContent=t,o.classList.remove("hidden"),e.classList.add("input-error"))}function Ve(e){const t=e.nextElementSibling;t&&t.classList.contains("error-message")&&(t.textContent="",t.classList.add("hidden"),e.classList.remove("input-error"))}function j(e){var o;const t=((o=e.dataset.validation)==null?void 0:o.split(","))||[];for(const s of t)if(Be[s]){const n=Be[s](e.value);if(n)return we(e,n),!1}return Ve(e),!0}function De(){const e=document.querySelectorAll("[data-validation]");let t=!0;return e.forEach(o=>{j(o)||(t=!1)}),t}function qe(){document.querySelectorAll("[data-validation]").forEach(t=>{Ve(t)})}let de="3.0",Le="4.0",Re="3.5",z="standard",ue=[],me=[],U,ae,pe,oe;function ve(e,t){me.forEach((o,s)=>{o.classList.toggle("hidden",s+1!==e)}),ue.forEach((o,s)=>{const n=s+1;o.classList.remove("step-active","step-completed"),n<e?o.classList.add("step-completed"):n===e&&o.classList.add("step-active")}),U&&(U.disabled=e===1,U.classList.toggle("cursor-not-allowed",e===1),U.classList.toggle("opacity-50",e===1)),ae&&ae.classList.toggle("hidden",e===t),pe&&pe.classList.toggle("hidden",e!==t),oe&&oe.classList.toggle("hidden",e>3)}function Ue(e,t){if(ue=Array.from(document.querySelectorAll(".stepper .step")),me=Array.from(document.querySelectorAll(".wizard-pane")),U=document.getElementById("prevStepBtn"),ae=document.getElementById("nextStepBtn"),pe=document.getElementById("calculateBtn"),oe=document.getElementById("btn-reset-params"),!U||!ae||ue.length===0||me.length===0){console.error("Wizard UI elements not found. Navigation will not work.");return}ae.addEventListener("click",e),U.addEventListener("click",t)}function je(e){if(!oe){console.warn("Reset button (#btn-reset-params) not found.");return}oe.addEventListener("click",()=>{console.log("Restoring parameters to default values...");for(const t in Q)if(Object.prototype.hasOwnProperty.call(Q,t)){const o=document.getElementById(t);if(o){const s=Q[t];o.type==="checkbox"||o.type==="radio"?o.checked=s:o.value=s,o.dispatchEvent(new Event("change",{bubbles:!0})),o.dispatchEvent(new Event("input",{bubbles:!0}))}}qe(),e?e("所有参数已成功恢复为默认值。","success"):alert("所有参数已成功恢复为默认值。")})}function Je(){Pe.forEach(t=>{const o=document.getElementById(t.selectId),s=document.getElementById(t.inputId);!o||!s||o.addEventListener("change",()=>{const n=t.dynamicConversions?t.dynamicConversions():t.conversions;s.dataset.baseValue===void 0&&(s.dataset.baseValue=s.value);const a=parseFloat(s.dataset.baseValue),c=o.value;if(a===0){s.value=0;return}const d=n[c];if(d==null){console.error("Missing conversion factor for",t.inputId,"to unit",c);return}let l=3;c.includes("/t")&&t.inputId.includes("Calorific")&&(l=1),c.includes("/kg")&&t.inputId.includes("Calorific")&&(l=3),c.includes("GJ/")&&(l=5),c.includes("kcal/kg")&&(l=0),c.includes("kcal/m3")&&(l=0),c.includes("kcal/h")&&(l=0),s.value=(a*d).toFixed(l)})});const e=document.getElementById("biomassCalorificUnit");e&&(e.value="kcal/kg",e.dispatchEvent(new Event("change")))}function Ye(){const e=document.querySelectorAll(".comparison-toggle"),t=o=>{const s=o.dataset.target;if(!s)return;const n=o.checked;document.querySelectorAll(`.related-to-${s}`).forEach(c=>{c.classList.toggle("comparison-inactive",!n)})};e.forEach(o=>{t(o),o.addEventListener("change",()=>t(o))})}function We(e,t){const o=document.getElementById("modeStandard"),s=document.getElementById("modeHybrid"),n=document.getElementById("modeBot"),a=document.getElementById("hybridConfigInputs"),c=document.getElementById("botConfigInputs"),d=document.getElementById("comparisonTogglesContainer"),l=document.getElementById("standardModeSections"),m=document.getElementById("lccParamsContainer"),g=document.getElementById("hpCopLabel"),u=document.getElementById("hpCop"),i=document.getElementById("section2Title"),h=document.getElementById("section7Title"),v=document.getElementById("calcModeAContainer"),b=document.getElementById("calcModeBContainer"),r=document.getElementById("calcModeCContainer"),f=document.querySelectorAll('input[name="calcMode"]');if(!o||!s||!n||!a||!c||!d||!l||!m){console.error("V11.0 (模式选择) UI 元素未在 HTML 中完全找到。");return}const y=x=>{const p=u.value;if(z==="standard"?de=p:z==="hybrid"?Le=p:z==="bot"&&(Re=p),x==="standard"||x==="hybrid"){a.classList.toggle("hidden",x==="standard"),c.classList.add("hidden"),d.classList.remove("hidden"),l.classList.remove("hidden"),m.classList.remove("hidden"),f.forEach(_=>_.disabled=!1);const C=document.querySelector('input[name="calcMode"]:checked');C&&C.dispatchEvent(new Event("change")),x==="standard"?(g.textContent="全年综合性能系数 (SPF)",u.value=de):(g.textContent="工业热泵在此工况下的 SPF",u.value=Le),i.textContent="2. 方案配置",h.textContent="7. 财务分析参数"}else x==="bot"&&(a.classList.add("hidden"),c.classList.remove("hidden"),d.classList.add("hidden"),l.classList.add("hidden"),m.classList.remove("hidden"),v&&v.classList.add("hidden"),b&&b.classList.add("hidden"),r&&r.classList.add("hidden"),f.forEach(C=>C.disabled=!0),g.textContent="BOT 项目 SPF (用于计算电费成本)",u.value=Re,i.textContent="2. 方案与投资配置",h.textContent="7. BOT 财务分析参数");z=x;const I=x==="standard"?"3.0":x==="hybrid"?"4.0":"3.5";u.classList.toggle("default-param",u.value===I),e()};o.addEventListener("change",()=>{o.checked&&y("standard")}),s.addEventListener("change",()=>{s.checked&&y("hybrid")}),n.addEventListener("change",()=>{n.checked&&(t&&t("模式三 (BOT 模式) 正在升级中，暂不开放。","info",4e3),z==="standard"?o.checked=!0:z==="hybrid"?s.checked=!0:o.checked=!0)}),u.value=de,y("standard")}function ze(e){var d;const t=document.querySelectorAll('input[name="calcMode"]'),o=document.getElementById("calcModeAContainer"),s=document.getElementById("calcModeBContainer"),n=document.getElementById("calcModeCContainer"),a=(d=document.getElementById("operatingHours"))==null?void 0:d.parentElement;if(!o||!s||!n||!a||t.length===0){console.error("年加热量计算模式的 UI 元素未完全找到。");return}const c=()=>{const l=document.querySelector('input[name="calcMode"]:checked');if(!l)return;const m=l.value;m==="annual"?(o.classList.remove("hidden"),s.classList.add("hidden"),n.classList.add("hidden"),a.classList.remove("hidden")):m==="total"?(o.classList.add("hidden"),s.classList.remove("hidden"),n.classList.add("hidden")):m==="daily"&&(o.classList.remove("hidden"),s.classList.add("hidden"),n.classList.remove("hidden"),a.classList.add("hidden")),e()};t.forEach(l=>{l.addEventListener("change",c)}),c()}function Fe(e="",t="",o="",s,n){const a=document.getElementById("priceTiersContainer");if(!a){console.error("priceTiersContainer 未找到!");return}const c=`tier-${Date.now()}-${Math.floor(Math.random()*1e3)}`,d=document.createElement("div");d.className="price-tier-entry grid grid-cols-1 md:grid-cols-10 gap-2 items-center",d.id=c,d.innerHTML=`
        <div class="md:col-span-3">
            <label for="${c}-name" class="block text-xs font-medium text-gray-600 mb-1">时段名称 (可选)</label>
            <input type="text" id="${c}-name" value="${e}" placeholder="例如: 峰时" class="tier-name w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm track-change storage-mode-field">
        </div>
        <div class="md:col-span-3">
            <label for="${c}-price" class="block text-xs font-medium text-gray-600 mb-1">电价 (元/kWh)</label>
            <input type="number" id="${c}-price" value="${t}" placeholder="例如: 1.2" class="tier-price w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm track-change storage-mode-field" data-validation="isPositive">
            <div class="error-message hidden"></div>
        </div>
        <div class="md:col-span-3">
            <label for="${c}-dist" class="block text-xs font-medium text-gray-600 mb-1">运行比例 (%)</label>
            <input type="number" id="${c}-dist" value="${o}" placeholder="例如: 40" class="tier-dist w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm track-change storage-mode-field" data-validation="isPercentage">
            <div class="error-message hidden"></div>
        </div>
        <div class="md:col-span-1 flex items-end h-full">
            <button class="removePriceTierBtn w-full text-sm bg-red-100 text-red-700 font-semibold py-2 px-3 rounded-lg hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-300 mt-5 md:mt-0">
                删除
            </button>
        </div>
    `,a.appendChild(d),d.querySelectorAll("[data-validation]").forEach(l=>{l.addEventListener("input",()=>j(l)),l.addEventListener("blur",()=>j(l))}),d.querySelectorAll("input.track-change").forEach(l=>{l.dataset.defaultValue=l.value,l.addEventListener("input",m=>{const g=m.target,u=g.dataset.defaultValue;(g.classList.contains("default-param")||u!==void 0)&&g.classList.toggle("default-param",g.value===u),g.classList.contains("track-change")&&s()})}),d.querySelector(".removePriceTierBtn").addEventListener("click",()=>{document.querySelectorAll(".price-tier-entry").length>1?(d.remove(),s()):n?n("必须至少保留一个电价时段。","error"):alert("必须至少保留一个电价时段。")})}function Ge(e,t){const o=document.getElementById("addPriceTierBtn");o&&(o.addEventListener("click",()=>{Fe("","","",e,t),e()}),Fe("平均电价","0.7","100",e,t),document.querySelectorAll(".price-tier-entry").forEach(s=>{s.querySelectorAll("input").forEach(n=>{n.value&&n.classList.add("default-param")})}))}function Xe(){const e=document.getElementById("greenElectricityToggle"),t=document.getElementById("gridFactor"),o=document.getElementById("gridFactorUnit");!e||!t||!o||e.addEventListener("change",()=>{if(e.checked)t.value="0",t.dataset.baseValue="0",t.disabled=!0,o.disabled=!0,t.classList.remove("default-param");else{const s=t.getAttribute("data-base-value")||"0.57";t.dataset.baseValue=s,o.value="kgCO2/kWh",o.dispatchEvent(new Event("change")),t.disabled=!1,o.disabled=!1,t.classList.add("default-param"),t.dataset.defaultValue=t.value}})}function Qe(){const e=document.getElementById("fuelType");if(!e)return;const t=document.getElementById("fuelPrice"),o=document.getElementById("fuelCalorific"),s=document.getElementById("fuelFactor"),n=document.getElementById("fuelPriceTooltip"),a=document.getElementById("fuelCalorificTooltip"),c=document.getElementById("fuelFactorTooltip"),d=document.getElementById("fuelCalorificUnit"),l=document.getElementById("fuelFactorUnit");e.addEventListener("change",m=>{const g=m.target.value,u=Ne[g];u&&(t.dataset.baseValue=u.price,o.dataset.baseValue=u.calorific,s.dataset.baseValue=u.factor,t.value=u.price,t.dataset.defaultValue=u.price,t.classList.add("default-param"),n&&(n.innerHTML=u.priceTooltip),a&&(a.innerHTML=u.calorificTooltip),c&&(c.innerHTML=u.factorTooltip),d.value="MJ/kg",d.dispatchEvent(new Event("change")),o.dataset.defaultValue=o.value,o.classList.add("default-param"),l.value="kgCO2/t",l.dispatchEvent(new Event("change")),s.dataset.defaultValue=s.value,s.classList.add("default-param"))})}function Ze(e,t){Je(),Ye(),Xe(),Qe(),Ge(e,t),We(e,t),ze(e),je(t),document.querySelectorAll("[data-validation]").forEach(n=>{n.addEventListener("input",()=>j(n)),n.addEventListener("blur",()=>j(n))}),document.querySelectorAll('input[type="number"], input[type="checkbox"], select, input[type="text"], input[type="radio"]').forEach(n=>{let a;n.type==="checkbox"?a=n.checked:a=n.value,(n.id==="heatingLoad"||n.id==="annualHeating"||n.id.endsWith("Calorific")||n.id.endsWith("Factor"))&&n.dataset.baseValue===void 0&&(n.dataset.baseValue=n.value),n.dataset.defaultValue=a;const c=d=>{const l=d.target;let m=l.dataset.defaultValue,g=l.value;l.type==="checkbox"&&(g=l.checked,m=m==="true"),(l.classList.contains("default-param")||m!==void 0)&&l.classList.toggle("default-param",g===m);const u=document.getElementById(l.id+"Unit");if(u&&u.id.includes("Unit")){const i=parseFloat(l.value);if(isNaN(i)){const f=l.getAttribute("data-base-value");l.dataset.baseValue=f,l.classList.contains("track-change")&&e();return}const h=u.value,v=Pe.find(f=>f.inputId===l.id);if(!v)return;const r=(v.dynamicConversions?v.dynamicConversions():v.conversions)[h];if(i===0)l.dataset.baseValue=0;else if(r&&r!==0){const f=i/r;l.dataset.baseValue=f}}l.classList.contains("track-change")&&e()};n.tagName==="SELECT"||n.type==="checkbox"||n.type==="radio"?n.addEventListener("change",c):n.addEventListener("input",c)})}function Te(e,t){const o=[];let s=0;document.querySelectorAll(".price-tier-entry").forEach(b=>{const r=b.querySelector(".tier-name").value.trim()||"时段",f=parseFloat(b.querySelector(".tier-price").value)||0,y=parseFloat(b.querySelector(".tier-dist").value)||0;s+=y,o.push({name:r,price:f,dist:y})});const n=document.querySelector('input[name="schemeAMode"]:checked').value||"standard";if(n!=="bot"){if(Math.abs(s-100)>.1)return e(`电价时段总比例必须为 100%，当前为 ${s.toFixed(1)}%！`),null;if(o.some(b=>b.price<=0||b.dist<=0))return e("电价或运行比例必须大于 0！"),null}e(null);const a=document.querySelector('input[name="calcMode"]:checked'),c=a?a.value:"annual",d=parseFloat(document.getElementById("heatingLoad").dataset.baseValue)||0,l=parseFloat(document.getElementById("operatingHours").value)||0,m=parseFloat(document.getElementById("annualHeating").dataset.baseValue)||0,g=parseFloat(document.getElementById("dailyHours").value)||0,u=parseFloat(document.getElementById("annualDays").value)||0,i=(parseFloat(document.getElementById("loadFactor").value)||0)/100;let h=0;c==="annual"?h=d*l:c==="total"?h=m:c==="daily"&&(h=d*g*u*i);const v={analysisMode:n,isHybridMode:n==="hybrid",lccYears:parseInt(document.getElementById("lccYears").value)||15,discountRate:(parseFloat(document.getElementById("discountRate").value)||8)/100,energyInflationRate:(parseFloat(document.getElementById("energyInflationRate").value)||3)/100,opexInflationRate:(parseFloat(document.getElementById("opexInflationRate").value)||5)/100,isGreenElectricity:document.getElementById("greenElectricityToggle").checked,priceTiers:o,projectName:document.getElementById("projectName").value,heatingLoad:d,operatingHours:l,annualHeating:m,dailyHours:g,annualDays:u,loadFactor:i,annualHeatingDemandKWh:h,hpHostCapex:parseFloat(document.getElementById("hpCapex").value)*1e4||0,hpStorageCapex:parseFloat(document.getElementById("storageCapex").value)*1e4||0,hpSalvageRate:(parseFloat(document.getElementById("hpSalvageRate").value)||0)/100,gasBoilerCapex:parseFloat(document.getElementById("gasBoilerCapex").value)*1e4||0,gasSalvageRate:(parseFloat(document.getElementById("gasSalvageRate").value)||0)/100,fuelBoilerCapex:parseFloat(document.getElementById("fuelBoilerCapex").value)*1e4||0,fuelSalvageRate:(parseFloat(document.getElementById("fuelSalvageRate").value)||0)/100,coalBoilerCapex:parseFloat(document.getElementById("coalBoilerCapex").value)*1e4||0,coalSalvageRate:(parseFloat(document.getElementById("coalSalvageRate").value)||0)/100,biomassBoilerCapex:parseFloat(document.getElementById("biomassBoilerCapex").value)*1e4||0,biomassSalvageRate:(parseFloat(document.getElementById("biomassSalvageRate").value)||0)/100,electricBoilerCapex:parseFloat(document.getElementById("electricBoilerCapex").value)*1e4||0,electricSalvageRate:(parseFloat(document.getElementById("electricSalvageRate").value)||0)/100,steamCapex:parseFloat(document.getElementById("steamCapex").value)*1e4||0,steamSalvageRate:parseFloat(document.getElementById("steamSalvageRate").value)/100||0,hpCop:parseFloat(document.getElementById("hpCop").value)||0,gasBoilerEfficiency:parseFloat(document.getElementById("gasBoilerEfficiency").value)/100||0,fuelBoilerEfficiency:parseFloat(document.getElementById("fuelBoilerEfficiency").value)/100||0,coalBoilerEfficiency:parseFloat(document.getElementById("coalBoilerEfficiency").value)/100||0,biomassBoilerEfficiency:parseFloat(document.getElementById("biomassBoilerEfficiency").value)/100||0,electricBoilerEfficiency:parseFloat(document.getElementById("electricBoilerEfficiency").value)/100||0,steamEfficiency:parseFloat(document.getElementById("steamEfficiency").value)/100||0,gasPrice:parseFloat(document.getElementById("gasPrice").value)||0,fuelPrice:parseFloat(document.getElementById("fuelPrice").value)||0,coalPrice:parseFloat(document.getElementById("coalPrice").value)||0,biomassPrice:parseFloat(document.getElementById("biomassPrice").value)||0,steamPrice:parseFloat(document.getElementById("steamPrice").value)||0,gridFactor:document.getElementById("greenElectricityToggle").checked?0:parseFloat(document.getElementById("gridFactor").dataset.baseValue)||0,gasFactor:parseFloat(document.getElementById("gasFactor").dataset.baseValue)||0,fuelFactor:parseFloat(document.getElementById("fuelFactor").dataset.baseValue)||0,coalFactor:parseFloat(document.getElementById("coalFactor").dataset.baseValue)||0,biomassFactor:parseFloat(document.getElementById("biomassFactor").dataset.baseValue),steamFactor:parseFloat(document.getElementById("steamFactor").dataset.baseValue)||0,gasCalorific:parseFloat(document.getElementById("gasCalorific").dataset.baseValue)||0,fuelCalorific:parseFloat(document.getElementById("fuelCalorific").dataset.baseValue)||0,coalCalorific:parseFloat(document.getElementById("coalCalorific").dataset.baseValue)||0,biomassCalorific:parseFloat(document.getElementById("biomassCalorific").dataset.baseValue)||0,steamCalorific:parseFloat(document.getElementById("steamCalorific").dataset.baseValue)||0,hpOpexCost:(parseFloat(document.getElementById("hpOpexCost").value)||0)*1e4,gasOpexCost:(parseFloat(document.getElementById("gasOpexCost").value)||0)*1e4,fuelOpexCost:(parseFloat(document.getElementById("fuelOpexCost").value)||0)*1e4,coalOpexCost:(parseFloat(document.getElementById("coalOpexCost").value)||0)*1e4,biomassOpexCost:(parseFloat(document.getElementById("biomassOpexCost").value)||0)*1e4,electricOpexCost:(parseFloat(document.getElementById("electricOpexCost").value)||0)*1e4,steamOpexCost:(parseFloat(document.getElementById("steamOpexCost").value)||0)*1e4,hybridLoadShare:(parseFloat(document.getElementById("hybridLoadShare").value)||0)/100,hybridAuxHeaterType:document.getElementById("hybridAuxHeaterType").value,hybridAuxHeaterCapex:(parseFloat(document.getElementById("hybridAuxHeaterCapex").value)||0)*1e4,hybridAuxHeaterOpex:(parseFloat(document.getElementById("hybridAuxHeaterOpex").value)||0)*1e4,botAnnualRevenue:(parseFloat(document.getElementById("botAnnualRevenue").value)||0)*1e4,botAnnualEnergyCost:(parseFloat(document.getElementById("botAnnualEnergyCost").value)||0)*1e4,botAnnualOpexCost:(parseFloat(document.getElementById("botAnnualOpexCost").value)||0)*1e4,botEquityRatio:(parseFloat(document.getElementById("botEquityRatio").value)||0)/100,botLoanInterestRate:(parseFloat(document.getElementById("botLoanInterestRate").value)||0)/100,botDepreciationYears:parseInt(document.getElementById("botDepreciationYears").value)||10,botVatRate:(parseFloat(document.getElementById("botVatRate").value)||0)/100,botSurtaxRate:(parseFloat(document.getElementById("botSurtaxRate").value)||0)/100,botIncomeTaxRate:(parseFloat(document.getElementById("botIncomeTaxRate").value)||0)/100,compare:{gas:document.getElementById("compare_gas").checked,fuel:document.getElementById("compare_fuel").checked,coal:document.getElementById("compare_coal").checked,biomass:document.getElementById("compare_biomass").checked,electric:document.getElementById("compare_electric").checked,steam:document.getElementById("compare_steam").checked}};if(n!=="bot"){if(h<=0||!v.hpCop)return t?t("成本对比模式: 请确保最终的“年总加热量”大于 0，并已填写工业热泵SPF。","error"):alert("成本对比模式: 请确保最终的“年总加热量”大于 0，并已填写工业热泵SPF。"),null}else if(v.botAnnualRevenue===0||v.botAnnualEnergyCost===0)return t?t("BOT模式: “年销售收入”和“年能源成本”必须大于0。","error"):alert("BOT模式: “年销售收入”和“年能源成本”必须大于0。"),null;return v}function G(e,t,o,s){let n=0;for(let a=1;a<=t;a++){const d=e*Math.pow(1+s,a-1)/Math.pow(1+o,a);n+=d}return n}function X(e,t){let o=0;for(let s=0;s<e.length;s++)o+=e[s]/Math.pow(1+t,s);return o}function ge(e,t=100,o=1e-6){if(e.length===0||e[0]>=0){const m=e.slice(1).reduce((g,u)=>g+u,0);return e[0]<0||m>0?1/0:null}let s=-.99,n=5,a,c;const d=X(e,0),l=X(e,n);if(d<0)l<d&&(n=0);else if(l>0&&(s=n,n=20,X(e,n)>0))return 1/0;for(let m=0;m<t;m++){if(a=(s+n)/2,c=X(e,a),Math.abs(c)<o)return a;c>0?s=a:n=a}return null}function fe(e,t,o){const s=-e[0];if(s<=0)return 0;let n=0;for(let a=1;a<=o&&!(a>=e.length);a++){const c=e[a]/Math.pow(1+t,a);if(!(c<=0&&n<s)&&n<s){const d=n;if(n+=c,n>=s){const l=s-d;if(c===0){if(l===0)return a-1;continue}return a-1+l/c}}}return null}const F=e=>(e/1e4).toFixed(2),ne=e=>(e/1e3).toFixed(2),$=(e,t=1)=>e===null||!isFinite(e)?"N/A":`${(e*100).toFixed(t)} %`,ye=e=>e===null||!isFinite(e)?"无法回收":`${e.toFixed(2)} 年`,H=(e,t=1)=>e===null||!isFinite(e)||e===0?"N/A":e.toLocaleString(void 0,{minimumFractionDigits:t,maximumFractionDigits:t}),Ke=e=>e.toLocaleString(void 0,{maximumFractionDigits:0}),be=e=>e.toLocaleString(void 0,{maximumFractionDigits:0});function Oe(e){var t,o;(t=document.getElementById("stale-results-notice"))==null||t.classList.toggle("hidden",!e),(o=document.getElementById("results-container"))==null||o.classList.toggle("opacity-50",e)}function xe(e){var t,o;(t=document.getElementById("results-placeholder"))==null||t.classList.toggle("hidden",e),(o=document.getElementById("results-content"))==null||o.classList.toggle("hidden",!e)}function $e(){xe(!1);const e=document.getElementById("results-content");e&&(e.innerHTML="")}function Se(e,t="results-content"){const o=document.getElementById(t);o&&e&&(o.innerHTML=`<div class="p-4 text-center text-red-600 bg-red-50 rounded-lg">${e}</div>`,xe(!0))}function et(e){var o,s,n;xe(!0);const{analysisMode:t}=e;t==="bot"?tt():at(e),(o=document.getElementById("toggle-details-btn"))==null||o.addEventListener("click",a=>{document.getElementById("calculation-details").classList.toggle("hidden"),a.target.textContent=a.target.textContent.includes("显示")?"隐藏详细计算过程":"显示详细计算过程 (含公式)"}),(s=document.getElementById("toggle-risk-btn"))==null||s.addEventListener("click",a=>{document.getElementById("risk-analysis-details").classList.toggle("hidden"),a.target.textContent=a.target.textContent.includes("显示")?"隐藏投资风险及对策分析":"显示投资风险及对策分析"}),(n=document.getElementById("printReportBtn"))==null||n.addEventListener("click",()=>{st(e),window.print()}),ot(e),nt(t)}function tt(e){const t=document.getElementById("results-content");t&&(t.innerHTML='<div class="p-6">BOT 模式结果渲染区</div>')}function at(e){const{lccParams:t,comparisons:o}=e,s=e.isHybridMode?e.hybridSystem:e.hp,n=t.lccYears,a=t.discountRate,c=document.getElementById("results-content");if(!c)return;const d=document.getElementById("results-title");d&&(d.textContent=`静态、ROI 与 LCC (${n}年) 对比分析结果`);const l=s.isHybrid||!1,m=l?"混合系统年运行成本 (第1年)":"工业热泵系统年运行成本 (第1年)",g=l?`混合系统 LCC (${n}年)`:`工业热泵系统 LCC (${n}年)`;let u=`
        <div class="space-y-6">
            <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
                <h3 class="font-semibold text-lg text-blue-800 mb-2">${m}</h3>
                <div class="flex flex-col sm:flex-row justify-between sm:items-baseline sm:gap-4">
                    <div>
                        <p class="text-xs text-blue-700">年总运行成本</p>
                        <p class="text-3xl font-bold text-blue-600">${F(s.opex)} 万元</p>
                    </div>
                    <div class="sm:text-right mt-2 sm:mt-0">
                        <p class="text-xs text-blue-700">折算吨蒸汽电耗</p>
                        <p class="text-xl font-semibold text-blue-600">${H(s.electricity_per_steam_ton,1)} kWh/t</p>
                    </div>
                    <div class="sm:text-right mt-2 sm:mt-0">
                        <p class="text-xs text-blue-700">折算吨蒸汽单价</p>
                        <p class="text-xl font-semibold text-blue-600">${be(s.cost_per_steam_ton)} 元/t</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-blue-100 border-l-4 border-blue-600 p-6 rounded-lg">
                <h3 class="font-semibold text-lg text-blue-900">
                    ${g}
                </h3>
                <p class="text-xs text-blue-700 mb-1">LCC = 初始投资 + (未来${n}年所有运营成本 - ${n}年后残值)</p>
                <p class="text-3xl font-bold text-blue-700">${F(s.lcc.total)} 万元</p>
            </div>
        </div>
    `;o.forEach(r=>{const f=r.npv>0?"text-green-600":"text-red-600",y=r.irr>a?"text-green-600":r.irr===null||!isFinite(r.irr)?"text-gray-500":"text-red-600",x=r.dynamicPBP!==null?"text-blue-600":"text-red-600",p=r.opexSaving>0?"text-green-600":"text-red-600",I=r.energyCostSaving>0?"text-green-600":"text-red-600",C=r.simpleROI!==null?"text-green-600":"text-gray-500";u+=`
        <div class="bg-gray-50 p-6 rounded-lg border mt-8 space-y-4">
            <h4 class="text-xl font-bold text-gray-800 border-b pb-3">与 <span class="text-blue-600">${r.name}</span> 对比</h4>
            
            <div class="space-y-2">
                <h5 class="font-semibold text-blue-800 text-md">视角: 投资回报率 (ROI)</h5>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">简单投资回报率 (ROI)</span>
                    <span class="font-bold text-lg ${C}">${$(r.simpleROI)}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">净现值 (NPV)</span>
                    <span class="font-bold text-lg ${f}">${F(r.npv)} 万元</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">内部收益率 (IRR)</span>
                    <span class="font-bold text-lg ${y}">${$(r.irr)}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2">
                    <span class="text-gray-600">动态回收期 (PBP)</span>
                    <span class="font-bold text-lg ${x}">${ye(r.dynamicPBP)}</span>
                </div>
            </div>

            <div class="space-y-2 pt-4 border-t">
                <h5 class="font-semibold text-gray-800 text-md">视角: 静态 (第1年) 与 环境</h5>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">电热价格比 (EPR)</span>
                    <span class="font-bold text-lg ${r.electricalPriceRatio>1?"text-green-600":"text-red-600"}">${r.electricalPriceRatio?r.electricalPriceRatio.toFixed(2):"N/A"}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">年节省能源费:</span>
                    <span class="font-semibold ${I}">${F(r.energyCostSaving)} 万元</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">能源费节能率:</span>
                    <span class="font-semibold ${I}">${$(r.energyCostSavingRate)}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">年节省总成本 (含运维):</span>
                    <span class="font-semibold ${p}">${F(r.opexSaving)} 万元</span>
                </div>
                 <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">静态回报期 (总成本):</span>
                    <span class="font-semibold">${r.paybackPeriod}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">基准年能源消耗:</span>
                    <span class="font-semibold text-gray-700">${H(r.consumption,2)} ${r.consumptionUnit}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2">
                    <span class="text-gray-600">年碳减排量:</span>
                    <span class="font-semibold text-green-600">${ne(r.co2Reduction)} 吨 CO₂</span>
                </div>
            </div>

             <div class="space-y-2 pt-4 border-t">
                <h5 class="font-semibold text-gray-800 text-md">视角: 全生命周期成本 (LCC)</h5>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">${l?"混合系统":"工业热泵"} LCC:</span>
                    <span class="font-semibold text-blue-700">${F(s.lcc.total)} 万元</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2">
                    <span class="text-gray-600">${r.name} LCC:</span>
                    <span class="font-semibold text-gray-700">${F(r.lcc)} 万元</span>
                </div>
            </div>
        </div>
        `});let i=`
        <div class="bg-indigo-50 border-l-4 border-indigo-500 p-6 rounded-lg space-y-3 mt-8">
            <h4 class="text-xl font-bold text-indigo-800 border-b pb-2">综合结论 (基于 ${n} 年分析)</h4>
    `;const h=o.filter(r=>r.irr>a&&isFinite(r.irr));if(h.length>0){const r=h.reduce((f,y)=>f.irr>y.irr?f:y);i+=`<p class="text-sm text-gray-700"><b>投资回报 (ROI) 结论：</b>项目可行。相较于 <b>${h.map(f=>f.name).join("、")}</b>，IRR 高于基准收益率(${$(a)})。回报最佳的是替代 <b>${r.name}</b>，IRR 高达 <b>${$(r.irr)}</b>，动态回收期 <b>${ye(r.dynamicPBP)}</b>。</p>`}else{const r=o.length>0?o.reduce((f,y)=>f.npv>y.npv?f:y):null;r&&r.npv>0?i+=`<p class="text-sm text-gray-700"><b>投资回报 (ROI) 结论：</b>项目勉强可行。相较于 <b>${r.name}</b>，项目净现值(NPV)为正 (<b>${F(r.npv)} 万元</b>)，但所有方案 IRR 均未超过基准收益率(${$(a)})。</p>`:i+=`<p class="text-sm text-red-700"><b>投资回报 (ROI) 结论：</b>项目不可行。相较于所有对比方案，项目的 IRR 均低于基准收益率(${$(a)})，且 NPV 均为负。</p>`}const v=o.filter(r=>r.co2Reduction>0);if(v.length>0){const r=v.reduce((f,y)=>f.co2Reduction>y.co2Reduction?f:y);i+=`<p class="text-sm text-gray-700"><b>环境效益 (年)：</b>替代 <b>${r.name}</b> 的环境效益最为显著，年碳减排量可达 <b>${ne(r.co2Reduction)}</b> 吨CO₂，相当于植树约 <b>${Ke(r.treesPlanted)}</b> 棵。</p>`}else o.length>0&&(i+=`<p class="text-sm text-gray-700"><b>环境效益 (年)：</b>根据当前参数，${l?"混合":"工业热泵"}方案相较于所选对比方案均无碳减排优势。</p>`);i+="</div>",u+=i,u+=`
        <div class="mt-8 space-y-2">
            <button id="toggle-details-btn" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">显示详细计算过程 (含公式)</button>
            <div id="calculation-details" class="hidden bg-white rounded-lg border text-sm space-y-4 mt-2"></div>
            
            <button id="toggle-risk-btn" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">显示投资风险及对策分析</button>
            <div id="risk-analysis-details" class="hidden bg-white rounded-lg border text-sm space-y-4 mt-2"></div>
            
            <button id="printReportBtn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition mt-4">打印本页报告 (A4)</button>
        </div>
    `,c.innerHTML=u}function ot(e){console.log("--- [Debug] 正在渲染详细过程，收到的 results 对象是: ---",e),document.getElementById("calculation-details")&&(e.analysisMode==="bot"?lt():ct(e))}function nt(e){const t=document.getElementById("risk-analysis-details");if(!t)return;let o='<div class="p-6 space-y-4">';e==="bot"?o+=`
            <h3 class="text-lg font-bold border-b pb-2 mb-4">BOT 模式投资风险及对策分析</h3>
            <h4 class="font-semibold text-gray-800">1. 财务与市场风险</h4>
            <ul class="list-disc list-inside text-sm space-y-2">
                <li><b>风险 (收入不及预期):</b> 客户用热量未达标，或能源销售单价（热价）低于预期，导致年销售收入无法实现。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 签订“照付不议”合同:</b> 与客户约定最低用热量，未达到也需按约定付费。<b>(2) 价格联动:</b> 合同中应包含能源价格（电价）与销售热价的联动条款。</li>
                <li><b>风险 (成本失控):</b> 能源价格（电价、天然气等）涨幅超过预期，或设备能效未达标导致能耗过高。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 成本锁定:</b> 尽可能签订长期能源供应合同。<b>(2) 敏感性分析:</b> 测算能源成本上涨对项目TIRR和EIRR的影响。</li>
            </ul>
        `:o+=`
            <h3 class="text-lg font-bold border-b pb-2 mb-4">工业热泵投资风险及对策分析 (成本对比)</h3>
            <h4 class="font-semibold text-gray-800">1. 政策与市场风险</h4>
            <ul class="list-disc list-inside text-sm space-y-2">
                <li><b>风险 (电价波动):</b> "峰谷尖"电价政策调整，尤其是谷电价格上涨或峰电涨幅不及预期，可能导致运行成本高于预期。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 精确评估:</b> 采用加权平均电价或分时电价模型进行精确测算。<b>(2) 敏感性分析:</b> 测算电价上涨对IRR和PBP的影响。<b>(3) 绿电合约:</b> 探索与发电企业签订长期购电协议 (PPA)。</li>
            </ul>
            <h4 class="font-semibold text-gray-800 mt-4">2. 技术与运行风险</h4>
            <ul class="list-disc list-inside text-sm space-y-2">
                <li><b>风险 (性能衰减/SPF不达标):</b> 全年综合能效系数(SPF)低于设计值，导致实际运行电耗过高。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 选型匹配:</b> 基于项目地最冷月平均工况进行主机选型。<b>(2) 耦合设计:</b> 采用“工业热泵 + 辅助热源”的耦合方案。<b>(3) 明确SPF:</b> 明确SPF的计算边界。</li>
            </ul>
            <h4 class="font-semibold text-gray-800 mt-4">3. 财务与LCC风险</h4>
            <ul class="list-disc list-inside text-sm space-y-2">
                 <li><b>风险 (LCC估算偏差):</b> 仅对比“第1年运行成本”，忽略了初始投资(CAPEX)和未来成本。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 采用LCC:</b> 坚持使用 LCC 作为决策依据。<b>(2) 考虑通胀:</b> 必须设置合理的“能源价格涨幅”和“运维成本涨幅”。</li>
            </ul>
        `,o+="</div>",t.innerHTML=o}function st(e){const t=document.getElementById("print-report-container");if(!t)return;const{inputs:o,lccParams:s,comparisons:n,hp:a,isHybridMode:c,hybridSystem:d}=e,l=o.projectName||"未命名项目",m=new Date().toLocaleString("zh-CN");let g=`
        <div class="print-header">
            <h2>${l} 项目</h2>
            <h1>工业热泵经济与环境效益分析报告</h1>
            <p>报告日期: ${m}</p>
        </div>
        <div class="print-section">
            <h3>1. 核心输入参数</h3>
            <table class="print-table">
                <tr><td>项目名称</td><td>${l}</td></tr>
                <tr><td>年总制热量</td><td class="text-right">${H(o.annualHeatingDemandKWh,0)} kWh</td></tr>
                <tr><td>经济分析年限</td><td class="text-right">${s.lccYears} 年</td></tr>
                <tr><td>基准折现率</td><td class="text-right">${$(s.discountRate,1)}</td></tr>
            </table>
        </div>
        <div class="print-section">
            <h3>2. 方案静态对比 (第1年)</h3>
            <table class="print-table">
                <thead><tr><th>方案名称</th><th class="text-right">总投资(万)</th><th class="text-right">年运行成本(万)</th></tr></thead>
                <tbody>
                    <tr>
                        <td><strong>${c?d.name:"工业热泵方案"}</strong></td>
                        <td class="text-right"><strong>${F(c?d.lcc.capex:a.lcc.capex)}</strong></td>
                        <td class="text-right"><strong>${F(c?d.opex:a.opex)}</strong></td>
                    </tr>
    `;n.forEach(u=>{const i=e[u.key];g+=`<tr><td>${u.name}</td><td class="text-right">${F(i.lcc.capex)}</td><td class="text-right">${F(i.opex)}</td></tr>`}),g+=`
                </tbody>
            </table>
        </div>
        <div class="print-section">
            <h3>3. 核心经济与环境效益</h3>
            <table class="print-table">
                <thead><tr><th>对比项</th><th class="text-right">IRR</th><th class="text-right">动态PBP (年)</th><th class="text-right">年碳减排 (tCO₂)</th></tr></thead>
                <tbody>
    `,n.forEach(u=>{g+=`<tr><td>vs. ${u.name}</td><td class="text-right">${$(u.irr)}</td><td class="text-right">${ye(u.dynamicPBP)}</td><td class="text-right">${ne(u.co2Reduction)}</td></tr>`}),g+=`
                </tbody>
            </table>
        </div>
        <div class="print-footer"><p>报告由工业热泵经济与环境效益分析器 Pro 生成。</p></div>
    `,t.innerHTML=g}function lt(e){const t=document.getElementById("calculation-details");t&&(t.innerHTML='<p class="p-4">BOT 模式的详细计算过程功能待添加。</p>')}function ct(e){const t=document.getElementById("calculation-details");if(!t)return;const{isHybridMode:o,lccParams:s,hp:n,comparisons:a,inputs:c,hybridSystem:d,hybrid_aux:l}=e,m=o?d:n,{annualHeatingDemandKWh:g,weightedAvgElecPrice:u}=c;c.isGreenElectricity||c.gridFactor,c.isGreenElectricity;let i='<div class="p-4 md:p-6 space-y-6 text-xs">';if(i+=`
        <div>
            <h3 class="text-base font-bold border-b pb-2 mb-2">A. 核心经济指标计算方法与依据</h3>
            <div class="space-y-1 text-gray-600">
                <p><b>全寿命周期成本 (LCC):</b> LCC = CAPEX + NPV(Energy) + NPV(O&M) - NPV(Salvage)。</p>
                <p><b>净现值 (NPV):</b> NPV = (LCC_基准 - LCC_工业热泵)。NPV > 0 代表项目可行。</p>
                <p><b>内部收益率 (IRR):</b> 使项目净现值(NPV)等于零时的折现率。IRR > 基准折现率，代表项目优秀。</p>
            </div>
        </div>
    `,o){const h=(c.hybridLoadShare*100).toFixed(1),v=(100-parseFloat(h)).toFixed(1);i+=`
            <div>
                <h3 class="text-base font-bold border-b pb-2 mb-2">B. 本次项目详细计算过程 (混合模式)</h3>
                <p><b>年总制热量:</b> ${H(g,0)} kWh</p>
                <div class="mt-2 p-3 bg-blue-50 rounded-md space-y-1">
                    <h4 class="font-semibold text-blue-800">方案A: 混合系统 (总计)</h4>
                    <p>• 年总运行成本 (第1年): ${F(d.opex)} 万元</p>
                    <p>• 年总碳排放量: ${ne(d.co2)} 吨 CO₂</p>
                    <p>• 产热成本: ${d.cost_per_kwh_heat.toFixed(4)} 元/kWh_热</p>
                </div>
                <div class="mt-2 p-3 bg-gray-50 rounded-md space-y-1">
                    <h4 class="font-semibold text-gray-700">混合系统 - 工业热泵部分 (${h}%)</h4>
                    <p>• 年能源成本: ${be(n.energyCost)} 元</p>
                </div>
                <div class="mt-2 p-3 bg-gray-50 rounded-md space-y-1">
                    <h4 class="font-semibold text-gray-700">混合系统 - 辅助热源 (${l.name}, ${v}%)</h4>
                    <p>• 年能源消耗: ${H(l.consumption)} ${l.consumptionUnit}</p>
                    <p>• 年能源成本: ${be(l.energyCost)} 元</p>
                </div>
            </div>
        `}else i+=`
            <div>
                <h3 class="text-base font-bold border-b pb-2 mb-2">B. 本次项目详细计算过程 (标准模式)</h3>
                 <p><b>年总制热量:</b> ${H(g,0)} kWh</p>
                 <div class="mt-2 p-3 bg-blue-50 rounded-md space-y-1">
                    <h4 class="font-semibold text-blue-800">方案A: 工业热泵</h4>
                    
                    <p>• 年总电耗: ${H(m.consumption,0)} kWh</p>
                    
                    <p>• 年总运行成本: ${F(n.opex)} 万元</p>
                    <p>• 产热成本: ${n.cost_per_kwh_heat.toFixed(4)} 元/kWh_热</p>
                    <p>• 年碳排放量: ${ne(n.co2)} 吨 CO₂</p>
                </div>
            </div>
        `;i+='<div class="space-y-4">',a.forEach(h=>{const v=e[h.key];i+=`
            <div class="pt-4 border-t">
                <h4 class="font-semibold text-gray-800">对比: ${o?d.name:"工业热泵"} vs ${h.name}</h4>
                <div class="text-gray-600 space-y-1 mt-1">
                    <p>• <b>基准 (${h.name}) 年消耗:</b> ${H(v.consumption,1)} ${v.consumptionUnit}</p>
                    <p>• <b>基准 (${h.name}) 年运行成本:</b> ${F(v.opex)} 万元</p>
                    <p class="font-semibold text-green-700">↳ 年节省总成本: ${F(h.opexSaving)} 万元</p>
                    <p class="font-semibold text-blue-800">↳ LCC 节省 (NPV): ${F(h.npv)} 万元</p>
                    <p class="font-semibold text-blue-800">↳ 内部收益率 (IRR): ${$(h.irr)}</p>
                </div>
            </div>
        `}),i+="</div></div>",t.innerHTML=i}function it(e){console.warn("Placeholder function: initializeScenarioComparison called.")}function rt(e,t){console.warn("Placeholder function: updateScenarioComparisonUI called.")}function dt(e){const{analysisMode:t}=e,o={lccYears:e.lccYears,discountRate:e.discountRate,energyInflationRate:e.energyInflationRate,opexInflationRate:e.opexInflationRate},{annualHeatingDemandKWh:s}=e;if(t==="bot")return ut(e,o,e.botAnnualEnergyCost,e.botAnnualOpexCost);{const n=e.hpCop>0?s/e.hpCop:0;let a=0;const c={tiers:[]};e.priceTiers.forEach(l=>{const m=l.dist/100,g=n*m,u=g*l.price;a+=u,c.tiers.push({name:l.name,elec:g,price:l.price,cost:u})});let d=0;if(n>0)d=a/n;else if(e.priceTiers.length>0){let l=0;e.priceTiers.forEach(m=>{d+=m.price*m.dist,l+=m.dist}),l>0?d=d/l:e.priceTiers.length===1&&(d=e.priceTiers[0].price)}return mt(e,o,d,a,c,s,t,n)}}function ut(e,t,o,s){const{lccYears:n,discountRate:a,energyInflationRate:c,opexInflationRate:d}=t,l=e.hpHostCapex+e.hpStorageCapex,m=l*e.botEquityRatio,g=l-m,u=l*e.hpSalvageRate,i={years:[],revenue:[],vat:[],revenueNetVat:[],surtax:[],energyCost:[],opexCost:[],depreciation:[],interest:[],totalCost:[],profitBeforeTax:[],incomeTax:[],netProfit:[],cf_TotalInvestment:[],cf_Equity:[]},h=e.botDepreciationYears>0?g/e.botDepreciationYears:0;for(let p=1;p<=n;p++){i.years.push(p);const I=e.botAnnualRevenue,C=I/(1+e.botVatRate),_=I-C,B=_*e.botSurtaxRate,R=o*Math.pow(1+c,p-1),S=s*Math.pow(1+d,p-1),k=p<=e.botDepreciationYears?l*(1-e.hpSalvageRate)/e.botDepreciationYears:0;let V=0;p<=e.botDepreciationYears&&(V=(g-h*(p-1))*e.botLoanInterestRate);const J=R+S+k+V+B,M=C-J,w=Math.max(0,M)*e.botIncomeTaxRate,O=M-w;i.revenue.push(I),i.vat.push(_),i.revenueNetVat.push(C),i.surtax.push(B),i.energyCost.push(R),i.opexCost.push(S),i.depreciation.push(k),i.interest.push(V),i.totalCost.push(J),i.profitBeforeTax.push(M),i.incomeTax.push(w),i.netProfit.push(O);let Y=(M+V)*(1-e.botIncomeTaxRate)+k,E=p<=e.botDepreciationYears?h:0,L=O+k-E;p===n&&(Y+=u,L+=u),i.cf_TotalInvestment.push(Y),i.cf_Equity.push(L)}const v=[-l,...i.cf_TotalInvestment],b=[-m,...i.cf_Equity],r={investment:l/1e4,equity:m/1e4,loan:g/1e4,irr:ge(v),npv:X(v,a)/1e4,pbp:fe(v,a,n),equityIRR:ge(b),equityNPV:X(b,a)/1e4,equityPBP:fe(b,a,n)},f=p=>p.reduce((I,C)=>I+C,0),y=p=>p.length>0?f(p)/p.length/1e4:0,x={revenue:y(i.revenue),vat:y(i.vat),revenueNetVat:y(i.revenueNetVat),surtax:y(i.surtax),energyCost:y(i.energyCost),opexCost:y(i.opexCost),depreciation:y(i.depreciation),interest:y(i.interest),totalCost:y(i.totalCost),profitBeforeTax:y(i.profitBeforeTax),incomeTax:y(i.incomeTax),netProfit:y(i.netProfit)};return{analysisMode:"bot",inputs:e,lccParams:t,botAnalysis:{summary:r,annualAvg:x,cashFlows:i}}}function mt(e,t,o,s,n,a,c,d){const l={},{lccYears:m,discountRate:g,energyInflationRate:u,opexInflationRate:i,priceTiers:h,isHybridMode:v,gridFactor:b}=e;l.inputs=e,l.lccParams=t,l.isHybridMode=v,l.annualHeatingDemandKWh=a,l.weightedAvgElecPrice=o;const r=700;let f;const y=e.hpHostCapex+e.hpStorageCapex;if(v){const{hybridLoadShare:p,hybridAuxHeaterType:I,hybridAuxHeaterCapex:C,hybridAuxHeaterOpex:_}=e;l.hybridInputs={hybridLoadShare:p,hybridAuxHeaterType:I,hybridAuxHeaterCapex:C,hybridAuxHeaterOpex:_};const B=a*p,R=a*(1-p),S=e.hpCop>0?B/e.hpCop:0;let k=0;const V={tiers:[]};h.forEach(W=>{const ie=W.dist/100,Ce=S*ie,Ee=Ce*W.price;k+=Ee,V.tiers.push({name:W.name,elec:Ce,price:W.price,cost:Ee})});const J=k+e.hpOpexCost,M=S*b,w=G(k,m,g,u),O=G(e.hpOpexCost,m,g,i),K=y*e.hpSalvageRate,ee=K/Math.pow(1+g,m),Y=y+w+O-ee,E={isHybridPart:!0,name:"工业热泵 (混合)",energyCost:k,energyCostDetails:V,opexCost:e.hpOpexCost,opex:J,co2:M,lcc:{capex:y,capex_host:e.hpHostCapex,capex_storage:e.hpStorageCapex,energyNPV:w,opexNPV:O,salvageRate:e.hpSalvageRate,salvageNPV:ee,salvageValue:K,total:Y}};l.hp=E;const L=q(I,R,C,_,t,e,b,o);l.hybrid_aux=L;const D=a>0?a/r:0,se={isHybrid:!0,name:"混合系统 (工业热泵 + "+L.name+")",energyCost:E.energyCost+L.energyCost,opexCost:E.opexCost+L.opexCost,opex:E.opex+L.opex,co2:E.co2+L.co2,cost_per_kwh_heat:a>0?(E.energyCost+L.energyCost)/a:0,electricity_per_steam_ton:D>0?S/D:0,cost_per_steam_ton:D>0?(E.energyCost+L.energyCost)/D:0,lcc:{capex:E.lcc.capex+L.lcc.capex,energyNPV:E.lcc.energyNPV+L.lcc.energyNPV,opexNPV:E.lcc.opexNPV+L.lcc.opexNPV,salvageNPV:E.lcc.salvageNPV+L.lcc.salvageNPV,salvageValue:E.lcc.salvageValue+L.lcc.salvageValue,total:E.lcc.total+L.lcc.total}};l.hybridSystem=se,f=se}else{const p=s+e.hpOpexCost,I=d*b,C=G(s,m,g,u),_=G(e.hpOpexCost,m,g,i),B=y*e.hpSalvageRate,R=B/Math.pow(1+g,m),S=y+C+_-R,k=a>0?a/r:0,V={isHybrid:!1,name:"工业热泵系统",consumption:d,consumptionUnit:"kWh",energyCost:s,energyCostDetails:n,opexCost:e.hpOpexCost,opex:p,co2:I,cost_per_kwh_heat:e.hpCop>0?o/e.hpCop:0,electricity_per_steam_ton:k>0?d/k:0,cost_per_steam_ton:k>0?s/k:0,lcc:{capex:y,capex_host:e.hpHostCapex,capex_storage:e.hpStorageCapex,energyNPV:C,opexNPV:_,salvageRate:e.hpSalvageRate,salvageNPV:R,salvageValue:B,total:S}};l.hp=V,f=V}const x=[];return e.compare.gas&&x.push(q("gas",a,e.gasBoilerCapex,e.gasOpexCost,t,e,b,o)),e.compare.fuel&&x.push(q("fuel",a,e.fuelBoilerCapex,e.fuelOpexCost,t,e,b,o)),e.compare.coal&&x.push(q("coal",a,e.coalBoilerCapex,e.coalOpexCost,t,e,b,o)),e.compare.biomass&&x.push(q("biomass",a,e.biomassBoilerCapex,e.biomassOpexCost,t,e,b,o)),e.compare.electric&&x.push(q("electric",a,e.electricBoilerCapex,e.electricOpexCost,t,e,b,o)),e.compare.steam&&x.push(q("steam",a,e.steamCapex,e.steamOpexCost,t,e,b,o)),x.forEach(p=>{l[p.key]=p}),l.comparisons=x.map(p=>{const I=p.energyCost-f.energyCost;let C=p.energyCost>0?I/p.energyCost:f.energyCost<=0?0:-1/0,_=f.cost_per_kwh_heat>0&&p.cost_per_kwh_heat>0?p.cost_per_kwh_heat/f.cost_per_kwh_heat:null;const B=f.lcc.capex-p.lcc.capex,R=p.opex-f.opex;let S="无法收回投资";R>0&&B>0?S=(B/R).toFixed(2)+" 年":B<=0&&R>0?S="无需额外投资":B<=0&&R<=0&&(S="无额外投资/无节省");let k=B>0&&R>0?R/B:null;const V=p.co2-f.co2,J=V>0?V/18.3:0,M=p.lcc.total-f.lcc.total,w=M,O=[-B];for(let E=1;E<=m;E++){const L=f.energyCost*Math.pow(1+u,E-1),D=p.energyCost*Math.pow(1+u,E-1),se=f.opexCost*Math.pow(1+i,E-1),W=p.opexCost*Math.pow(1+i,E-1),ie=D+W-(L+se);O.push(ie)}const K=f.lcc.salvageValue-p.lcc.salvageValue;O[m]+=K;const ee=ge(O),Y=fe(O,g,m);return{key:p.key,name:p.name,opex:p.opex,opexSaving:R,investmentDiff:B,paybackPeriod:S,co2Reduction:V,treesPlanted:J,lcc:p.lcc.total,lccSaving:M,npv:w,irr:ee,dynamicPBP:Y,simpleROI:k,electricalPriceRatio:_,energyCostSaving:I,energyCostSavingRate:C,consumption:p.consumption,consumptionUnit:p.consumptionUnit}}),l.analysisMode=c,l}function q(e,t,o,s,n,a,c,d){const{lccYears:l,discountRate:m,energyInflationRate:g,opexInflationRate:u}=n,i=t*3.6;let h=0,v=0,b=0,r=0,f="未知",y=0,x="";switch(e){case"gas":f="天然气锅炉",r=a.gasSalvageRate,x="m³",a.gasBoilerEfficiency>0&&a.gasCalorific>0&&(b=i/a.gasBoilerEfficiency/a.gasCalorific,h=b*a.gasPrice,v=b*a.gasFactor,y=a.gasPrice/(a.gasCalorific/3.6*a.gasBoilerEfficiency));break;case"fuel":f="燃油锅炉",r=a.fuelSalvageRate,x="吨",a.fuelBoilerEfficiency>0&&a.fuelCalorific>0&&(b=i/a.fuelBoilerEfficiency/a.fuelCalorific/1e3,h=b*a.fuelPrice,v=b*a.fuelFactor,y=a.fuelPrice/1e3/(a.fuelCalorific/3.6*a.fuelBoilerEfficiency));break;case"coal":f="燃煤锅炉",r=a.coalSalvageRate,x="吨",a.coalBoilerEfficiency>0&&a.coalCalorific>0&&(b=i/a.coalBoilerEfficiency/a.coalCalorific/1e3,h=b*a.coalPrice,v=b*a.coalFactor,y=a.coalPrice/1e3/(a.coalCalorific/3.6*a.coalBoilerEfficiency));break;case"biomass":f="生物质锅炉",r=a.biomassSalvageRate,x="吨",a.biomassBoilerEfficiency>0&&a.biomassCalorific>0&&(b=i/a.biomassBoilerEfficiency/a.biomassCalorific/1e3,h=b*a.biomassPrice,v=b*a.biomassFactor,y=a.biomassPrice/1e3/(a.biomassCalorific/3.6*a.biomassBoilerEfficiency));break;case"electric":f="电锅炉",r=a.electricSalvageRate,x="kWh",a.electricBoilerEfficiency>0&&(b=t/a.electricBoilerEfficiency,h=b*d,v=b*c,y=d/a.electricBoilerEfficiency);break;case"steam":if(f="管网蒸汽",r=a.steamSalvageRate,x="吨",a.steamEfficiency>0&&a.steamCalorific>0){const S=t/a.steamEfficiency;b=S/a.steamCalorific,h=b*a.steamPrice,v=S*a.steamFactor,y=a.steamPrice/(a.steamCalorific*a.steamEfficiency)}break}const p=h+s,I=G(h,l,m,g),C=G(s,l,m,u),_=o*r,B=_/Math.pow(1+m,l),R=o+I+C-B;return{key:e,name:f,energyCost:h,opexCost:s,opex:p,co2:v,consumption:b,consumptionUnit:x,cost_per_kwh_heat:y,lcc:{capex:o,energyNPV:I,opexNPV:C,salvageRate:r,salvageNPV:B,salvageValue:_,total:R}}}let Me=[];const P={element:null,iconSuccess:null,iconError:null,text:null,timer:null,init(){this.element=document.getElementById("global-notifier"),this.iconSuccess=document.getElementById("global-notifier-icon-success"),this.iconError=document.getElementById("global-notifier-icon-error"),this.text=document.getElementById("global-notifier-text")}};function N(e,t="info",o=3e3){P.element||P.init(),P.element&&(clearTimeout(P.timer),P.text.textContent=e,P.element.className="fixed top-5 right-5 z-50 max-w-sm p-4 rounded-lg shadow-lg",P.iconSuccess.classList.add("hidden"),P.iconError.classList.add("hidden"),t==="success"?(P.element.classList.add("bg-green-100","text-green-700"),P.iconSuccess.classList.remove("hidden")):t==="error"?(P.element.classList.add("bg-red-100","text-red-700"),P.iconError.classList.remove("hidden")):P.element.classList.add("bg-blue-100","text-blue-700"),P.element.classList.remove("hidden"),P.timer=setTimeout(()=>{P.element.classList.add("hidden")},o))}const te={element:null,title:null,message:null,cancelBtn:null,okBtn:null,init(){this.element=document.getElementById("confirm-modal"),this.title=document.getElementById("confirm-modal-title"),this.message=document.getElementById("confirm-modal-message"),this.cancelBtn=document.getElementById("confirm-modal-cancel-btn"),this.okBtn=document.getElementById("confirm-modal-ok-btn")}};function pt(){te.element||te.init(),te.element&&te.element.addEventListener("click",e=>{(e.target.id==="confirm-modal"||e.target.id==="confirm-modal-cancel-btn")&&te.element.classList.add("hidden")})}function gt(e){Me.push({id:`scenario-${Date.now()}`,...e})}function ft(){return Me}let A=1;const ce=4;let T=null,Z=!0;function ke(){const e={};return _e.forEach(t=>{const o=document.getElementById(t);o&&(e[t]=o.type==="checkbox"||o.type==="radio"?o.checked:o.value)}),e}function yt(){console.log("正在执行重置..."),Object.keys(Q).forEach(e=>{const t=document.getElementById(e),o=Q[e];t&&(t.type==="checkbox"||t.type==="radio"?t.checked=o===!0:(t.value=o,j(t)))}),Ae(),Z=!0,$e(),N("所有参数已恢复默认值，本地记忆已清除。","success")}function bt(){if(T){Z=!0,Oe(!0);const e=document.getElementById("saveScenarioBtn");e&&(e.disabled=!0,e.classList.add("cursor-not-allowed"),e.textContent="暂存当前方案 (请先重新计算)")}}function ht(){A===3&&Z&&T&&N("参数已更改，建议重新计算以获得最新结果。","info"),A<ce&&(A++,ve(A,ce))}function vt(){A>1&&(A--,ve(A,ce))}function xt(){if(!De()){N("存在无效的输入参数，请检查红色提示框并修正。","error");return}const e=Te(t=>Se(t,"results-content"),(t,o)=>N(t,o));if(e)try{console.log("Starting calculation with inputs:",e),T=dt(e),et(T,e),Z=!1,Oe(!1);const t=document.getElementById("saveScenarioBtn");t&&document.getElementById("enableScenarioComparison").checked&&(t.disabled=!1,t.classList.remove("cursor-not-allowed"),t.textContent="暂存当前工业热泵方案"),N("计算成功！结果已更新。","success")}catch(t){console.error("Calculation failed:",t),Se(`计算时发生意外错误: ${t.message}`,"results-content"),N("计算失败，请检查控制台获取详细信息。","error"),T=null}}function Ct(){const e=document.getElementById("saveScenarioBtn"),t=document.getElementById("enableScenarioComparison");!e||!t||(t.addEventListener("change",()=>{const o=t.checked;e.classList.toggle("hidden",!o),document.getElementById("scenario-comparison-container").classList.toggle("hidden",!o),o&&!Z&&T?(e.disabled=!1,e.classList.remove("cursor-not-allowed"),e.textContent="暂存当前工业热泵方案"):(e.disabled=!0,e.classList.add("cursor-not-allowed"))}),e.addEventListener("click",()=>{if(!T||Z){N("请先成功计算，再暂存方案。","error");return}const s=`${document.getElementById("projectName").value||"未命名方案"} #${ft().length+1}`,n=Te(()=>{},()=>{}),a={name:s,inputs:n,results:{hpLcc:T.solutions.find(c=>c.type==="hp").totalLcc,hpAnnualCost:T.solutions.find(c=>c.type==="hp").avgAnnualCost,hpPbp:T.solutions.find(c=>c.type==="hp").pbp,hpIrr:T.solutions.find(c=>c.type==="hp").irr,hpCarbonReduction:T.solutions.find(c=>c.type==="hp").annualCarbonReduction}};gt(a),rt(),N(`方案 "${s}" 已成功暂存！`,"success")}))}function Et(){console.log("Phoenix Project V15.3 Initializing (With Memory)..."),Ze(bt,N),Ue(ht,vt);const e=He();e?(console.log("发现已保存的参数，正在加载..."),Object.keys(e).forEach(s=>{const n=document.getElementById(s);n&&(n.type==="checkbox"||n.type==="radio"?n.checked=e[s]:n.value=e[s])})):console.log("未发现保存的数据，使用默认值。"),_e.forEach(s=>{const n=document.getElementById(s);n&&(n.addEventListener("input",()=>{n.type!=="checkbox"&&n.type!=="radio"&&j(n);const a=ke();Ie(a)}),(n.type==="checkbox"||n.type==="radio")&&n.addEventListener("change",()=>{const a=ke();Ie(a)}))});const t=document.getElementById("btn-reset-params");t?(t.addEventListener("click",yt),console.log("重置按钮已成功绑定！")):console.error("错误: 无法找到 ID 为 'btn-reset-params' 的按钮，请检查 HTML。");const o=document.getElementById("calculateBtn");o&&o.addEventListener("click",xt),pt(),Ct(),it(),ve(A,ce),$e(),console.log("Application Ready.")}document.addEventListener("DOMContentLoaded",Et);
