(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const t of s)if(t.type==="childList")for(const r of t.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const t={};return s.integrity&&(t.integrity=s.integrity),s.referrerPolicy&&(t.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?t.credentials="include":s.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function o(s){if(s.ep)return;s.ep=!0;const t=n(s);fetch(s.href,t)}})();const xe={diesel:{price:8900,calorific:42.6,factor:3090,priceTooltip:"<b>默认值: 8900 元/吨</b><br>参考国内0号柴油市场价格及密度（约0.84kg/L）折算。",calorificTooltip:"<b>默认值: 42.6 MJ/kg</b><br>国标中0号柴油的典型低位发热量参考值。",factorTooltip:"<b>默认值: 3090 kgCO₂/吨</b><br>参考《省级温室气体清单编制指南》中柴油的排放因子。"},heavy_oil:{price:6500,calorific:41.8,factor:3170,priceTooltip:"<b>默认值: 6500 元/吨</b><br>参考国内燃料油（重油）市场平均价格。",calorificTooltip:"<b>默认值: 41.8 MJ/kg</b><br>国标中燃料油（5-7号）的典型低位发热量参考值。",factorTooltip:"<b>默认值: 3170 kgCO₂/吨</b><br>参考《省级温室气体清单编制指南》中燃料油的排放因子。"},residual_oil:{price:5500,calorific:40.2,factor:3250,priceTooltip:"<b>默认值: 5500 元/吨</b><br>参考国内渣油市场平均价格。",calorificTooltip:"<b>默认值: 40.2 MJ/kg</b><br>国标中渣油的典型低位发热量参考值。",factorTooltip:"<b>默认值: 3250 kgCO₂/吨</b><br>参考《省级温室气体清单编制指南》中渣油的排放因子。"}},ae=.004184,ce=860.42,ye=[{selectId:"heatingLoadUnit",inputId:"heatingLoad",conversions:{kW:1,"kcal/h":ce}},{selectId:"annualHeatingUnit",inputId:"annualHeating",conversions:{kWh:1,KJ:3600,MJ:3.6,GJ:.0036,TJ:36e-7,万大卡:ce/1e4,Mkcal:ce/1e6}},{selectId:"gridFactorUnit",inputId:"gridFactor",conversions:{"kgCO2/kWh":1,"tCO2/MWh":1}},{selectId:"steamFactorUnit",inputId:"steamFactor",conversions:{"kgCO2/kWh":1,"tCO2/MWh":1,"kgCO2/GJ":1/(3.6/1e3)}},{selectId:"gasFactorUnit",inputId:"gasFactor",dynamicConversions:()=>({"kgCO2/m3":1,"kgCO2/GJ":1/((parseFloat(document.getElementById("gasCalorific").dataset.baseValue)||35.57)/1e3)})},{selectId:"fuelFactorUnit",inputId:"fuelFactor",dynamicConversions:()=>{const e=parseFloat(document.getElementById("fuelCalorific").dataset.baseValue)||42.6;return{"kgCO2/t":1,"kgCO2/kg":1/1e3,"kgCO2/GJ":1e3/e}}},{selectId:"coalFactorUnit",inputId:"coalFactor",dynamicConversions:()=>{const e=parseFloat(document.getElementById("coalCalorific").dataset.baseValue)||29.3;return{"kgCO2/t":1,"kgCO2/kg":1/1e3,"kgCO2/GJ":1e3/e}}},{selectId:"biomassFactorUnit",inputId:"biomassFactor",dynamicConversions:()=>{const e=parseFloat(document.getElementById("biomassCalorific").dataset.baseValue)||16.32;return{"kgCO2/t":1,"kgCO2/kg":1/1e3,"kgCO2/GJ":1e3/e}}},{selectId:"gasCalorificUnit",inputId:"gasCalorific",conversions:{"MJ/m3":1,"kWh/m3":1/3.6,"GJ/m3":1/1e3,"kcal/m3":1/ae}},{selectId:"fuelCalorificUnit",inputId:"fuelCalorific",conversions:{"MJ/kg":1,"GJ/t":1,"kWh/kg":1/3.6,"kcal/kg":1/ae}},{selectId:"coalCalorificUnit",inputId:"coalCalorific",conversions:{"MJ/kg":1,"GJ/t":1,"kWh/kg":1/3.6,"kcal/kg":1/ae}},{selectId:"biomassCalorificUnit",inputId:"biomassCalorific",conversions:{"MJ/kg":1,"kcal/kg":1/ae,"GJ/t":1,"kWh/kg":1/3.6}},{selectId:"steamCalorificUnit",inputId:"steamCalorific",conversions:{"kWh/t":1,"GJ/t":3.6/1}}];let le="3.0",pe="4.0",ge="3.5",J="standard";function ve(){ye.forEach(a=>{const n=document.getElementById(a.selectId),o=document.getElementById(a.inputId);!n||!o||n.addEventListener("change",()=>{const s=a.dynamicConversions?a.dynamicConversions():a.conversions;o.dataset.baseValue===void 0&&(o.dataset.baseValue=o.value);const t=parseFloat(o.dataset.baseValue),r=n.value;if(t===0){o.value=0;return}const i=s[r];if(i==null){console.error("Missing conversion factor for",a.inputId,"to unit",r);return}let c=3;r.includes("/t")&&a.inputId.includes("Calorific")&&(c=1),r.includes("/kg")&&a.inputId.includes("Calorific")&&(c=3),r.includes("GJ/")&&(c=5),r.includes("kcal/kg")&&(c=0),r.includes("kcal/m3")&&(c=0),r.includes("kcal/h")&&(c=0),o.value=(t*i).toFixed(c)})});const e=document.getElementById("biomassCalorificUnit");e&&(e.value="kcal/kg",e.dispatchEvent(new Event("change")))}function Ce(){document.querySelectorAll(".comparison-toggle").forEach(a=>{const n=a.dataset.target,o=document.getElementById(n==="steam"?"steamCapex":`${n}BoilerCapex`),s=document.getElementById(`${n}SalvageRate`),t=a.closest("div.grid > div"),r=document.querySelectorAll(`.${n}-related`),i=document.querySelector(`.${n}-opex-related`),c=l=>{o&&(o.disabled=!l),s&&(s.disabled=!l),t&&t.classList.toggle("opacity-50",!l),r.forEach(f=>{f.classList.toggle("hidden",!l)}),i&&i.classList.toggle("hidden",!l)};a.addEventListener("change",()=>{c(a.checked)}),c(a.checked)})}function Be(e,a){const n=document.getElementById("modeStandard"),o=document.getElementById("modeHybrid"),s=document.getElementById("modeBot"),t=document.getElementById("hybridConfigInputs"),r=document.getElementById("botConfigInputs"),i=document.getElementById("comparisonTogglesContainer"),c=document.getElementById("standardModeSections"),l=document.getElementById("lccParamsContainer"),f=document.getElementById("hpCopLabel"),u=document.getElementById("hpCop"),d=document.getElementById("section2Title"),b=document.getElementById("section7Title"),y=document.getElementById("calcModeAContainer"),g=document.getElementById("calcModeBContainer"),m=document.getElementById("calcModeCContainer"),x=document.querySelectorAll('input[name="calcMode"]');if(!n||!o||!s||!t||!r||!i||!c||!l){console.error("V11.0 (模式选择) UI 元素未在 HTML 中完全找到。");return}const h=B=>{const p=u.value;if(J==="standard"?le=p:J==="hybrid"?pe=p:J==="bot"&&(ge=p),B==="standard"||B==="hybrid"){t.classList.toggle("hidden",B==="standard"),r.classList.add("hidden"),i.classList.remove("hidden"),c.classList.remove("hidden"),l.classList.remove("hidden"),x.forEach(L=>L.disabled=!1);const v=document.querySelector('input[name="calcMode"]:checked');v&&v.dispatchEvent(new Event("change")),B==="standard"?(f.textContent="全年综合性能系数 (SPF)",u.value=le):(f.textContent="工业热泵在此工况下的 SPF",u.value=pe),d.textContent="2. 方案配置",b.textContent="7. 财务分析参数"}else B==="bot"&&(t.classList.add("hidden"),r.classList.remove("hidden"),i.classList.add("hidden"),c.classList.add("hidden"),l.classList.remove("hidden"),y&&y.classList.add("hidden"),g&&g.classList.add("hidden"),m&&m.classList.add("hidden"),x.forEach(v=>v.disabled=!0),f.textContent="BOT 项目 SPF (用于计算电费成本)",u.value=ge,d.textContent="2. 方案与投资配置",b.textContent="7. BOT 财务分析参数");J=B;const C=B==="standard"?"3.0":B==="hybrid"?"4.0":"3.5";u.classList.toggle("default-param",u.value===C),e()};n.addEventListener("change",()=>{n.checked&&h("standard")}),o.addEventListener("change",()=>{o.checked&&h("hybrid")}),s.addEventListener("change",()=>{s.checked&&(a&&a("模式三 (BOT 模式) 正在升级中，暂不开放。","info",4e3),J==="standard"?n.checked=!0:J==="hybrid"?o.checked=!0:n.checked=!0)}),u.value=le,h("standard")}function Ee(e){var i;const a=document.querySelectorAll('input[name="calcMode"]'),n=document.getElementById("calcModeAContainer"),o=document.getElementById("calcModeBContainer"),s=document.getElementById("calcModeCContainer"),t=(i=document.getElementById("operatingHours"))==null?void 0:i.parentElement;if(!n||!o||!s||!t||a.length===0){console.error("年加热量计算模式的 UI 元素未完全找到。");return}const r=()=>{const c=document.querySelector('input[name="calcMode"]:checked');if(!c)return;const l=c.value;l==="annual"?(n.classList.remove("hidden"),o.classList.add("hidden"),s.classList.add("hidden"),t.classList.remove("hidden")):l==="total"?(n.classList.add("hidden"),o.classList.remove("hidden"),s.classList.add("hidden")):l==="daily"&&(n.classList.remove("hidden"),o.classList.add("hidden"),s.classList.remove("hidden"),t.classList.add("hidden")),e()};a.forEach(c=>{c.addEventListener("change",r)}),r()}function fe(e="",a="",n="",o,s){const t=document.getElementById("priceTiersContainer");if(!t){console.error("priceTiersContainer 未找到!");return}const r=`tier-${Date.now()}-${Math.floor(Math.random()*1e3)}`,i=document.createElement("div");i.className="price-tier-entry grid grid-cols-1 md:grid-cols-10 gap-2 items-center",i.id=r,i.innerHTML=`
        <div class="md:col-span-3">
            <label for="${r}-name" class="block text-xs font-medium text-gray-600 mb-1">时段名称 (可选)</label>
            <input type="text" id="${r}-name" value="${e}" placeholder="例如: 峰时" class="tier-name w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm track-change storage-mode-field">
        </div>
        <div class="md:col-span-3">
            <label for="${r}-price" class="block text-xs font-medium text-gray-600 mb-1">电价 (元/kWh)</label>
            <input type="number" id="${r}-price" value="${a}" placeholder="例如: 1.2" class="tier-price w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm track-change storage-mode-field">
        </div>
        <div class="md:col-span-3">
            <label for="${r}-dist" class="block text-xs font-medium text-gray-600 mb-1">运行比例 (%)</label>
            <input type="number" id="${r}-dist" value="${n}" placeholder="例如: 40" class="tier-dist w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm track-change storage-mode-field">
        </div>
        <div class="md:col-span-1 flex items-end h-full">
            <button class="removePriceTierBtn w-full text-sm bg-red-100 text-red-700 font-semibold py-2 px-3 rounded-lg hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-300 mt-5 md:mt-0">
                删除
            </button>
        </div>
    `,t.appendChild(i),i.querySelectorAll("input.track-change").forEach(c=>{c.dataset.defaultValue=c.value,c.addEventListener("input",l=>{const f=l.target,u=f.dataset.defaultValue;(f.classList.contains("default-param")||u!==void 0)&&f.classList.toggle("default-param",f.value===u),f.classList.contains("track-change")&&o()})}),i.querySelector(".removePriceTierBtn").addEventListener("click",()=>{document.querySelectorAll(".price-tier-entry").length>1?(i.remove(),o()):s?s("必须至少保留一个电价时段。","error"):alert("必须至少保留一个电价时段。")})}function Ie(e,a){const n=document.getElementById("addPriceTierBtn");n&&(n.addEventListener("click",()=>{fe("","","",e,a),e()}),fe("平均电价","0.7","100",e,a),document.querySelectorAll(".price-tier-entry").forEach(o=>{o.querySelectorAll("input").forEach(s=>{s.value&&s.classList.add("default-param")})}))}function Le(){const e=document.getElementById("greenElectricityToggle"),a=document.getElementById("gridFactor"),n=document.getElementById("gridFactorUnit");!e||!a||!n||e.addEventListener("change",()=>{if(e.checked)a.value="0",a.dataset.baseValue="0",a.disabled=!0,n.disabled=!0,a.classList.remove("default-param");else{const o=a.getAttribute("data-base-value")||"0.57";a.dataset.baseValue=o,n.value="kgCO2/kWh",n.dispatchEvent(new Event("change")),a.disabled=!1,n.disabled=!1,a.classList.add("default-param"),a.dataset.defaultValue=a.value}})}function Re(){const e=document.getElementById("fuelType");if(!e)return;const a=document.getElementById("fuelPrice"),n=document.getElementById("fuelCalorific"),o=document.getElementById("fuelFactor"),s=document.getElementById("fuelPriceTooltip"),t=document.getElementById("fuelCalorificTooltip"),r=document.getElementById("fuelFactorTooltip"),i=document.getElementById("fuelCalorificUnit"),c=document.getElementById("fuelFactorUnit");e.addEventListener("change",l=>{const f=l.target.value,u=xe[f];u&&(a.dataset.baseValue=u.price,n.dataset.baseValue=u.calorific,o.dataset.baseValue=u.factor,a.value=u.price,a.dataset.defaultValue=u.price,a.classList.add("default-param"),s&&(s.innerHTML=u.priceTooltip),t&&(t.innerHTML=u.calorificTooltip),r&&(r.innerHTML=u.factorTooltip),i.value="MJ/kg",i.dispatchEvent(new Event("change")),n.dataset.defaultValue=n.value,n.classList.add("default-param"),c.value="kgCO2/t",c.dispatchEvent(new Event("change")),o.dataset.defaultValue=o.value,o.classList.add("default-param"))})}function Fe(e,a){ve(),Ce(),Le(),Re(),Ie(e,a),Be(e,a),Ee(e),document.querySelectorAll('input[type="number"], input[type="checkbox"], select, input[type="text"], input[type="radio"]').forEach(o=>{let s;o.type==="checkbox"?s=o.checked:s=o.value,(o.id==="heatingLoad"||o.id==="annualHeating"||o.id.endsWith("Calorific")||o.id.endsWith("Factor"))&&o.dataset.baseValue===void 0&&(o.dataset.baseValue=o.value),o.dataset.defaultValue=s;const t=r=>{const i=r.target;let c=i.dataset.defaultValue,l=i.value;i.type==="checkbox"&&(l=i.checked,c=c==="true"),(i.classList.contains("default-param")||c!==void 0)&&i.classList.toggle("default-param",l===c),i.parentElement;const f=document.getElementById(i.id+"Unit");if(f&&f.id.includes("Unit")){const u=parseFloat(i.value);if(isNaN(u)){const m=i.getAttribute("data-base-value");i.dataset.baseValue=m,i.classList.contains("track-change")&&e();return}const d=f.value,b=ye.find(m=>m.inputId===i.id);if(!b)return;const g=(b.dynamicConversions?b.dynamicConversions():b.conversions)[d];if(u===0)i.dataset.baseValue=0;else if(g&&g!==0){const m=u/g;i.dataset.baseValue=m}}i.classList.contains("track-change")&&e()};o.tagName==="SELECT"||o.type==="checkbox"||o.type==="radio"?o.addEventListener("change",t):o.addEventListener("input",t)})}function Pe(e,a){const n=[];let o=0;document.querySelectorAll(".price-tier-entry").forEach(g=>{const m=g.querySelector(".tier-name").value.trim()||"时段",x=parseFloat(g.querySelector(".tier-price").value)||0,h=parseFloat(g.querySelector(".tier-dist").value)||0;o+=h,n.push({name:m,price:x,dist:h})});const s=document.querySelector('input[name="schemeAMode"]:checked').value||"standard";if(s!=="bot"){if(Math.abs(o-100)>.1)return e(`电价时段总比例必须为 100%，当前为 ${o.toFixed(1)}%！`),null;if(n.some(g=>g.price<=0||g.dist<=0))return e("电价或运行比例必须大于 0！"),null}e(null);const t=document.querySelector('input[name="calcMode"]:checked'),r=t?t.value:"annual",i=parseFloat(document.getElementById("heatingLoad").dataset.baseValue)||0,c=parseFloat(document.getElementById("operatingHours").value)||0,l=parseFloat(document.getElementById("annualHeating").dataset.baseValue)||0,f=parseFloat(document.getElementById("dailyHours").value)||0,u=parseFloat(document.getElementById("annualDays").value)||0,d=(parseFloat(document.getElementById("loadFactor").value)||0)/100;let b=0;r==="annual"?b=i*c:r==="total"?b=l:r==="daily"&&(b=i*f*u*d);const y={analysisMode:s,isHybridMode:s==="hybrid",lccYears:parseInt(document.getElementById("lccYears").value)||15,discountRate:(parseFloat(document.getElementById("discountRate").value)||8)/100,energyInflationRate:(parseFloat(document.getElementById("energyInflationRate").value)||3)/100,opexInflationRate:(parseFloat(document.getElementById("opexInflationRate").value)||5)/100,isGreenElectricity:document.getElementById("greenElectricityToggle").checked,priceTiers:n,projectName:document.getElementById("projectName").value,heatingLoad:i,operatingHours:c,annualHeating:l,dailyHours:f,annualDays:u,loadFactor:d,annualHeatingDemandKWh:b,hpHostCapex:parseFloat(document.getElementById("hpCapex").value)*1e4||0,hpStorageCapex:parseFloat(document.getElementById("storageCapex").value)*1e4||0,hpSalvageRate:(parseFloat(document.getElementById("hpSalvageRate").value)||0)/100,gasBoilerCapex:parseFloat(document.getElementById("gasBoilerCapex").value)*1e4||0,gasSalvageRate:(parseFloat(document.getElementById("gasSalvageRate").value)||0)/100,fuelBoilerCapex:parseFloat(document.getElementById("fuelBoilerCapex").value)*1e4||0,fuelSalvageRate:(parseFloat(document.getElementById("fuelSalvageRate").value)||0)/100,coalBoilerCapex:parseFloat(document.getElementById("coalBoilerCapex").value)*1e4||0,coalSalvageRate:(parseFloat(document.getElementById("coalSalvageRate").value)||0)/100,biomassBoilerCapex:parseFloat(document.getElementById("biomassBoilerCapex").value)*1e4||0,biomassSalvageRate:(parseFloat(document.getElementById("biomassSalvageRate").value)||0)/100,electricBoilerCapex:parseFloat(document.getElementById("electricBoilerCapex").value)*1e4||0,electricSalvageRate:(parseFloat(document.getElementById("electricSalvageRate").value)||0)/100,steamCapex:parseFloat(document.getElementById("steamCapex").value)*1e4||0,steamSalvageRate:(parseFloat(document.getElementById("steamSalvageRate").value)||0)/100,hpCop:parseFloat(document.getElementById("hpCop").value)||0,gasBoilerEfficiency:parseFloat(document.getElementById("gasBoilerEfficiency").value)/100||0,fuelBoilerEfficiency:parseFloat(document.getElementById("fuelBoilerEfficiency").value)/100||0,coalBoilerEfficiency:parseFloat(document.getElementById("coalBoilerEfficiency").value)/100||0,biomassBoilerEfficiency:parseFloat(document.getElementById("biomassBoilerEfficiency").value)/100||0,electricBoilerEfficiency:parseFloat(document.getElementById("electricBoilerEfficiency").value)/100||0,steamEfficiency:parseFloat(document.getElementById("steamEfficiency").value)/100||0,gasPrice:parseFloat(document.getElementById("gasPrice").value)||0,fuelPrice:parseFloat(document.getElementById("fuelPrice").value)||0,coalPrice:parseFloat(document.getElementById("coalPrice").value)||0,biomassPrice:parseFloat(document.getElementById("biomassPrice").value)||0,steamPrice:parseFloat(document.getElementById("steamPrice").value)||0,gridFactor:document.getElementById("greenElectricityToggle").checked?0:parseFloat(document.getElementById("gridFactor").dataset.baseValue)||0,gasFactor:parseFloat(document.getElementById("gasFactor").dataset.baseValue)||0,fuelFactor:parseFloat(document.getElementById("fuelFactor").dataset.baseValue)||0,coalFactor:parseFloat(document.getElementById("coalFactor").dataset.baseValue)||0,biomassFactor:parseFloat(document.getElementById("biomassFactor").dataset.baseValue),steamFactor:parseFloat(document.getElementById("steamFactor").dataset.baseValue)||0,gasCalorific:parseFloat(document.getElementById("gasCalorific").dataset.baseValue)||0,fuelCalorific:parseFloat(document.getElementById("fuelCalorific").dataset.baseValue)||0,coalCalorific:parseFloat(document.getElementById("coalCalorific").dataset.baseValue)||0,biomassCalorific:parseFloat(document.getElementById("biomassCalorific").dataset.baseValue)||0,steamCalorific:parseFloat(document.getElementById("steamCalorific").dataset.baseValue)||0,hpOpexCost:(parseFloat(document.getElementById("hpOpexCost").value)||0)*1e4,gasOpexCost:(parseFloat(document.getElementById("gasOpexCost").value)||0)*1e4,fuelOpexCost:(parseFloat(document.getElementById("fuelOpexCost").value)||0)*1e4,coalOpexCost:(parseFloat(document.getElementById("coalOpexCost").value)||0)*1e4,biomassOpexCost:(parseFloat(document.getElementById("biomassOpexCost").value)||0)*1e4,electricOpexCost:(parseFloat(document.getElementById("electricOpexCost").value)||0)*1e4,steamOpexCost:(parseFloat(document.getElementById("steamOpexCost").value)||0)*1e4,hybridLoadShare:(parseFloat(document.getElementById("hybridLoadShare").value)||0)/100,hybridAuxHeaterType:document.getElementById("hybridAuxHeaterType").value,hybridAuxHeaterCapex:(parseFloat(document.getElementById("hybridAuxHeaterCapex").value)||0)*1e4,hybridAuxHeaterOpex:(parseFloat(document.getElementById("hybridAuxHeaterOpex").value)||0)*1e4,botAnnualRevenue:(parseFloat(document.getElementById("botAnnualRevenue").value)||0)*1e4,botAnnualEnergyCost:(parseFloat(document.getElementById("botAnnualEnergyCost").value)||0)*1e4,botAnnualOpexCost:(parseFloat(document.getElementById("botAnnualOpexCost").value)||0)*1e4,botEquityRatio:(parseFloat(document.getElementById("botEquityRatio").value)||0)/100,botLoanInterestRate:(parseFloat(document.getElementById("botLoanInterestRate").value)||0)/100,botDepreciationYears:parseInt(document.getElementById("botDepreciationYears").value)||10,botVatRate:(parseFloat(document.getElementById("botVatRate").value)||0)/100,botSurtaxRate:(parseFloat(document.getElementById("botSurtaxRate").value)||0)/100,botIncomeTaxRate:(parseFloat(document.getElementById("botIncomeTaxRate").value)||0)/100,compare:{gas:document.getElementById("compare_gas").checked,fuel:document.getElementById("compare_fuel").checked,coal:document.getElementById("compare_coal").checked,biomass:document.getElementById("compare_biomass").checked,electric:document.getElementById("compare_electric").checked,steam:document.getElementById("compare_steam").checked}};if(s!=="bot"){if(b<=0||!y.hpCop)return a?a("成本对比模式: 请确保最终的“年总加热量”大于 0，并已填写工业热泵SPF。","error"):alert("成本对比模式: 请确保最终的“年总加热量”大于 0，并已填写工业热泵SPF。"),null}else if(y.botAnnualRevenue===0||y.botAnnualEnergyCost===0)return a?a("BOT模式: “年销售收入”和“年能源成本”必须大于0。","error"):alert("BOT模式: “年销售收入”和“年能源成本”必须大于0。"),null;return y}function W(e,a,n,o){let s=0;for(let t=1;t<=a;t++){const i=e*Math.pow(1+o,t-1)/Math.pow(1+n,t);s+=i}return s}function Y(e,a){let n=0;for(let o=0;o<e.length;o++)n+=e[o]/Math.pow(1+a,o);return n}function re(e,a=100,n=1e-6){if(e.length===0||e[0]>=0){const l=e.slice(1).reduce((f,u)=>f+u,0);return e[0]<0||l>0?1/0:null}let o=-.99,s=5,t,r;const i=Y(e,0),c=Y(e,s);if(i<0)c<i&&(s=0);else if(c>0&&(o=s,s=20,Y(e,s)>0))return 1/0;for(let l=0;l<a;l++){if(t=(o+s)/2,r=Y(e,t),Math.abs(r)<n)return t;r>0?o=t:s=t}return null}function de(e,a,n){const o=-e[0];if(o<=0)return 0;let s=0;for(let t=1;t<=n&&!(t>=e.length);t++){const r=e[t]/Math.pow(1+a,t);if(!(r<=0&&s<o)&&s<o){const i=s;if(s+=r,s>=o){const c=o-i;if(r===0){if(c===0)return t-1;continue}return t-1+c/r}}}return null}const I=e=>(e/1e4).toFixed(2),A=e=>(e/1e3).toFixed(2),Se=e=>e.toFixed(2),V=(e,a=1)=>e===null||!isFinite(e)?"N/A":`${(e*100).toFixed(a)} %`,X=e=>e===null||!isFinite(e)?"无法回收":`${e.toFixed(2)} 年`,w=(e,a=1)=>e===null||!isFinite(e)||e===0?"N/A":e.toLocaleString(void 0,{minimumFractionDigits:a,maximumFractionDigits:a}),$e=e=>e.toLocaleString(void 0,{maximumFractionDigits:0}),ue=e=>e.toLocaleString(void 0,{maximumFractionDigits:0});let T=[],j=[];function ne(){var c;const e=document.getElementById("scenario-comparison-container"),a=document.getElementById("scenario-table-wrapper"),n=(c=document.getElementById("scenario-comparison-table"))==null?void 0:c.querySelector("tbody"),o=document.getElementById("scenario-summary"),s=document.getElementById("enableScenarioComparison"),t=document.getElementById("clearScenariosBtn"),r=document.getElementById("undoClearBtn");if(!e||!s||!n)return;if(!s.checked){e.classList.add("hidden");return}if(e.classList.remove("hidden"),T.length===0){a&&a.classList.add("hidden"),o&&o.classList.add("hidden"),j.length>0?(t&&t.classList.add("hidden"),r&&r.classList.remove("hidden")):(t&&t.classList.add("hidden"),r&&r.classList.add("hidden"));return}a&&a.classList.remove("hidden"),o&&o.classList.remove("hidden"),t&&t.classList.remove("hidden"),r&&r.classList.add("hidden"),n.innerHTML="",o&&(o.innerHTML="");const i=Math.min(...T.map(l=>l.lcc));if(T.forEach((l,f)=>{const u=l.lcc===i,d=document.createElement("tr");d.className=u?"bg-green-50":"",d.innerHTML=`
            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium ${u?"text-green-900":"text-gray-900"}">${l.name}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${I(l.totalCapex)}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${I(l.hpCapex)}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${I(l.storageCapex)}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${Se(l.hpCop)}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${I(l.opex)}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm ${u?"font-bold text-green-700":"text-gray-700"}">${I(l.lcc)} ${u?" (LCC最优)":""}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${l.baselineName}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-blue-700">${X(l.dynamicPBP)}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-blue-700">${V(l.irr)}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-green-700">${A(l.co2)}</td>
        `,n.appendChild(d)}),T.length>0&&o){let l='<h4 class="text-lg font-semibold text-indigo-900 mb-2">对比总结</h4>';const f=T.reduce((y,g)=>y.lcc<g.lcc?y:g);l+=`<p>• <b>LCC (全寿命周期成本) 最优:</b> 方案 "<b>${f.name}</b>"，总成本为 <b>${I(f.lcc)} 万元</b>。</p>`;const u=T.filter(y=>y.irr!==null&&isFinite(y.irr));if(u.length>0){const y=u.reduce((g,m)=>g.irr>m.irr?g:m);l+=`<p>• <b>IRR (内部收益率) 最高:</b> 方案 "<b>${y.name}</b>"，IRR 高达 <b>${V(y.irr)}</b> (对比${y.baselineName})。</p>`}else l+="<p>• <b>IRR (内部收益率):</b> 无有效IRR数据可供对比 (可能均无额外投资或无法回收)。</p>";const d=T.filter(y=>y.dynamicPBP!==null&&isFinite(y.dynamicPBP));if(d.length>0){const y=d.reduce((g,m)=>g.dynamicPBP<m.dynamicPBP?g:m);l+=`<p>• <b>PBP (动态回收期) 最短:</b> 方案 "<b>${y.name}</b>"，回收期仅 <b>${X(y.dynamicPBP)}</b> (对比${y.baselineName})。</p>`}else l+="<p>• <b>PBP (动态回收期):</b> 无有效PBP数据可供对比 (可能均无法回收)。</p>";const b=T.reduce((y,g)=>y.co2<g.co2?y:g);l+=`<p>• <b>碳排放最低:</b> 方案 "<b>${b.name}</b>"，年排放仅 <b>${A(b.co2)} 吨CO₂</b>。</p>`,o.innerHTML=l}}function ke(){const e=document.getElementById("enableScenarioComparison"),a=document.getElementById("saveScenarioBtn"),n=document.getElementById("scenario-comparison-container");!e||!a||!n||e.addEventListener("change",()=>{e.checked?(a.classList.remove("hidden"),ne()):(a.classList.add("hidden"),n.classList.add("hidden"))})}function Te(e,a,n,o){const s=a.isHybrid||!1;let t=e;s&&!t.includes("(混合)")&&(t+=" (混合)");let r=1;for(;T.some(c=>c.name===t);)t=`${e} ${s?"(混合)":""} (${r++})`;const i={name:t,lcc:a.lcc.total,opex:a.opex,co2:a.co2,hpCapex:a.lcc.capex_host,storageCapex:a.lcc.capex_storage,totalCapex:a.lcc.capex,hpCop:n,baselineName:o?o.name:"无对比",dynamicPBP:o?o.dynamicPBP:null,irr:o?o.irr:null};T.push(i),ne(),j=[]}function _e(e,a){const n=document.getElementById("clearScenariosBtn"),o=document.getElementById("undoClearBtn");n?n.addEventListener("click",async()=>{if(T.length===0){a&&a("方案列表已经为空。","info");return}await e("确认清空列表",'确定要清空所有已暂存的方案吗？您可以通过 "恢复列表" 按钮撤销此操作。')&&(j=[...T],T=[],ne(),a&&a("方案列表已清空。","success"))}):console.warn("'clearScenariosBtn' not found."),o?o.addEventListener("click",()=>{j.length!==0&&(T=[...j],j=[],ne(),a&&a("已恢复上次清空的列表。","success"))}):console.warn("'undoClearBtn' not found."),ke()}let ie=null;function G(e,a="info",n=3e3){const o=document.getElementById("global-notifier"),s=document.getElementById("global-notifier-text"),t=document.getElementById("global-notifier-icon-success"),r=document.getElementById("global-notifier-icon-error");!o||!s||!t||!r||(ie&&clearTimeout(ie),s.textContent=e,o.className="fixed top-5 right-5 z-50 max-w-sm p-4 rounded-lg shadow-lg flex items-center transition-opacity transition-transform duration-300",t.classList.add("hidden"),r.classList.add("hidden"),a==="success"?(o.classList.add("bg-green-100","text-green-800"),t.classList.remove("hidden")):a==="error"?(o.classList.add("bg-red-100","text-red-800"),r.classList.remove("hidden")):(o.classList.add("bg-blue-100","text-blue-800"),t.classList.remove("hidden")),o.classList.remove("hidden","opacity-0","translate-x-full"),ie=setTimeout(()=>{o.classList.add("opacity-0","translate-x-full"),setTimeout(()=>o.classList.add("hidden"),300)},n))}let oe=null;function Ve(e,a){const n=document.getElementById("confirm-modal"),o=document.getElementById("confirm-modal-title"),s=document.getElementById("confirm-modal-message");return!n||!o||!s?Promise.resolve(!1):(o.textContent=e,s.textContent=a,n.classList.remove("hidden"),new Promise(t=>{oe=t}))}function Me(){const e=document.getElementById("confirm-modal"),a=document.getElementById("confirm-modal-ok-btn"),n=document.getElementById("confirm-modal-cancel-btn");if(!e||!a||!n)return;const o=s=>{e.classList.add("hidden"),oe&&(oe(s),oe=null)};a.addEventListener("click",()=>o(!0)),n.addEventListener("click",()=>o(!1))}function be(e){var a,n;(a=document.getElementById("stale-results-notice"))==null||a.classList.toggle("hidden",!e),(n=document.getElementById("results-container"))==null||n.classList.toggle("opacity-50",e)}function Oe(e){var a,n;(a=document.getElementById("results-placeholder"))==null||a.classList.toggle("hidden",e),(n=document.getElementById("results-content"))==null||n.classList.toggle("hidden",!e)}function Q(e,a="暂存当前工业热泵方案 (请先计算)"){const n=document.getElementById("saveScenarioBtn"),o=document.getElementById("enableScenarioComparison");if(!(!n||!o)){if(!o.checked){n.classList.add("hidden");return}n.classList.remove("hidden"),n.disabled=e==="disabled",n.classList.toggle("bg-gray-400",e==="disabled"),n.classList.toggle("cursor-not-allowed",e==="disabled"),n.classList.toggle("bg-green-600",e!=="disabled"),n.classList.toggle("hover:bg-green-700",e!=="disabled"),e==="saved"?(n.textContent="方案已暂存!",setTimeout(()=>{Q("enabled")},2e3)):n.textContent=a}}function we(e){const a=document.getElementById("priceTierError");a&&(e?(a.textContent=e,a.classList.remove("hidden")):a.classList.add("hidden"))}function He(e){const{analysisMode:a}=e;a==="bot"?Ne():Ae(e)}function Ne(e){const a=document.getElementById("results-content");a&&(a.innerHTML='<div class="p-6">BOT 模式结果渲染区</div>')}function Ae(e){const{lccParams:a,comparisons:n}=e,o=e.isHybridMode?e.hybridSystem:e.hp,s=a.lccYears,t=a.discountRate,r=document.getElementById("results-content");if(!r)return;const i=document.getElementById("results-title");i&&(i.textContent=`静态、ROI 与 LCC (${s}年) 对比分析结果`);const c=o.isHybrid||!1,l=c?"混合系统年运行成本 (第1年)":"工业热泵系统年运行成本 (第1年)",f=c?`混合系统 LCC (${s}年)`:`工业热泵系统 LCC (${s}年)`;let u=`
        <div class="space-y-6">
            <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
                <h3 class="font-semibold text-lg text-blue-800 mb-2">${l}</h3>
                <div class="flex flex-col sm:flex-row justify-between sm:items-baseline sm:gap-4">
                    <div>
                        <p class="text-xs text-blue-700">年总运行成本</p>
                        <p class="text-3xl font-bold text-blue-600">${I(o.opex)} 万元</p>
                    </div>
                    <div class="sm:text-right mt-2 sm:mt-0">
                        <p class="text-xs text-blue-700">折算吨蒸汽电耗</p>
                        <p class="text-xl font-semibold text-blue-600">${w(o.electricity_per_steam_ton,1)} kWh/t</p>
                    </div>
                    <div class="sm:text-right mt-2 sm:mt-0">
                        <p class="text-xs text-blue-700">折算吨蒸汽单价</p>
                        <p class="text-xl font-semibold text-blue-600">${ue(o.cost_per_steam_ton)} 元/t</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-blue-100 border-l-4 border-blue-600 p-6 rounded-lg">
                <h3 class="font-semibold text-lg text-blue-900">
                    ${f}
                </h3>
                <p class="text-xs text-blue-700 mb-1">LCC = 初始投资 + (未来${s}年所有运营成本 - ${s}年后残值)</p>
                <p class="text-3xl font-bold text-blue-700">${I(o.lcc.total)} 万元</p>
            </div>
        </div>
    `;n.forEach(m=>{const x=m.npv>0?"text-green-600":"text-red-600",h=m.irr>t?"text-green-600":m.irr===null||!isFinite(m.irr)?"text-gray-500":"text-red-600",B=m.dynamicPBP!==null?"text-blue-600":"text-red-600",p=m.opexSaving>0?"text-green-600":"text-red-600",C=m.energyCostSaving>0?"text-green-600":"text-red-600",v=m.simpleROI!==null?"text-green-600":"text-gray-500";u+=`
        <div class="bg-gray-50 p-6 rounded-lg border mt-8 space-y-4">
            <h4 class="text-xl font-bold text-gray-800 border-b pb-3">与 <span class="text-blue-600">${m.name}</span> 对比</h4>
            
            <div class="space-y-2">
                <h5 class="font-semibold text-blue-800 text-md">视角: 投资回报率 (ROI)</h5>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">简单投资回报率 (ROI)</span>
                    <span class="font-bold text-lg ${v}">${V(m.simpleROI)}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">净现值 (NPV)</span>
                    <span class="font-bold text-lg ${x}">${I(m.npv)} 万元</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">内部收益率 (IRR)</span>
                    <span class="font-bold text-lg ${h}">${V(m.irr)}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2">
                    <span class="text-gray-600">动态回收期 (PBP)</span>
                    <span class="font-bold text-lg ${B}">${X(m.dynamicPBP)}</span>
                </div>
            </div>

            <div class="space-y-2 pt-4 border-t">
                <h5 class="font-semibold text-gray-800 text-md">视角: 静态 (第1年) 与 环境</h5>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">电热价格比 (EPR)</span>
                    <span class="font-bold text-lg ${m.electricalPriceRatio>1?"text-green-600":"text-red-600"}">${m.electricalPriceRatio?m.electricalPriceRatio.toFixed(2):"N/A"}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">年节省能源费:</span>
                    <span class="font-semibold ${C}">${I(m.energyCostSaving)} 万元</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">能源费节能率:</span>
                    <span class="font-semibold ${C}">${V(m.energyCostSavingRate)}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">年节省总成本 (含运维):</span>
                    <span class="font-semibold ${p}">${I(m.opexSaving)} 万元</span>
                </div>
                 <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">静态回报期 (总成本):</span>
                    <span class="font-semibold">${m.paybackPeriod}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">基准年能源消耗:</span>
                    <span class="font-semibold text-gray-700">${w(m.consumption,2)} ${m.consumptionUnit}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2">
                    <span class="text-gray-600">年碳减排量:</span>
                    <span class="font-semibold text-green-600">${A(m.co2Reduction)} 吨 CO₂</span>
                </div>
            </div>

             <div class="space-y-2 pt-4 border-t">
                <h5 class="font-semibold text-gray-800 text-md">视角: 全生命周期成本 (LCC)</h5>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">${c?"混合系统":"工业热泵"} LCC:</span>
                    <span class="font-semibold text-blue-700">${I(o.lcc.total)} 万元</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2">
                    <span class="text-gray-600">${m.name} LCC:</span>
                    <span class="font-semibold text-gray-700">${I(m.lcc)} 万元</span>
                </div>
            </div>
        </div>
        `});let d=`
        <div class="bg-indigo-50 border-l-4 border-indigo-500 p-6 rounded-lg space-y-3 mt-8">
            <h4 class="text-xl font-bold text-indigo-800 border-b pb-2">综合结论 (基于 ${s} 年分析)</h4>
    `;const b=n.filter(m=>m.irr>t&&isFinite(m.irr));if(b.length>0){const m=b.reduce((x,h)=>x.irr>h.irr?x:h);d+=`<p class="text-sm text-gray-700"><b>投资回报 (ROI) 结论：</b>项目可行。相较于 <b>${b.map(x=>x.name).join("、")}</b>，IRR 高于基准收益率(${V(t)})。回报最佳的是替代 <b>${m.name}</b>，IRR 高达 <b>${V(m.irr)}</b>，动态回收期 <b>${X(m.dynamicPBP)}</b>。</p>`}else{const m=n.length>0?n.reduce((x,h)=>x.npv>h.npv?x:h):null;m&&m.npv>0?d+=`<p class="text-sm text-gray-700"><b>投资回报 (ROI) 结论：</b>项目勉强可行。相较于 <b>${m.name}</b>，项目净现值(NPV)为正 (<b>${I(m.npv)} 万元</b>)，但所有方案 IRR 均未超过基准收益率(${V(t)})。</p>`:d+=`<p class="text-sm text-red-700"><b>投资回报 (ROI) 结论：</b>项目不可行。相较于所有对比方案，项目的 IRR 均低于基准收益率(${V(t)})，且 NPV 均为负。</p>`}const y=n.filter(m=>m.co2Reduction>0);if(y.length>0){const m=y.reduce((x,h)=>x.co2Reduction>h.co2Reduction?x:h);d+=`<p class="text-sm text-gray-700"><b>环境效益 (年)：</b>替代 <b>${m.name}</b> 的环境效益最为显著，年碳减排量可达 <b>${A(m.co2Reduction)}</b> 吨CO₂，相当于植树约 <b>${$e(m.treesPlanted)}</b> 棵。</p>`}else n.length>0&&(d+=`<p class="text-sm text-gray-700"><b>环境效益 (年)：</b>根据当前参数，${c?"混合":"工业热泵"}方案相较于所选对比方案均无碳减排优势。</p>`);d+="</div>",u+=d,u+=`
        <div class="mt-8 space-y-2">
            <button id="toggle-details-btn" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">显示详细计算过程 (含公式)</button>
            <div id="calculation-details" class="hidden bg-white rounded-lg border text-sm space-y-4 mt-2"></div>
            
            <button id="toggle-risk-btn" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">显示投资风险及对策分析</button>
            <div id="risk-analysis-details" class="hidden bg-white rounded-lg border text-sm space-y-4 mt-2"></div>
            
            <button id="printReportBtn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition mt-4">打印本页报告 (A4)</button>
        </div>
    `,r.innerHTML=u}function qe(e){document.getElementById("calculation-details")&&(e.analysisMode==="bot"?We():Ue(e))}function De(e){const a=document.getElementById("risk-analysis-details");if(!a)return;let n='<div class="p-6 space-y-4">';e==="bot"?n+=`
            <h3 class="text-lg font-bold border-b pb-2 mb-4">BOT 模式投资风险及对策分析</h3>
            <h4 class="font-semibold text-gray-800">1. 财务与市场风险</h4>
            <ul class="list-disc list-inside text-sm space-y-2">
                <li><b>风险 (收入不及预期):</b> 客户用热量未达标，或能源销售单价（热价）低于预期，导致年销售收入无法实现。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 签订“照付不议”合同:</b> 与客户约定最低用热量，未达到也需按约定付费。<b>(2) 价格联动:</b> 合同中应包含能源价格（电价）与销售热价的联动条款。</li>
                <li><b>风险 (成本失控):</b> 能源价格（电价、天然气等）涨幅超过预期，或设备能效未达标导致能耗过高。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 成本锁定:</b> 尽可能签订长期能源供应合同。<b>(2) 敏感性分析:</b> 测算能源成本上涨对项目TIRR和EIRR的影响。</li>
            </ul>
        `:n+=`
            <h3 class="text-lg font-bold border-b pb-2 mb-4">工业热泵投资风险及对策分析 (成本对比)</h3>
            <h4 class="font-semibold text-gray-800">1. 政策与市场风险</h4>
            <ul class="list-disc list-inside text-sm space-y-2">
                <li><b>风险 (电价波动):</b> "峰谷尖"电价政策调整，尤其是谷电价格上涨或峰电涨幅不及预期，可能导致运行成本高于预期。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 精确评估:</b> 采用加权平均电价或分时电价模型进行精确测算。<b>(2) 敏感性分析:</b> 测算电价上涨对IRR和PBP的影响。<b>(3) 绿电合约:</b> 探索与发电企业签订长期购电协议 (PPA)。</li>
            </ul>
            <h4 class="font-semibold text-gray-800 mt-4">2. 技术与运行风险</h4>
            <ul class="list-disc list-inside text-sm space-y-2">
                <li><b>风险 (性能衰减/SPF不达标):</b> 全年综合能效系数(SPF)低于设计值，导致实际运行电耗过高。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 选型匹配:</b> 基于项目地最冷月平均工况进行主机选型。<b>(2) 耦合设计:</b> 采用“工业热泵 + 辅助热源”的耦合方案。<b>(3) 明确SPF:</b> 明确SPF的计算边界。</li>
            </ul>
            <h4 class="font-semibold text-gray-800 mt-4">3. 财务与LCC风险</h4>
            <ul class="list-disc list-inside text-sm space-y-2">
                 <li><b>风险 (LCC估算偏差):</b> 仅对比“第1年运行成本”，忽略了初始投资(CAPEX)和未来成本。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 采用LCC:</b> 坚持使用 LCC 作为决策依据。<b>(2) 考虑通胀:</b> 必须设置合理的“能源价格涨幅”和“运维成本涨幅”。</li>
            </ul>
        `,n+="</div>",a.innerHTML=n}function Ue(e){const a=document.getElementById("calculation-details");if(!a)return;const{isHybridMode:n,lccParams:o,hp:s,comparisons:t,inputs:r,hybridSystem:i,hybrid_aux:c}=e,{annualHeatingDemandKWh:l,weightedAvgElecPrice:f}=r;r.isGreenElectricity||r.gridFactor,r.isGreenElectricity;let u='<div class="p-4 md:p-6 space-y-6 text-xs">';if(u+=`
        <div>
            <h3 class="text-base font-bold border-b pb-2 mb-2">A. 核心经济指标计算方法与依据</h3>
            <div class="space-y-1 text-gray-600">
                <p><b>全寿命周期成本 (LCC):</b> LCC = CAPEX + NPV(Energy) + NPV(O&M) - NPV(Salvage)。</p>
                <p><b>净现值 (NPV):</b> NPV = (LCC_基准 - LCC_工业热泵)。NPV > 0 代表项目可行。</p>
                <p><b>内部收益率 (IRR):</b> 使项目净现值(NPV)等于零时的折现率。IRR > 基准折现率，代表项目优秀。</p>
            </div>
        </div>
    `,n){const d=(r.hybridLoadShare*100).toFixed(1),b=(100-parseFloat(d)).toFixed(1);u+=`
            <div>
                <h3 class="text-base font-bold border-b pb-2 mb-2">B. 本次项目详细计算过程 (混合模式)</h3>
                <p><b>年总制热量:</b> ${w(l,0)} kWh</p>
                <div class="mt-2 p-3 bg-blue-50 rounded-md space-y-1">
                    <h4 class="font-semibold text-blue-800">方案A: 混合系统 (总计)</h4>
                    <p>• 年总运行成本 (第1年): ${I(i.opex)} 万元</p>
                    <p>• 年总碳排放量: ${A(i.co2)} 吨 CO₂</p>
                    <p>• 产热成本: ${i.cost_per_kwh_heat.toFixed(4)} 元/kWh_热</p>
                </div>
                <div class="mt-2 p-3 bg-gray-50 rounded-md space-y-1">
                    <h4 class="font-semibold text-gray-700">混合系统 - 工业热泵部分 (${d}%)</h4>
                    <p>• 年能源成本: ${ue(s.energyCost)} 元</p>
                </div>
                <div class="mt-2 p-3 bg-gray-50 rounded-md space-y-1">
                    <h4 class="font-semibold text-gray-700">混合系统 - 辅助热源 (${c.name}, ${b}%)</h4>
                    <p>• 年能源消耗: ${w(c.consumption)} ${c.consumptionUnit}</p>
                    <p>• 年能源成本: ${ue(c.energyCost)} 元</p>
                </div>
            </div>
        `}else u+=`
            <div>
                <h3 class="text-base font-bold border-b pb-2 mb-2">B. 本次项目详细计算过程 (标准模式)</h3>
                 <p><b>年总制热量:</b> ${w(l,0)} kWh</p>
                 <div class="mt-2 p-3 bg-blue-50 rounded-md space-y-1">
                    <h4 class="font-semibold text-blue-800">方案A: 工业热泵</h4>
                    <p>• 年总电耗: ${w(s.energyCostDetails.totalElec,0)} kWh</p>
                    <p>• 年总运行成本: ${I(s.opex)} 万元</p>
                    <p>• 产热成本: ${s.cost_per_kwh_heat.toFixed(4)} 元/kWh_热</p>
                    <p>• 年碳排放量: ${A(s.co2)} 吨 CO₂</p>
                </div>
            </div>
        `;u+='<div class="space-y-4">',t.forEach(d=>{const b=e[d.key];u+=`
            <div class="pt-4 border-t">
                <h4 class="font-semibold text-gray-800">对比: ${n?i.name:"工业热泵"} vs ${d.name}</h4>
                <div class="text-gray-600 space-y-1 mt-1">
                    <p>• <b>基准 (${d.name}) 年消耗:</b> ${w(b.consumption,1)} ${b.consumptionUnit}</p>
                    <p>• <b>基准 (${d.name}) 年运行成本:</b> ${I(b.opex)} 万元</p>
                    <p class="font-semibold text-green-700">↳ 年节省总成本: ${I(d.opexSaving)} 万元</p>
                    <p class="font-semibold text-blue-800">↳ LCC 节省 (NPV): ${I(d.npv)} 万元</p>
                    <p class="font-semibold text-blue-800">↳ 内部收益率 (IRR): ${V(d.irr)}</p>
                </div>
            </div>
        `}),u+="</div></div>",a.innerHTML=u}function Je(e){const a=document.getElementById("print-report-container");if(!a)return;const{inputs:n,lccParams:o,comparisons:s,hp:t,isHybridMode:r,hybridSystem:i}=e,c=n.projectName||"未命名项目",l=new Date().toLocaleString("zh-CN");let f=`
        <div class="print-header">
            <h2>${c} 项目</h2>
            <h1>工业热泵经济与环境效益分析报告</h1>
            <p>报告日期: ${l}</p>
        </div>
        <div class="print-section">
            <h3>1. 核心输入参数</h3>
            <table class="print-table">
                <tr><td>项目名称</td><td>${c}</td></tr>
                <tr><td>年总制热量</td><td class="text-right">${w(n.annualHeatingDemandKWh,0)} kWh</td></tr>
                <tr><td>经济分析年限</td><td class="text-right">${o.lccYears} 年</td></tr>
                <tr><td>基准折现率</td><td class="text-right">${V(o.discountRate,1)}</td></tr>
            </table>
        </div>
        <div class="print-section">
            <h3>2. 方案静态对比 (第1年)</h3>
            <table class="print-table">
                <thead><tr><th>方案名称</th><th class="text-right">总投资(万)</th><th class="text-right">年运行成本(万)</th></tr></thead>
                <tbody>
                    <tr>
                        <td><strong>${r?i.name:"工业热泵方案"}</strong></td>
                        <td class="text-right"><strong>${I(r?i.lcc.capex:t.lcc.capex)}</strong></td>
                        <td class="text-right"><strong>${I(r?i.opex:t.opex)}</strong></td>
                    </tr>
    `;s.forEach(u=>{const d=e[u.key];f+=`<tr><td>${u.name}</td><td class="text-right">${I(d.lcc.capex)}</td><td class="text-right">${I(d.opex)}</td></tr>`}),f+=`
                </tbody>
            </table>
        </div>
        <div class="print-section">
            <h3>3. 核心经济与环境效益</h3>
            <table class="print-table">
                <thead><tr><th>对比项</th><th class="text-right">IRR</th><th class="text-right">动态PBP (年)</th><th class="text-right">年碳减排 (tCO₂)</th></tr></thead>
                <tbody>
    `,s.forEach(u=>{f+=`<tr><td>vs. ${u.name}</td><td class="text-right">${V(u.irr)}</td><td class="text-right">${X(u.dynamicPBP)}</td><td class="text-right">${A(u.co2Reduction)}</td></tr>`}),f+=`
                </tbody>
            </table>
        </div>
        <div class="print-footer"><p>报告由工业热泵经济与环境效益分析器 Pro 生成。</p></div>
    `,a.innerHTML=f}function We(e){const a=document.getElementById("calculation-details");a&&(a.innerHTML='<p class="p-4">BOT 模式的详细计算过程功能待添加。</p>')}function Ye(e){const{analysisMode:a}=e,n={lccYears:e.lccYears,discountRate:e.discountRate,energyInflationRate:e.energyInflationRate,opexInflationRate:e.opexInflationRate},{annualHeatingDemandKWh:o}=e;if(a==="bot")return je(e,n,e.botAnnualEnergyCost,e.botAnnualOpexCost);{const s=e.hpCop>0?o/e.hpCop:0;let t=0;const r={tiers:[]};e.priceTiers.forEach(c=>{const l=c.dist/100,f=s*l,u=f*c.price;t+=u,r.tiers.push({name:c.name,elec:f,price:c.price,cost:u})});let i=0;if(s>0)i=t/s;else if(e.priceTiers.length>0){let c=0;e.priceTiers.forEach(l=>{i+=l.price*l.dist,c+=l.dist}),c>0?i=i/c:e.priceTiers.length===1&&(i=e.priceTiers[0].price)}return Ge(e,n,i,t,r,o,a,s)}}function je(e,a,n,o){const{lccYears:s,discountRate:t,energyInflationRate:r,opexInflationRate:i}=a,c=e.hpHostCapex+e.hpStorageCapex,l=c*e.botEquityRatio,f=c-l,u=c*e.hpSalvageRate,d={years:[],revenue:[],vat:[],revenueNetVat:[],surtax:[],energyCost:[],opexCost:[],depreciation:[],interest:[],totalCost:[],profitBeforeTax:[],incomeTax:[],netProfit:[],cf_TotalInvestment:[],cf_Equity:[]},b=e.botDepreciationYears>0?f/e.botDepreciationYears:0;for(let p=1;p<=s;p++){d.years.push(p);const C=e.botAnnualRevenue,v=C/(1+e.botVatRate),L=C-v,R=L*e.botSurtaxRate,E=n*Math.pow(1+r,p-1),F=o*Math.pow(1+i,p-1),S=p<=e.botDepreciationYears?c*(1-e.hpSalvageRate)/e.botDepreciationYears:0;let k=0;p<=e.botDepreciationYears&&(k=(f-b*(p-1))*e.botLoanInterestRate);const q=E+F+S+k+R,O=v-q,H=Math.max(0,O)*e.botIncomeTaxRate,M=O-H;d.revenue.push(C),d.vat.push(L),d.revenueNetVat.push(v),d.surtax.push(R),d.energyCost.push(E),d.opexCost.push(F),d.depreciation.push(S),d.interest.push(k),d.totalCost.push(q),d.profitBeforeTax.push(O),d.incomeTax.push(H),d.netProfit.push(M);let D=(O+k)*(1-e.botIncomeTaxRate)+S,$=p<=e.botDepreciationYears?b:0,P=M+S-$;p===s&&(D+=u,P+=u),d.cf_TotalInvestment.push(D),d.cf_Equity.push(P)}const y=[-c,...d.cf_TotalInvestment],g=[-l,...d.cf_Equity],m={investment:c/1e4,equity:l/1e4,loan:f/1e4,irr:re(y),npv:Y(y,t)/1e4,pbp:de(y,t,s),equityIRR:re(g),equityNPV:Y(g,t)/1e4,equityPBP:de(g,t,s)},x=p=>p.reduce((C,v)=>C+v,0),h=p=>p.length>0?x(p)/p.length/1e4:0,B={revenue:h(d.revenue),vat:h(d.vat),revenueNetVat:h(d.revenueNetVat),surtax:h(d.surtax),energyCost:h(d.energyCost),opexCost:h(d.opexCost),depreciation:h(d.depreciation),interest:h(d.interest),totalCost:h(d.totalCost),profitBeforeTax:h(d.profitBeforeTax),incomeTax:h(d.incomeTax),netProfit:h(d.netProfit)};return{analysisMode:"bot",inputs:e,lccParams:a,botAnalysis:{summary:m,annualAvg:B,cashFlows:d}}}function Ge(e,a,n,o,s,t,r,i){const c={},{lccYears:l,discountRate:f,energyInflationRate:u,opexInflationRate:d,priceTiers:b,isHybridMode:y,gridFactor:g}=e;c.inputs=e,c.lccParams=a,c.isHybridMode=y,c.annualHeatingDemandKWh=t,c.weightedAvgElecPrice=n;const m=700;let x;const h=e.hpHostCapex+e.hpStorageCapex;if(y){const{hybridLoadShare:p,hybridAuxHeaterType:C,hybridAuxHeaterCapex:v,hybridAuxHeaterOpex:L}=e;c.hybridInputs={hybridLoadShare:p,hybridAuxHeaterType:C,hybridAuxHeaterCapex:v,hybridAuxHeaterOpex:L};const R=t*p,E=t*(1-p),F=e.hpCop>0?R/e.hpCop:0;let S=0;const k={tiers:[]};b.forEach(U=>{const se=U.dist/100,ee=F*se,te=ee*U.price;S+=te,k.tiers.push({name:U.name,elec:ee,price:U.price,cost:te})});const q=S+e.hpOpexCost,O=F*g,H=W(S,l,f,u),M=W(e.hpOpexCost,l,f,d),z=h*e.hpSalvageRate,K=z/Math.pow(1+f,l),D=h+H+M-K,$={isHybridPart:!0,name:"工业热泵 (混合)",energyCost:S,energyCostDetails:k,opexCost:e.hpOpexCost,opex:q,co2:O,lcc:{capex:h,capex_host:e.hpHostCapex,capex_storage:e.hpStorageCapex,energyNPV:H,opexNPV:M,salvageRate:e.hpSalvageRate,salvageNPV:K,salvageValue:z,total:D}};c.hp=$;const P=N(C,E,v,L,a,e,g,n);c.hybrid_aux=P;const _=t>0?t/m:0,Z={isHybrid:!0,name:"混合系统 (工业热泵 + "+P.name+")",energyCost:$.energyCost+P.energyCost,opexCost:$.opexCost+P.opexCost,opex:$.opex+P.opex,co2:$.co2+P.co2,cost_per_kwh_heat:t>0?($.energyCost+P.energyCost)/t:0,electricity_per_steam_ton:_>0?F/_:0,cost_per_steam_ton:_>0?($.energyCost+P.energyCost)/_:0,lcc:{capex:$.lcc.capex+P.lcc.capex,capex_host:$.lcc.capex_host,capex_storage:$.lcc.capex_storage,capex_aux:P.lcc.capex,energyNPV:$.lcc.energyNPV+P.lcc.energyNPV,opexNPV:$.lcc.opexNPV+P.lcc.opexNPV,salvageNPV:$.lcc.salvageNPV+P.lcc.salvageNPV,salvageValue:$.lcc.salvageValue+P.lcc.salvageValue,total:$.lcc.total+P.lcc.total}};c.hybridSystem=Z,x=Z}else{const p=o+e.hpOpexCost,C=i*g,v=W(o,l,f,u),L=W(e.hpOpexCost,l,f,d),R=h*e.hpSalvageRate,E=R/Math.pow(1+f,l),F=h+v+L-E,S=t>0?t/m:0,k={isHybrid:!1,name:"工业热泵系统",energyCost:o,energyCostDetails:s,opexCost:e.hpOpexCost,opex:p,co2:C,cost_per_kwh_heat:e.hpCop>0?n/e.hpCop:0,electricity_per_steam_ton:S>0?i/S:0,cost_per_steam_ton:S>0?o/S:0,lcc:{capex:h,capex_host:e.hpHostCapex,capex_storage:e.hpStorageCapex,energyNPV:v,opexNPV:L,salvageRate:e.hpSalvageRate,salvageNPV:E,salvageValue:R,total:F}};c.hp=k,x=k}const B=[];if(e.compare.gas){const p=N("gas",t,e.gasBoilerCapex,e.gasOpexCost,a,e,g,n);c.gas=p,B.push(p)}if(e.compare.fuel){const p=N("fuel",t,e.fuelBoilerCapex,e.fuelOpexCost,a,e,g,n);c.fuel=p,B.push(p)}if(e.compare.coal){const p=N("coal",t,e.coalBoilerCapex,e.coalOpexCost,a,e,g,n);c.coal=p,B.push(p)}if(e.compare.biomass){const p=N("biomass",t,e.biomassBoilerCapex,e.biomassOpexCost,a,e,g,n);c.biomass=p,B.push(p)}if(e.compare.electric){const p=N("electric",t,e.electricBoilerCapex,e.electricOpexCost,a,e,g,n);c.electric=p,B.push(p)}if(e.compare.steam){const p=N("steam",t,e.steamCapex,e.steamOpexCost,a,e,g,n);c.steam=p,B.push(p)}return c.comparisons=B.map(p=>{const C=p.energyCost-x.energyCost;let v=p.energyCost>0?C/p.energyCost:x.energyCost<=0?0:-1/0,L=null;x.cost_per_kwh_heat>0&&p.cost_per_kwh_heat>0&&(L=p.cost_per_kwh_heat/x.cost_per_kwh_heat);const R=x.lcc.capex-p.lcc.capex,E=p.opex-x.opex;let F="无法收回投资";E>0&&R>0?F=(R/E).toFixed(2)+" 年":R<=0&&E>0?F="无需额外投资":R<=0&&E<=0&&(F="无额外投资/无节省");let S=R>0&&E>0?E/R:null;const k=p.co2-x.co2,q=k>0?k/18.3:0,O=p.lcc.total-x.lcc.total,H=O,M=[];M.push(-R);for(let _=1;_<=l;_++){const Z=x.energyCost*Math.pow(1+u,_-1),U=p.energyCost*Math.pow(1+u,_-1),se=x.opexCost*Math.pow(1+d,_-1),ee=p.opexCost*Math.pow(1+d,_-1),te=U+ee-(Z+se);M.push(te)}const z=x.lcc.salvageValue,K=p.lcc.salvageValue,D=z-K;M[l]+=D;const $=re(M),P=de(M,f,l);return{key:p.key,name:p.name,opex:p.opex,opexSaving:E,investmentDiff:R,paybackPeriod:F,co2Reduction:k,treesPlanted:q,lcc:p.lcc.total,lccSaving:O,npv:H,irr:$,dynamicPBP:P,simpleROI:S,electricalPriceRatio:L,energyCostSaving:C,energyCostSavingRate:v,consumption:p.consumption,consumptionUnit:p.consumptionUnit}}),c.analysisMode=r,c}function N(e,a,n,o,s,t,r,i){const{lccYears:c,discountRate:l,energyInflationRate:f,opexInflationRate:u}=s,d=a*3.6;let b=0,y=0,g=0,m=0,x=0,h=0,B=0,p=0,C=0,v="未知",L=0,R=0,E="";switch(e){case"gas":v="天然气锅炉",C=t.gasSalvageRate,E="m³",t.gasBoilerEfficiency>0&&t.gasCalorific>0&&(g=d/t.gasBoilerEfficiency/t.gasCalorific,b=g*t.gasPrice,y=g*t.gasFactor,L=t.gasPrice/(t.gasCalorific/3.6*t.gasBoilerEfficiency));break;case"fuel":v="燃油锅炉",C=t.fuelSalvageRate,E="吨",t.fuelBoilerEfficiency>0&&t.fuelCalorific>0&&(g=d/t.fuelBoilerEfficiency/t.fuelCalorific/1e3,b=g*t.fuelPrice,y=g*t.fuelFactor,L=t.fuelPrice/1e3/(t.fuelCalorific/3.6*t.fuelBoilerEfficiency));break;case"coal":v="燃煤锅炉",C=t.coalSalvageRate,E="吨",t.coalBoilerEfficiency>0&&t.coalCalorific>0&&(g=d/t.coalBoilerEfficiency/t.coalCalorific/1e3,b=g*t.coalPrice,y=g*t.coalFactor,L=t.coalPrice/1e3/(t.coalCalorific/3.6*t.coalBoilerEfficiency));break;case"biomass":v="生物质锅炉",C=t.biomassSalvageRate,E="吨",t.biomassBoilerEfficiency>0&&t.biomassCalorific>0&&(g=d/t.biomassBoilerEfficiency/t.biomassCalorific/1e3,b=g*t.biomassPrice,y=g*t.biomassFactor,L=t.biomassPrice/1e3/(t.biomassCalorific/3.6*t.biomassBoilerEfficiency));break;case"electric":v="电锅炉",C=t.electricSalvageRate,E="kWh",t.electricBoilerEfficiency>0&&(g=a/t.electricBoilerEfficiency,b=g*i,y=g*r,L=i/t.electricBoilerEfficiency);break;case"steam":if(v="管网蒸汽",C=t.steamSalvageRate,E="吨",t.steamEfficiency>0&&t.steamCalorific>0){const F=a/t.steamEfficiency;g=F/t.steamCalorific,b=g*t.steamPrice,y=F*t.steamFactor,L=t.steamPrice/(t.steamCalorific*t.steamEfficiency)}break}return p=b+o,x=W(b,c,l,f),h=W(o,c,l,u),R=n*C,B=R/Math.pow(1+l,c),m=n+x+h-B,{key:e,name:v,energyCost:b,opexCost:o,opex:p,co2:y,consumption:g,consumptionUnit:E,cost_per_kwh_heat:L,lcc:{capex:n,energyNPV:x,opexNPV:h,salvageRate:C,salvageNPV:B,salvageValue:R,total:m}}}let me={},he=!1;function ze(){he&&(be(!0),Q("disabled","暂存当前工业热泵方案 (请先计算)"))}function Ke(){be(!1);const e=Pe(we,G);if(!e)return;const a=Ye(e);me=a,he=!0,Oe(!0),He(a),setTimeout(()=>{Xe(a)},0),a.analysisMode!=="bot"?Q("enabled"):Q("disabled","BOT 模式不支持暂存")}function Xe(e){const{inputs:a,comparisons:n,isHybridMode:o,analysisMode:s}=e,t=s==="bot"?e.hp:o?e.hybridSystem:e.hp,r=(i,c)=>{const l=document.getElementById(i);if(l){const f=l.cloneNode(!0);l.parentNode.replaceChild(f,l),f.addEventListener("click",c)}else console.warn(`Button with id '${i}' not found after calculation.`)};r("toggle-details-btn",i=>{const c=document.getElementById("calculation-details");if(!c)return;const l=!c.classList.contains("hidden");c.classList.toggle("hidden"),i.target.textContent=l?"显示详细计算过程 (含公式)":"隐藏详细计算过程 (含公式)",l||qe(me)}),r("toggle-risk-btn",i=>{const c=document.getElementById("risk-analysis-details");if(!c)return;const l=!c.classList.contains("hidden");c.classList.toggle("hidden"),i.target.textContent=l?"显示投资风险及对策分析":"隐藏投资风险及对策分析",l||De(s)}),r("printReportBtn",()=>{Je(me),window.print()}),r("saveScenarioBtn",()=>{const i=a.projectName||"未命名方案",c=a.hpCop;if(s==="bot"){G("BOT 模式的方案暂存功能正在开发中","info");return}if(t&&n&&n.length>0){const l=n.find(f=>f.key==="gas")||n[0];Te(i,t,c,l),Q("saved")}else t&&(!n||n.length===0)?G("无法暂存，因为没有勾选任何对比方案。","error"):G("无法暂存，计算数据不存在。","error")})}document.addEventListener("DOMContentLoaded",()=>{Fe(ze,G),_e(Ve,G);const e=document.getElementById("calculateBtn");if(e)e.addEventListener("click",Ke);else{console.error("FATAL: Main 'calculateBtn' not found. Application cannot start.");const a=document.querySelector(".container");a&&(a.innerHTML='<div class="text-center p-8 bg-red-100 text-red-700 rounded-lg"><strong>严重错误:</strong> 无法找到核心计算按钮。页面无法正常工作。</div>')}Me()});
