(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const t of s)if(t.type==="childList")for(const i of t.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const t={};return s.integrity&&(t.integrity=s.integrity),s.referrerPolicy&&(t.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?t.credentials="include":s.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function o(s){if(s.ep)return;s.ep=!0;const t=n(s);fetch(s.href,t)}})();const xe={diesel:{price:8900,calorific:42.6,factor:3090,priceTooltip:"<b>默认值: 8900 元/吨</b><br>参考国内0号柴油市场价格及密度（约0.84kg/L）折算。",calorificTooltip:"<b>默认值: 42.6 MJ/kg</b><br>国标中0号柴油的典型低位发热量参考值。",factorTooltip:"<b>默认值: 3090 kgCO₂/吨</b><br>参考《省级温室气体清单编制指南》中柴油的排放因子。"},heavy_oil:{price:6500,calorific:41.8,factor:3170,priceTooltip:"<b>默认值: 6500 元/吨</b><br>参考国内燃料油（重油）市场平均价格。",calorificTooltip:"<b>默认值: 41.8 MJ/kg</b><br>国标中燃料油（5-7号）的典型低位发热量参考值。",factorTooltip:"<b>默认值: 3170 kgCO₂/吨</b><br>参考《省级温室气体清单编制指南》中燃料油的排放因子。"},residual_oil:{price:5500,calorific:40.2,factor:3250,priceTooltip:"<b>默认值: 5500 元/吨</b><br>参考国内渣油市场平均价格。",calorificTooltip:"<b>默认值: 40.2 MJ/kg</b><br>国标中渣油的典型低位发热量参考值。",factorTooltip:"<b>默认值: 3250 kgCO₂/吨</b><br>参考《省级温室气体清单编制指南》中渣油的排放因子。"}},ee=.004184,ne=860.42,ye=[{selectId:"heatingLoadUnit",inputId:"heatingLoad",conversions:{kW:1,"kcal/h":ne}},{selectId:"annualHeatingUnit",inputId:"annualHeating",conversions:{kWh:1,KJ:3600,MJ:3.6,GJ:.0036,TJ:36e-7,万大卡:ne/1e4,Mkcal:ne/1e6}},{selectId:"gridFactorUnit",inputId:"gridFactor",conversions:{"kgCO2/kWh":1,"tCO2/MWh":1}},{selectId:"steamFactorUnit",inputId:"steamFactor",conversions:{"kgCO2/kWh":1,"tCO2/MWh":1,"kgCO2/GJ":1/(3.6/1e3)}},{selectId:"gasFactorUnit",inputId:"gasFactor",dynamicConversions:()=>({"kgCO2/m3":1,"kgCO2/GJ":1/((parseFloat(document.getElementById("gasCalorific").dataset.baseValue)||35.57)/1e3)})},{selectId:"fuelFactorUnit",inputId:"fuelFactor",dynamicConversions:()=>{const e=parseFloat(document.getElementById("fuelCalorific").dataset.baseValue)||42.6;return{"kgCO2/t":1,"kgCO2/kg":1/1e3,"kgCO2/GJ":1e3/e}}},{selectId:"coalFactorUnit",inputId:"coalFactor",dynamicConversions:()=>{const e=parseFloat(document.getElementById("coalCalorific").dataset.baseValue)||29.3;return{"kgCO2/t":1,"kgCO2/kg":1/1e3,"kgCO2/GJ":1e3/e}}},{selectId:"biomassFactorUnit",inputId:"biomassFactor",dynamicConversions:()=>{const e=parseFloat(document.getElementById("biomassCalorific").dataset.baseValue)||16.32;return{"kgCO2/t":1,"kgCO2/kg":1/1e3,"kgCO2/GJ":1e3/e}}},{selectId:"gasCalorificUnit",inputId:"gasCalorific",conversions:{"MJ/m3":1,"kWh/m3":1/3.6,"GJ/m3":1/1e3,"kcal/m3":1/ee}},{selectId:"fuelCalorificUnit",inputId:"fuelCalorific",conversions:{"MJ/kg":1,"GJ/t":1,"kWh/kg":1/3.6,"kcal/kg":1/ee}},{selectId:"coalCalorificUnit",inputId:"coalCalorific",conversions:{"MJ/kg":1,"GJ/t":1,"kWh/kg":1/3.6,"kcal/kg":1/ee}},{selectId:"biomassCalorificUnit",inputId:"biomassCalorific",conversions:{"MJ/kg":1,"kcal/kg":1/ee,"GJ/t":1,"kWh/kg":1/3.6}},{selectId:"steamCalorificUnit",inputId:"steamCalorific",conversions:{"kWh/t":1,"GJ/t":3.6/1}}];let se="3.0",pe="4.0",ge="3.5",J="standard";function ve(){ye.forEach(a=>{const n=document.getElementById(a.selectId),o=document.getElementById(a.inputId);!n||!o||n.addEventListener("change",()=>{const s=a.dynamicConversions?a.dynamicConversions():a.conversions;o.dataset.baseValue===void 0&&(o.dataset.baseValue=o.value);const t=parseFloat(o.dataset.baseValue),i=n.value;if(t===0){o.value=0;return}const l=s[i];if(l==null){console.error("Missing conversion factor for",a.inputId,"to unit",i);return}let c=3;i.includes("/t")&&a.inputId.includes("Calorific")&&(c=1),i.includes("/kg")&&a.inputId.includes("Calorific")&&(c=3),i.includes("GJ/")&&(c=5),i.includes("kcal/kg")&&(c=0),i.includes("kcal/m3")&&(c=0),i.includes("kcal/h")&&(c=0),o.value=(t*l).toFixed(c)})});const e=document.getElementById("biomassCalorificUnit");e&&(e.value="kcal/kg",e.dispatchEvent(new Event("change")))}function Ce(){const e=document.querySelectorAll(".comparison-toggle"),a=n=>{const o=n.dataset.target;if(!o)return;const s=n.checked;document.querySelectorAll(`.related-to-${o}`).forEach(i=>{s?i.classList.remove("hidden"):i.classList.add("hidden")})};e.forEach(n=>{a(n),n.addEventListener("change",()=>a(n))})}function Be(e,a){const n=document.getElementById("modeStandard"),o=document.getElementById("modeHybrid"),s=document.getElementById("modeBot"),t=document.getElementById("hybridConfigInputs"),i=document.getElementById("botConfigInputs"),l=document.getElementById("comparisonTogglesContainer"),c=document.getElementById("standardModeSections"),r=document.getElementById("lccParamsContainer"),g=document.getElementById("hpCopLabel"),m=document.getElementById("hpCop"),d=document.getElementById("section2Title"),b=document.getElementById("section7Title"),f=document.getElementById("calcModeAContainer"),p=document.getElementById("calcModeBContainer"),u=document.getElementById("calcModeCContainer"),x=document.querySelectorAll('input[name="calcMode"]');if(!n||!o||!s||!t||!i||!l||!c||!r){console.error("V11.0 (模式选择) UI 元素未在 HTML 中完全找到。");return}const h=v=>{const y=m.value;if(J==="standard"?se=y:J==="hybrid"?pe=y:J==="bot"&&(ge=y),v==="standard"||v==="hybrid"){t.classList.toggle("hidden",v==="standard"),i.classList.add("hidden"),l.classList.remove("hidden"),c.classList.remove("hidden"),r.classList.remove("hidden"),x.forEach(S=>S.disabled=!1);const C=document.querySelector('input[name="calcMode"]:checked');C&&C.dispatchEvent(new Event("change")),v==="standard"?(g.textContent="全年综合性能系数 (SPF)",m.value=se):(g.textContent="工业热泵在此工况下的 SPF",m.value=pe),d.textContent="2. 方案配置",b.textContent="7. 财务分析参数"}else v==="bot"&&(t.classList.add("hidden"),i.classList.remove("hidden"),l.classList.add("hidden"),c.classList.add("hidden"),r.classList.remove("hidden"),f&&f.classList.add("hidden"),p&&p.classList.add("hidden"),u&&u.classList.add("hidden"),x.forEach(C=>C.disabled=!0),g.textContent="BOT 项目 SPF (用于计算电费成本)",m.value=ge,d.textContent="2. 方案与投资配置",b.textContent="7. BOT 财务分析参数");J=v;const I=v==="standard"?"3.0":v==="hybrid"?"4.0":"3.5";m.classList.toggle("default-param",m.value===I),e()};n.addEventListener("change",()=>{n.checked&&h("standard")}),o.addEventListener("change",()=>{o.checked&&h("hybrid")}),s.addEventListener("change",()=>{s.checked&&(a&&a("模式三 (BOT 模式) 正在升级中，暂不开放。","info",4e3),J==="standard"?n.checked=!0:J==="hybrid"?o.checked=!0:n.checked=!0)}),m.value=se,h("standard")}function Ee(e){var l;const a=document.querySelectorAll('input[name="calcMode"]'),n=document.getElementById("calcModeAContainer"),o=document.getElementById("calcModeBContainer"),s=document.getElementById("calcModeCContainer"),t=(l=document.getElementById("operatingHours"))==null?void 0:l.parentElement;if(!n||!o||!s||!t||a.length===0){console.error("年加热量计算模式的 UI 元素未完全找到。");return}const i=()=>{const c=document.querySelector('input[name="calcMode"]:checked');if(!c)return;const r=c.value;r==="annual"?(n.classList.remove("hidden"),o.classList.add("hidden"),s.classList.add("hidden"),t.classList.remove("hidden")):r==="total"?(n.classList.add("hidden"),o.classList.remove("hidden"),s.classList.add("hidden")):r==="daily"&&(n.classList.remove("hidden"),o.classList.add("hidden"),s.classList.remove("hidden"),t.classList.add("hidden")),e()};a.forEach(c=>{c.addEventListener("change",i)}),i()}function fe(e="",a="",n="",o,s){const t=document.getElementById("priceTiersContainer");if(!t){console.error("priceTiersContainer 未找到!");return}const i=`tier-${Date.now()}-${Math.floor(Math.random()*1e3)}`,l=document.createElement("div");l.className="price-tier-entry grid grid-cols-1 md:grid-cols-10 gap-2 items-center",l.id=i,l.innerHTML=`
        <div class="md:col-span-3">
            <label for="${i}-name" class="block text-xs font-medium text-gray-600 mb-1">时段名称 (可选)</label>
            <input type="text" id="${i}-name" value="${e}" placeholder="例如: 峰时" class="tier-name w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm track-change storage-mode-field">
        </div>
        <div class="md:col-span-3">
            <label for="${i}-price" class="block text-xs font-medium text-gray-600 mb-1">电价 (元/kWh)</label>
            <input type="number" id="${i}-price" value="${a}" placeholder="例如: 1.2" class="tier-price w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm track-change storage-mode-field">
        </div>
        <div class="md:col-span-3">
            <label for="${i}-dist" class="block text-xs font-medium text-gray-600 mb-1">运行比例 (%)</label>
            <input type="number" id="${i}-dist" value="${n}" placeholder="例如: 40" class="tier-dist w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm track-change storage-mode-field">
        </div>
        <div class="md:col-span-1 flex items-end h-full">
            <button class="removePriceTierBtn w-full text-sm bg-red-100 text-red-700 font-semibold py-2 px-3 rounded-lg hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-300 mt-5 md:mt-0">
                删除
            </button>
        </div>
    `,t.appendChild(l),l.querySelectorAll("input.track-change").forEach(c=>{c.dataset.defaultValue=c.value,c.addEventListener("input",r=>{const g=r.target,m=g.dataset.defaultValue;(g.classList.contains("default-param")||m!==void 0)&&g.classList.toggle("default-param",g.value===m),g.classList.contains("track-change")&&o()})}),l.querySelector(".removePriceTierBtn").addEventListener("click",()=>{document.querySelectorAll(".price-tier-entry").length>1?(l.remove(),o()):s?s("必须至少保留一个电价时段。","error"):alert("必须至少保留一个电价时段。")})}function Ie(e,a){const n=document.getElementById("addPriceTierBtn");n&&(n.addEventListener("click",()=>{fe("","","",e,a),e()}),fe("平均电价","0.7","100",e,a),document.querySelectorAll(".price-tier-entry").forEach(o=>{o.querySelectorAll("input").forEach(s=>{s.value&&s.classList.add("default-param")})}))}function Le(){const e=document.getElementById("greenElectricityToggle"),a=document.getElementById("gridFactor"),n=document.getElementById("gridFactorUnit");!e||!a||!n||e.addEventListener("change",()=>{if(e.checked)a.value="0",a.dataset.baseValue="0",a.disabled=!0,n.disabled=!0,a.classList.remove("default-param");else{const o=a.getAttribute("data-base-value")||"0.57";a.dataset.baseValue=o,n.value="kgCO2/kWh",n.dispatchEvent(new Event("change")),a.disabled=!1,n.disabled=!1,a.classList.add("default-param"),a.dataset.defaultValue=a.value}})}function Fe(){const e=document.getElementById("fuelType");if(!e)return;const a=document.getElementById("fuelPrice"),n=document.getElementById("fuelCalorific"),o=document.getElementById("fuelFactor"),s=document.getElementById("fuelPriceTooltip"),t=document.getElementById("fuelCalorificTooltip"),i=document.getElementById("fuelFactorTooltip"),l=document.getElementById("fuelCalorificUnit"),c=document.getElementById("fuelFactorUnit");e.addEventListener("change",r=>{const g=r.target.value,m=xe[g];m&&(a.dataset.baseValue=m.price,n.dataset.baseValue=m.calorific,o.dataset.baseValue=m.factor,a.value=m.price,a.dataset.defaultValue=m.price,a.classList.add("default-param"),s&&(s.innerHTML=m.priceTooltip),t&&(t.innerHTML=m.calorificTooltip),i&&(i.innerHTML=m.factorTooltip),l.value="MJ/kg",l.dispatchEvent(new Event("change")),n.dataset.defaultValue=n.value,n.classList.add("default-param"),c.value="kgCO2/t",c.dispatchEvent(new Event("change")),o.dataset.defaultValue=o.value,o.classList.add("default-param"))})}function Pe(e,a){ve(),Ce(),Le(),Fe(),Ie(e,a),Be(e,a),Ee(e),document.querySelectorAll('input[type="number"], input[type="checkbox"], select, input[type="text"], input[type="radio"]').forEach(o=>{let s;o.type==="checkbox"?s=o.checked:s=o.value,(o.id==="heatingLoad"||o.id==="annualHeating"||o.id.endsWith("Calorific")||o.id.endsWith("Factor"))&&o.dataset.baseValue===void 0&&(o.dataset.baseValue=o.value),o.dataset.defaultValue=s;const t=i=>{const l=i.target;let c=l.dataset.defaultValue,r=l.value;l.type==="checkbox"&&(r=l.checked,c=c==="true"),(l.classList.contains("default-param")||c!==void 0)&&l.classList.toggle("default-param",r===c),l.parentElement;const g=document.getElementById(l.id+"Unit");if(g&&g.id.includes("Unit")){const m=parseFloat(l.value);if(isNaN(m)){const u=l.getAttribute("data-base-value");l.dataset.baseValue=u,l.classList.contains("track-change")&&e();return}const d=g.value,b=ye.find(u=>u.inputId===l.id);if(!b)return;const p=(b.dynamicConversions?b.dynamicConversions():b.conversions)[d];if(m===0)l.dataset.baseValue=0;else if(p&&p!==0){const u=m/p;l.dataset.baseValue=u}}l.classList.contains("track-change")&&e()};o.tagName==="SELECT"||o.type==="checkbox"||o.type==="radio"?o.addEventListener("change",t):o.addEventListener("input",t)})}function Re(e,a){const n=[];let o=0;document.querySelectorAll(".price-tier-entry").forEach(p=>{const u=p.querySelector(".tier-name").value.trim()||"时段",x=parseFloat(p.querySelector(".tier-price").value)||0,h=parseFloat(p.querySelector(".tier-dist").value)||0;o+=h,n.push({name:u,price:x,dist:h})});const s=document.querySelector('input[name="schemeAMode"]:checked').value||"standard";if(s!=="bot"){if(Math.abs(o-100)>.1)return e(`电价时段总比例必须为 100%，当前为 ${o.toFixed(1)}%！`),null;if(n.some(p=>p.price<=0||p.dist<=0))return e("电价或运行比例必须大于 0！"),null}e(null);const t=document.querySelector('input[name="calcMode"]:checked'),i=t?t.value:"annual",l=parseFloat(document.getElementById("heatingLoad").dataset.baseValue)||0,c=parseFloat(document.getElementById("operatingHours").value)||0,r=parseFloat(document.getElementById("annualHeating").dataset.baseValue)||0,g=parseFloat(document.getElementById("dailyHours").value)||0,m=parseFloat(document.getElementById("annualDays").value)||0,d=(parseFloat(document.getElementById("loadFactor").value)||0)/100;let b=0;i==="annual"?b=l*c:i==="total"?b=r:i==="daily"&&(b=l*g*m*d);const f={analysisMode:s,isHybridMode:s==="hybrid",lccYears:parseInt(document.getElementById("lccYears").value)||15,discountRate:(parseFloat(document.getElementById("discountRate").value)||8)/100,energyInflationRate:(parseFloat(document.getElementById("energyInflationRate").value)||3)/100,opexInflationRate:(parseFloat(document.getElementById("opexInflationRate").value)||5)/100,isGreenElectricity:document.getElementById("greenElectricityToggle").checked,priceTiers:n,projectName:document.getElementById("projectName").value,heatingLoad:l,operatingHours:c,annualHeating:r,dailyHours:g,annualDays:m,loadFactor:d,annualHeatingDemandKWh:b,hpHostCapex:parseFloat(document.getElementById("hpCapex").value)*1e4||0,hpStorageCapex:parseFloat(document.getElementById("storageCapex").value)*1e4||0,hpSalvageRate:(parseFloat(document.getElementById("hpSalvageRate").value)||0)/100,gasBoilerCapex:parseFloat(document.getElementById("gasBoilerCapex").value)*1e4||0,gasSalvageRate:(parseFloat(document.getElementById("gasSalvageRate").value)||0)/100,fuelBoilerCapex:parseFloat(document.getElementById("fuelBoilerCapex").value)*1e4||0,fuelSalvageRate:(parseFloat(document.getElementById("fuelSalvageRate").value)||0)/100,coalBoilerCapex:parseFloat(document.getElementById("coalBoilerCapex").value)*1e4||0,coalSalvageRate:(parseFloat(document.getElementById("coalSalvageRate").value)||0)/100,biomassBoilerCapex:parseFloat(document.getElementById("biomassBoilerCapex").value)*1e4||0,biomassSalvageRate:(parseFloat(document.getElementById("biomassSalvageRate").value)||0)/100,electricBoilerCapex:parseFloat(document.getElementById("electricBoilerCapex").value)*1e4||0,electricSalvageRate:(parseFloat(document.getElementById("electricSalvageRate").value)||0)/100,steamCapex:parseFloat(document.getElementById("steamCapex").value)*1e4||0,steamSalvageRate:(parseFloat(document.getElementById("steamSalvageRate").value)||0)/100,hpCop:parseFloat(document.getElementById("hpCop").value)||0,gasBoilerEfficiency:parseFloat(document.getElementById("gasBoilerEfficiency").value)/100||0,fuelBoilerEfficiency:parseFloat(document.getElementById("fuelBoilerEfficiency").value)/100||0,coalBoilerEfficiency:parseFloat(document.getElementById("coalBoilerEfficiency").value)/100||0,biomassBoilerEfficiency:parseFloat(document.getElementById("biomassBoilerEfficiency").value)/100||0,electricBoilerEfficiency:parseFloat(document.getElementById("electricBoilerEfficiency").value)/100||0,steamEfficiency:parseFloat(document.getElementById("steamEfficiency").value)/100||0,gasPrice:parseFloat(document.getElementById("gasPrice").value)||0,fuelPrice:parseFloat(document.getElementById("fuelPrice").value)||0,coalPrice:parseFloat(document.getElementById("coalPrice").value)||0,biomassPrice:parseFloat(document.getElementById("biomassPrice").value)||0,steamPrice:parseFloat(document.getElementById("steamPrice").value)||0,gridFactor:document.getElementById("greenElectricityToggle").checked?0:parseFloat(document.getElementById("gridFactor").dataset.baseValue)||0,gasFactor:parseFloat(document.getElementById("gasFactor").dataset.baseValue)||0,fuelFactor:parseFloat(document.getElementById("fuelFactor").dataset.baseValue)||0,coalFactor:parseFloat(document.getElementById("coalFactor").dataset.baseValue)||0,biomassFactor:parseFloat(document.getElementById("biomassFactor").dataset.baseValue),steamFactor:parseFloat(document.getElementById("steamFactor").dataset.baseValue)||0,gasCalorific:parseFloat(document.getElementById("gasCalorific").dataset.baseValue)||0,fuelCalorific:parseFloat(document.getElementById("fuelCalorific").dataset.baseValue)||0,coalCalorific:parseFloat(document.getElementById("coalCalorific").dataset.baseValue)||0,biomassCalorific:parseFloat(document.getElementById("biomassCalorific").dataset.baseValue)||0,steamCalorific:parseFloat(document.getElementById("steamCalorific").dataset.baseValue)||0,hpOpexCost:(parseFloat(document.getElementById("hpOpexCost").value)||0)*1e4,gasOpexCost:(parseFloat(document.getElementById("gasOpexCost").value)||0)*1e4,fuelOpexCost:(parseFloat(document.getElementById("fuelOpexCost").value)||0)*1e4,coalOpexCost:(parseFloat(document.getElementById("coalOpexCost").value)||0)*1e4,biomassOpexCost:(parseFloat(document.getElementById("biomassOpexCost").value)||0)*1e4,electricOpexCost:(parseFloat(document.getElementById("electricOpexCost").value)||0)*1e4,steamOpexCost:(parseFloat(document.getElementById("steamOpexCost").value)||0)*1e4,hybridLoadShare:(parseFloat(document.getElementById("hybridLoadShare").value)||0)/100,hybridAuxHeaterType:document.getElementById("hybridAuxHeaterType").value,hybridAuxHeaterCapex:(parseFloat(document.getElementById("hybridAuxHeaterCapex").value)||0)*1e4,hybridAuxHeaterOpex:(parseFloat(document.getElementById("hybridAuxHeaterOpex").value)||0)*1e4,botAnnualRevenue:(parseFloat(document.getElementById("botAnnualRevenue").value)||0)*1e4,botAnnualEnergyCost:(parseFloat(document.getElementById("botAnnualEnergyCost").value)||0)*1e4,botAnnualOpexCost:(parseFloat(document.getElementById("botAnnualOpexCost").value)||0)*1e4,botEquityRatio:(parseFloat(document.getElementById("botEquityRatio").value)||0)/100,botLoanInterestRate:(parseFloat(document.getElementById("botLoanInterestRate").value)||0)/100,botDepreciationYears:parseInt(document.getElementById("botDepreciationYears").value)||10,botVatRate:(parseFloat(document.getElementById("botVatRate").value)||0)/100,botSurtaxRate:(parseFloat(document.getElementById("botSurtaxRate").value)||0)/100,botIncomeTaxRate:(parseFloat(document.getElementById("botIncomeTaxRate").value)||0)/100,compare:{gas:document.getElementById("compare_gas").checked,fuel:document.getElementById("compare_fuel").checked,coal:document.getElementById("compare_coal").checked,biomass:document.getElementById("compare_biomass").checked,electric:document.getElementById("compare_electric").checked,steam:document.getElementById("compare_steam").checked}};if(s!=="bot"){if(b<=0||!f.hpCop)return a?a("成本对比模式: 请确保最终的“年总加热量”大于 0，并已填写工业热泵SPF。","error"):alert("成本对比模式: 请确保最终的“年总加热量”大于 0，并已填写工业热泵SPF。"),null}else if(f.botAnnualRevenue===0||f.botAnnualEnergyCost===0)return a?a("BOT模式: “年销售收入”和“年能源成本”必须大于0。","error"):alert("BOT模式: “年销售收入”和“年能源成本”必须大于0。"),null;return f}function Y(e,a,n,o){let s=0;for(let t=1;t<=a;t++){const l=e*Math.pow(1+o,t-1)/Math.pow(1+n,t);s+=l}return s}function j(e,a){let n=0;for(let o=0;o<e.length;o++)n+=e[o]/Math.pow(1+a,o);return n}function le(e,a=100,n=1e-6){if(e.length===0||e[0]>=0){const r=e.slice(1).reduce((g,m)=>g+m,0);return e[0]<0||r>0?1/0:null}let o=-.99,s=5,t,i;const l=j(e,0),c=j(e,s);if(l<0)c<l&&(s=0);else if(c>0&&(o=s,s=20,j(e,s)>0))return 1/0;for(let r=0;r<a;r++){if(t=(o+s)/2,i=j(e,t),Math.abs(i)<n)return t;i>0?o=t:s=t}return null}function ie(e,a,n){const o=-e[0];if(o<=0)return 0;let s=0;for(let t=1;t<=n&&!(t>=e.length);t++){const i=e[t]/Math.pow(1+a,t);if(!(i<=0&&s<o)&&s<o){const l=s;if(s+=i,s>=o){const c=o-l;if(i===0){if(c===0)return t-1;continue}return t-1+c/i}}}return null}const B=e=>(e/1e4).toFixed(2),A=e=>(e/1e3).toFixed(2),ke=e=>e.toFixed(2),_=(e,a=1)=>e===null||!isFinite(e)?"N/A":`${(e*100).toFixed(a)} %`,Q=e=>e===null||!isFinite(e)?"无法回收":`${e.toFixed(2)} 年`,O=(e,a=1)=>e===null||!isFinite(e)||e===0?"N/A":e.toLocaleString(void 0,{minimumFractionDigits:a,maximumFractionDigits:a}),Se=e=>e.toLocaleString(void 0,{maximumFractionDigits:0}),re=e=>e.toLocaleString(void 0,{maximumFractionDigits:0});let T=[],W=[];function ae(){var c;const e=document.getElementById("scenario-comparison-container"),a=document.getElementById("scenario-table-wrapper"),n=(c=document.getElementById("scenario-comparison-table"))==null?void 0:c.querySelector("tbody"),o=document.getElementById("scenario-summary"),s=document.getElementById("enableScenarioComparison"),t=document.getElementById("clearScenariosBtn"),i=document.getElementById("undoClearBtn");if(!e||!s||!n)return;if(!s.checked){e.classList.add("hidden");return}if(e.classList.remove("hidden"),T.length===0){a&&a.classList.add("hidden"),o&&o.classList.add("hidden"),W.length>0?(t&&t.classList.add("hidden"),i&&i.classList.remove("hidden")):(t&&t.classList.add("hidden"),i&&i.classList.add("hidden"));return}a&&a.classList.remove("hidden"),o&&o.classList.remove("hidden"),t&&t.classList.remove("hidden"),i&&i.classList.add("hidden"),n.innerHTML="",o&&(o.innerHTML="");const l=Math.min(...T.map(r=>r.lcc));if(T.forEach((r,g)=>{const m=r.lcc===l,d=document.createElement("tr");d.className=m?"bg-green-50":"",d.innerHTML=`
            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium ${m?"text-green-900":"text-gray-900"}">${r.name}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${B(r.totalCapex)}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${B(r.hpCapex)}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${B(r.storageCapex)}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${ke(r.hpCop)}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${B(r.opex)}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm ${m?"font-bold text-green-700":"text-gray-700"}">${B(r.lcc)} ${m?" (LCC最优)":""}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${r.baselineName}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-blue-700">${Q(r.dynamicPBP)}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-blue-700">${_(r.irr)}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-green-700">${A(r.co2)}</td>
        `,n.appendChild(d)}),T.length>0&&o){let r='<h4 class="text-lg font-semibold text-indigo-900 mb-2">对比总结</h4>';const g=T.reduce((f,p)=>f.lcc<p.lcc?f:p);r+=`<p>• <b>LCC (全寿命周期成本) 最优:</b> 方案 "<b>${g.name}</b>"，总成本为 <b>${B(g.lcc)} 万元</b>。</p>`;const m=T.filter(f=>f.irr!==null&&isFinite(f.irr));if(m.length>0){const f=m.reduce((p,u)=>p.irr>u.irr?p:u);r+=`<p>• <b>IRR (内部收益率) 最高:</b> 方案 "<b>${f.name}</b>"，IRR 高达 <b>${_(f.irr)}</b> (对比${f.baselineName})。</p>`}else r+="<p>• <b>IRR (内部收益率):</b> 无有效IRR数据可供对比 (可能均无额外投资或无法回收)。</p>";const d=T.filter(f=>f.dynamicPBP!==null&&isFinite(f.dynamicPBP));if(d.length>0){const f=d.reduce((p,u)=>p.dynamicPBP<u.dynamicPBP?p:u);r+=`<p>• <b>PBP (动态回收期) 最短:</b> 方案 "<b>${f.name}</b>"，回收期仅 <b>${Q(f.dynamicPBP)}</b> (对比${f.baselineName})。</p>`}else r+="<p>• <b>PBP (动态回收期):</b> 无有效PBP数据可供对比 (可能均无法回收)。</p>";const b=T.reduce((f,p)=>f.co2<p.co2?f:p);r+=`<p>• <b>碳排放最低:</b> 方案 "<b>${b.name}</b>"，年排放仅 <b>${A(b.co2)} 吨CO₂</b>。</p>`,o.innerHTML=r}}function $e(){const e=document.getElementById("enableScenarioComparison"),a=document.getElementById("saveScenarioBtn"),n=document.getElementById("scenario-comparison-container");!e||!a||!n||e.addEventListener("change",()=>{e.checked?(a.classList.remove("hidden"),ae()):(a.classList.add("hidden"),n.classList.add("hidden"))})}function Te(e,a,n,o){const s=a.isHybrid||!1;let t=e;s&&!t.includes("(混合)")&&(t+=" (混合)");let i=1;for(;T.some(c=>c.name===t);)t=`${e} ${s?"(混合)":""} (${i++})`;const l={name:t,lcc:a.lcc.total,opex:a.opex,co2:a.co2,hpCapex:a.lcc.capex_host,storageCapex:a.lcc.capex_storage,totalCapex:a.lcc.capex,hpCop:n,baselineName:o?o.name:"无对比",dynamicPBP:o?o.dynamicPBP:null,irr:o?o.irr:null};T.push(l),ae(),W=[]}function _e(e,a){const n=document.getElementById("clearScenariosBtn"),o=document.getElementById("undoClearBtn");n?n.addEventListener("click",async()=>{if(T.length===0){a&&a("方案列表已经为空。","info");return}await e("确认清空列表",'确定要清空所有已暂存的方案吗？您可以通过 "恢复列表" 按钮撤销此操作。')&&(W=[...T],T=[],ae(),a&&a("方案列表已清空。","success"))}):console.warn("'clearScenariosBtn' not found."),o?o.addEventListener("click",()=>{W.length!==0&&(T=[...W],W=[],ae(),a&&a("已恢复上次清空的列表。","success"))}):console.warn("'undoClearBtn' not found."),$e()}let ce=null;function G(e,a="info",n=3e3){const o=document.getElementById("global-notifier"),s=document.getElementById("global-notifier-text"),t=document.getElementById("global-notifier-icon-success"),i=document.getElementById("global-notifier-icon-error");!o||!s||!t||!i||(ce&&clearTimeout(ce),s.textContent=e,o.className="fixed top-5 right-5 z-50 max-w-sm p-4 rounded-lg shadow-lg flex items-center transition-opacity transition-transform duration-300",t.classList.add("hidden"),i.classList.add("hidden"),a==="success"?(o.classList.add("bg-green-100","text-green-800"),t.classList.remove("hidden")):a==="error"?(o.classList.add("bg-red-100","text-red-800"),i.classList.remove("hidden")):(o.classList.add("bg-blue-100","text-blue-800"),t.classList.remove("hidden")),o.classList.remove("hidden","opacity-0","translate-x-full"),ce=setTimeout(()=>{o.classList.add("opacity-0","translate-x-full"),setTimeout(()=>o.classList.add("hidden"),300)},n))}let te=null;function Ve(e,a){const n=document.getElementById("confirm-modal"),o=document.getElementById("confirm-modal-title"),s=document.getElementById("confirm-modal-message");return!n||!o||!s?Promise.resolve(!1):(o.textContent=e,s.textContent=a,n.classList.remove("hidden"),new Promise(t=>{te=t}))}function Me(){const e=document.getElementById("confirm-modal"),a=document.getElementById("confirm-modal-ok-btn"),n=document.getElementById("confirm-modal-cancel-btn");if(!e||!a||!n)return;const o=s=>{e.classList.add("hidden"),te&&(te(s),te=null)};a.addEventListener("click",()=>o(!0)),n.addEventListener("click",()=>o(!1))}function be(e){var a,n;(a=document.getElementById("stale-results-notice"))==null||a.classList.toggle("hidden",!e),(n=document.getElementById("results-container"))==null||n.classList.toggle("opacity-50",e)}function Oe(e){var a,n;(a=document.getElementById("results-placeholder"))==null||a.classList.toggle("hidden",e),(n=document.getElementById("results-content"))==null||n.classList.toggle("hidden",!e)}function Z(e,a="暂存当前工业热泵方案 (请先计算)"){const n=document.getElementById("saveScenarioBtn"),o=document.getElementById("enableScenarioComparison");if(!(!n||!o)){if(!o.checked){n.classList.add("hidden");return}n.classList.remove("hidden"),n.disabled=e==="disabled",n.classList.toggle("bg-gray-400",e==="disabled"),n.classList.toggle("cursor-not-allowed",e==="disabled"),n.classList.toggle("bg-green-600",e!=="disabled"),n.classList.toggle("hover:bg-green-700",e!=="disabled"),e==="saved"?(n.textContent="方案已暂存!",setTimeout(()=>{Z("enabled")},2e3)):n.textContent=a}}function we(e){const a=document.getElementById("priceTierError");a&&(e?(a.textContent=e,a.classList.remove("hidden")):a.classList.add("hidden"))}function He(e){const{analysisMode:a}=e;a==="bot"?Ne():Ae(e)}function Ne(e){const a=document.getElementById("results-content");a&&(a.innerHTML='<div class="p-6">BOT 模式结果渲染区</div>')}function Ae(e){const{lccParams:a,comparisons:n}=e,o=e.isHybridMode?e.hybridSystem:e.hp,s=a.lccYears,t=a.discountRate,i=document.getElementById("results-content");if(!i)return;const l=document.getElementById("results-title");l&&(l.textContent=`静态、ROI 与 LCC (${s}年) 对比分析结果`);const c=o.isHybrid||!1,r=c?"混合系统年运行成本 (第1年)":"工业热泵系统年运行成本 (第1年)",g=c?`混合系统 LCC (${s}年)`:`工业热泵系统 LCC (${s}年)`;let m=`
        <div class="space-y-6">
            <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
                <h3 class="font-semibold text-lg text-blue-800 mb-2">${r}</h3>
                <div class="flex flex-col sm:flex-row justify-between sm:items-baseline sm:gap-4">
                    <div>
                        <p class="text-xs text-blue-700">年总运行成本</p>
                        <p class="text-3xl font-bold text-blue-600">${B(o.opex)} 万元</p>
                    </div>
                    <div class="sm:text-right mt-2 sm:mt-0">
                        <p class="text-xs text-blue-700">折算吨蒸汽电耗</p>
                        <p class="text-xl font-semibold text-blue-600">${O(o.electricity_per_steam_ton,1)} kWh/t</p>
                    </div>
                    <div class="sm:text-right mt-2 sm:mt-0">
                        <p class="text-xs text-blue-700">折算吨蒸汽单价</p>
                        <p class="text-xl font-semibold text-blue-600">${re(o.cost_per_steam_ton)} 元/t</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-blue-100 border-l-4 border-blue-600 p-6 rounded-lg">
                <h3 class="font-semibold text-lg text-blue-900">
                    ${g}
                </h3>
                <p class="text-xs text-blue-700 mb-1">LCC = 初始投资 + (未来${s}年所有运营成本 - ${s}年后残值)</p>
                <p class="text-3xl font-bold text-blue-700">${B(o.lcc.total)} 万元</p>
            </div>
        </div>
    `;n.forEach(u=>{const x=u.npv>0?"text-green-600":"text-red-600",h=u.irr>t?"text-green-600":u.irr===null||!isFinite(u.irr)?"text-gray-500":"text-red-600",v=u.dynamicPBP!==null?"text-blue-600":"text-red-600",y=u.opexSaving>0?"text-green-600":"text-red-600",I=u.energyCostSaving>0?"text-green-600":"text-red-600",C=u.simpleROI!==null?"text-green-600":"text-gray-500";m+=`
        <div class="bg-gray-50 p-6 rounded-lg border mt-8 space-y-4">
            <h4 class="text-xl font-bold text-gray-800 border-b pb-3">与 <span class="text-blue-600">${u.name}</span> 对比</h4>
            
            <div class="space-y-2">
                <h5 class="font-semibold text-blue-800 text-md">视角: 投资回报率 (ROI)</h5>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">简单投资回报率 (ROI)</span>
                    <span class="font-bold text-lg ${C}">${_(u.simpleROI)}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">净现值 (NPV)</span>
                    <span class="font-bold text-lg ${x}">${B(u.npv)} 万元</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">内部收益率 (IRR)</span>
                    <span class="font-bold text-lg ${h}">${_(u.irr)}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2">
                    <span class="text-gray-600">动态回收期 (PBP)</span>
                    <span class="font-bold text-lg ${v}">${Q(u.dynamicPBP)}</span>
                </div>
            </div>

            <div class="space-y-2 pt-4 border-t">
                <h5 class="font-semibold text-gray-800 text-md">视角: 静态 (第1年) 与 环境</h5>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">电热价格比 (EPR)</span>
                    <span class="font-bold text-lg ${u.electricalPriceRatio>1?"text-green-600":"text-red-600"}">${u.electricalPriceRatio?u.electricalPriceRatio.toFixed(2):"N/A"}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">年节省能源费:</span>
                    <span class="font-semibold ${I}">${B(u.energyCostSaving)} 万元</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">能源费节能率:</span>
                    <span class="font-semibold ${I}">${_(u.energyCostSavingRate)}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">年节省总成本 (含运维):</span>
                    <span class="font-semibold ${y}">${B(u.opexSaving)} 万元</span>
                </div>
                 <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">静态回报期 (总成本):</span>
                    <span class="font-semibold">${u.paybackPeriod}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">基准年能源消耗:</span>
                    <span class="font-semibold text-gray-700">${O(u.consumption,2)} ${u.consumptionUnit}</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2">
                    <span class="text-gray-600">年碳减排量:</span>
                    <span class="font-semibold text-green-600">${A(u.co2Reduction)} 吨 CO₂</span>
                </div>
            </div>

             <div class="space-y-2 pt-4 border-t">
                <h5 class="font-semibold text-gray-800 text-md">视角: 全生命周期成本 (LCC)</h5>
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-200">
                    <span class="text-gray-600">${c?"混合系统":"工业热泵"} LCC:</span>
                    <span class="font-semibold text-blue-700">${B(o.lcc.total)} 万元</span>
                </div>
                <div class="flex justify-between items-center text-sm py-2">
                    <span class="text-gray-600">${u.name} LCC:</span>
                    <span class="font-semibold text-gray-700">${B(u.lcc)} 万元</span>
                </div>
            </div>
        </div>
        `});let d=`
        <div class="bg-indigo-50 border-l-4 border-indigo-500 p-6 rounded-lg space-y-3 mt-8">
            <h4 class="text-xl font-bold text-indigo-800 border-b pb-2">综合结论 (基于 ${s} 年分析)</h4>
    `;const b=n.filter(u=>u.irr>t&&isFinite(u.irr));if(b.length>0){const u=b.reduce((x,h)=>x.irr>h.irr?x:h);d+=`<p class="text-sm text-gray-700"><b>投资回报 (ROI) 结论：</b>项目可行。相较于 <b>${b.map(x=>x.name).join("、")}</b>，IRR 高于基准收益率(${_(t)})。回报最佳的是替代 <b>${u.name}</b>，IRR 高达 <b>${_(u.irr)}</b>，动态回收期 <b>${Q(u.dynamicPBP)}</b>。</p>`}else{const u=n.length>0?n.reduce((x,h)=>x.npv>h.npv?x:h):null;u&&u.npv>0?d+=`<p class="text-sm text-gray-700"><b>投资回报 (ROI) 结论：</b>项目勉强可行。相较于 <b>${u.name}</b>，项目净现值(NPV)为正 (<b>${B(u.npv)} 万元</b>)，但所有方案 IRR 均未超过基准收益率(${_(t)})。</p>`:d+=`<p class="text-sm text-red-700"><b>投资回报 (ROI) 结论：</b>项目不可行。相较于所有对比方案，项目的 IRR 均低于基准收益率(${_(t)})，且 NPV 均为负。</p>`}const f=n.filter(u=>u.co2Reduction>0);if(f.length>0){const u=f.reduce((x,h)=>x.co2Reduction>h.co2Reduction?x:h);d+=`<p class="text-sm text-gray-700"><b>环境效益 (年)：</b>替代 <b>${u.name}</b> 的环境效益最为显著，年碳减排量可达 <b>${A(u.co2Reduction)}</b> 吨CO₂，相当于植树约 <b>${Se(u.treesPlanted)}</b> 棵。</p>`}else n.length>0&&(d+=`<p class="text-sm text-gray-700"><b>环境效益 (年)：</b>根据当前参数，${c?"混合":"工业热泵"}方案相较于所选对比方案均无碳减排优势。</p>`);d+="</div>",m+=d,m+=`
        <div class="mt-8 space-y-2">
            <button id="toggle-details-btn" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">显示详细计算过程 (含公式)</button>
            <div id="calculation-details" class="hidden bg-white rounded-lg border text-sm space-y-4 mt-2"></div>
            
            <button id="toggle-risk-btn" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">显示投资风险及对策分析</button>
            <div id="risk-analysis-details" class="hidden bg-white rounded-lg border text-sm space-y-4 mt-2"></div>
            
            <button id="printReportBtn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition mt-4">打印本页报告 (A4)</button>
        </div>
    `,i.innerHTML=m}function Ue(e){console.log("--- [Debug] 正在渲染详细过程，收到的 results 对象是: ---",e),document.getElementById("calculation-details")&&(e.analysisMode==="bot"?Ye():De(e))}function qe(e){const a=document.getElementById("risk-analysis-details");if(!a)return;let n='<div class="p-6 space-y-4">';e==="bot"?n+=`
            <h3 class="text-lg font-bold border-b pb-2 mb-4">BOT 模式投资风险及对策分析</h3>
            <h4 class="font-semibold text-gray-800">1. 财务与市场风险</h4>
            <ul class="list-disc list-inside text-sm space-y-2">
                <li><b>风险 (收入不及预期):</b> 客户用热量未达标，或能源销售单价（热价）低于预期，导致年销售收入无法实现。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 签订“照付不议”合同:</b> 与客户约定最低用热量，未达到也需按约定付费。<b>(2) 价格联动:</b> 合同中应包含能源价格（电价）与销售热价的联动条款。</li>
                <li><b>风险 (成本失控):</b> 能源价格（电价、天然气等）涨幅超过预期，或设备能效未达标导致能耗过高。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 成本锁定:</b> 尽可能签订长期能源供应合同。<b>(2) 敏感性分析:</b> 测算能源成本上涨对项目TIRR和EIRR的影响。</li>
            </ul>
        `:n+=`
            <h3 class="text-lg font-bold border-b pb-2 mb-4">工业热泵投资风险及对策分析 (成本对比)</h3>
            <h4 class="font-semibold text-gray-800">1. 政策与市场风险</h4>
            <ul class="list-disc list-inside text-sm space-y-2">
                <li><b>风险 (电价波动):</b> "峰谷尖"电价政策调整，尤其是谷电价格上涨或峰电涨幅不及预期，可能导致运行成本高于预期。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 精确评估:</b> 采用加权平均电价或分时电价模型进行精确测算。<b>(2) 敏感性分析:</b> 测算电价上涨对IRR和PBP的影响。<b>(3) 绿电合约:</b> 探索与发电企业签订长期购电协议 (PPA)。</li>
            </ul>
            <h4 class="font-semibold text-gray-800 mt-4">2. 技术与运行风险</h4>
            <ul class="list-disc list-inside text-sm space-y-2">
                <li><b>风险 (性能衰减/SPF不达标):</b> 全年综合能效系数(SPF)低于设计值，导致实际运行电耗过高。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 选型匹配:</b> 基于项目地最冷月平均工况进行主机选型。<b>(2) 耦合设计:</b> 采用“工业热泵 + 辅助热源”的耦合方案。<b>(3) 明确SPF:</b> 明确SPF的计算边界。</li>
            </ul>
            <h4 class="font-semibold text-gray-800 mt-4">3. 财务与LCC风险</h4>
            <ul class="list-disc list-inside text-sm space-y-2">
                 <li><b>风险 (LCC估算偏差):</b> 仅对比“第1年运行成本”，忽略了初始投资(CAPEX)和未来成本。</li>
                <li class="pl-4 text-gray-600"><b>对策:</b> <b>(1) 采用LCC:</b> 坚持使用 LCC 作为决策依据。<b>(2) 考虑通胀:</b> 必须设置合理的“能源价格涨幅”和“运维成本涨幅”。</li>
            </ul>
        `,n+="</div>",a.innerHTML=n}function De(e){const a=document.getElementById("calculation-details");if(!a)return;const{isHybridMode:n,lccParams:o,hp:s,comparisons:t,inputs:i,hybridSystem:l,hybrid_aux:c}=e,r=n?l:s,{annualHeatingDemandKWh:g,weightedAvgElecPrice:m}=i;i.isGreenElectricity||i.gridFactor,i.isGreenElectricity;let d='<div class="p-4 md:p-6 space-y-6 text-xs">';if(d+=`
        <div>
            <h3 class="text-base font-bold border-b pb-2 mb-2">A. 核心经济指标计算方法与依据</h3>
            <div class="space-y-1 text-gray-600">
                <p><b>全寿命周期成本 (LCC):</b> LCC = CAPEX + NPV(Energy) + NPV(O&M) - NPV(Salvage)。</p>
                <p><b>净现值 (NPV):</b> NPV = (LCC_基准 - LCC_工业热泵)。NPV > 0 代表项目可行。</p>
                <p><b>内部收益率 (IRR):</b> 使项目净现值(NPV)等于零时的折现率。IRR > 基准折现率，代表项目优秀。</p>
            </div>
        </div>
    `,n){const b=(i.hybridLoadShare*100).toFixed(1),f=(100-parseFloat(b)).toFixed(1);d+=`
            <div>
                <h3 class="text-base font-bold border-b pb-2 mb-2">B. 本次项目详细计算过程 (混合模式)</h3>
                <p><b>年总制热量:</b> ${O(g,0)} kWh</p>
                <div class="mt-2 p-3 bg-blue-50 rounded-md space-y-1">
                    <h4 class="font-semibold text-blue-800">方案A: 混合系统 (总计)</h4>
                    <p>• 年总运行成本 (第1年): ${B(l.opex)} 万元</p>
                    <p>• 年总碳排放量: ${A(l.co2)} 吨 CO₂</p>
                    <p>• 产热成本: ${l.cost_per_kwh_heat.toFixed(4)} 元/kWh_热</p>
                </div>
                <div class="mt-2 p-3 bg-gray-50 rounded-md space-y-1">
                    <h4 class="font-semibold text-gray-700">混合系统 - 工业热泵部分 (${b}%)</h4>
                    <p>• 年能源成本: ${re(s.energyCost)} 元</p>
                </div>
                <div class="mt-2 p-3 bg-gray-50 rounded-md space-y-1">
                    <h4 class="font-semibold text-gray-700">混合系统 - 辅助热源 (${c.name}, ${f}%)</h4>
                    <p>• 年能源消耗: ${O(c.consumption)} ${c.consumptionUnit}</p>
                    <p>• 年能源成本: ${re(c.energyCost)} 元</p>
                </div>
            </div>
        `}else d+=`
            <div>
                <h3 class="text-base font-bold border-b pb-2 mb-2">B. 本次项目详细计算过程 (标准模式)</h3>
                 <p><b>年总制热量:</b> ${O(g,0)} kWh</p>
                 <div class="mt-2 p-3 bg-blue-50 rounded-md space-y-1">
                    <h4 class="font-semibold text-blue-800">方案A: 工业热泵</h4>
                    
                    <!-- FINAL ROBUST FIX: It will now correctly display the value -->
                    <p>• 年总电耗: ${O(r.consumption,0)} kWh</p>
                    
                    <p>• 年总运行成本: ${B(s.opex)} 万元</p>
                    <p>• 产热成本: ${s.cost_per_kwh_heat.toFixed(4)} 元/kWh_热</p>
                    <p>• 年碳排放量: ${A(s.co2)} 吨 CO₂</p>
                </div>
            </div>
        `;d+='<div class="space-y-4">',t.forEach(b=>{const f=e[b.key];d+=`
            <div class="pt-4 border-t">
                <h4 class="font-semibold text-gray-800">对比: ${n?l.name:"工业热泵"} vs ${b.name}</h4>
                <div class="text-gray-600 space-y-1 mt-1">
                    <p>• <b>基准 (${b.name}) 年消耗:</b> ${O(f.consumption,1)} ${f.consumptionUnit}</p>
                    <p>• <b>基准 (${b.name}) 年运行成本:</b> ${B(f.opex)} 万元</p>
                    <p class="font-semibold text-green-700">↳ 年节省总成本: ${B(b.opexSaving)} 万元</p>
                    <p class="font-semibold text-blue-800">↳ LCC 节省 (NPV): ${B(b.npv)} 万元</p>
                    <p class="font-semibold text-blue-800">↳ 内部收益率 (IRR): ${_(b.irr)}</p>
                </div>
            </div>
        `}),d+="</div></div>",a.innerHTML=d}function Je(e){const a=document.getElementById("print-report-container");if(!a)return;const{inputs:n,lccParams:o,comparisons:s,hp:t,isHybridMode:i,hybridSystem:l}=e,c=n.projectName||"未命名项目",r=new Date().toLocaleString("zh-CN");let g=`
        <div class="print-header">
            <h2>${c} 项目</h2>
            <h1>工业热泵经济与环境效益分析报告</h1>
            <p>报告日期: ${r}</p>
        </div>
        <div class="print-section">
            <h3>1. 核心输入参数</h3>
            <table class="print-table">
                <tr><td>项目名称</td><td>${c}</td></tr>
                <tr><td>年总制热量</td><td class="text-right">${O(n.annualHeatingDemandKWh,0)} kWh</td></tr>
                <tr><td>经济分析年限</td><td class="text-right">${o.lccYears} 年</td></tr>
                <tr><td>基准折现率</td><td class="text-right">${_(o.discountRate,1)}</td></tr>
            </table>
        </div>
        <div class="print-section">
            <h3>2. 方案静态对比 (第1年)</h3>
            <table class="print-table">
                <thead><tr><th>方案名称</th><th class="text-right">总投资(万)</th><th class="text-right">年运行成本(万)</th></tr></thead>
                <tbody>
                    <tr>
                        <td><strong>${i?l.name:"工业热泵方案"}</strong></td>
                        <td class="text-right"><strong>${B(i?l.lcc.capex:t.lcc.capex)}</strong></td>
                        <td class="text-right"><strong>${B(i?l.opex:t.opex)}</strong></td>
                    </tr>
    `;s.forEach(m=>{const d=e[m.key];g+=`<tr><td>${m.name}</td><td class="text-right">${B(d.lcc.capex)}</td><td class="text-right">${B(d.opex)}</td></tr>`}),g+=`
                </tbody>
            </table>
        </div>
        <div class="print-section">
            <h3>3. 核心经济与环境效益</h3>
            <table class="print-table">
                <thead><tr><th>对比项</th><th class="text-right">IRR</th><th class="text-right">动态PBP (年)</th><th class="text-right">年碳减排 (tCO₂)</th></tr></thead>
                <tbody>
    `,s.forEach(m=>{g+=`<tr><td>vs. ${m.name}</td><td class="text-right">${_(m.irr)}</td><td class="text-right">${Q(m.dynamicPBP)}</td><td class="text-right">${A(m.co2Reduction)}</td></tr>`}),g+=`
                </tbody>
            </table>
        </div>
        <div class="print-footer"><p>报告由工业热泵经济与环境效益分析器 Pro 生成。</p></div>
    `,a.innerHTML=g}function Ye(e){const a=document.getElementById("calculation-details");a&&(a.innerHTML='<p class="p-4">BOT 模式的详细计算过程功能待添加。</p>')}function je(e){const{analysisMode:a}=e,n={lccYears:e.lccYears,discountRate:e.discountRate,energyInflationRate:e.energyInflationRate,opexInflationRate:e.opexInflationRate},{annualHeatingDemandKWh:o}=e;if(a==="bot")return We(e,n,e.botAnnualEnergyCost,e.botAnnualOpexCost);{const s=e.hpCop>0?o/e.hpCop:0;let t=0;const i={tiers:[]};e.priceTiers.forEach(c=>{const r=c.dist/100,g=s*r,m=g*c.price;t+=m,i.tiers.push({name:c.name,elec:g,price:c.price,cost:m})});let l=0;if(s>0)l=t/s;else if(e.priceTiers.length>0){let c=0;e.priceTiers.forEach(r=>{l+=r.price*r.dist,c+=r.dist}),c>0?l=l/c:e.priceTiers.length===1&&(l=e.priceTiers[0].price)}return Ge(e,n,l,t,i,o,a,s)}}function We(e,a,n,o){const{lccYears:s,discountRate:t,energyInflationRate:i,opexInflationRate:l}=a,c=e.hpHostCapex+e.hpStorageCapex,r=c*e.botEquityRatio,g=c-r,m=c*e.hpSalvageRate,d={years:[],revenue:[],vat:[],revenueNetVat:[],surtax:[],energyCost:[],opexCost:[],depreciation:[],interest:[],totalCost:[],profitBeforeTax:[],incomeTax:[],netProfit:[],cf_TotalInvestment:[],cf_Equity:[]},b=e.botDepreciationYears>0?g/e.botDepreciationYears:0;for(let y=1;y<=s;y++){d.years.push(y);const I=e.botAnnualRevenue,C=I/(1+e.botVatRate),S=I-C,L=S*e.botSurtaxRate,P=n*Math.pow(1+i,y-1),R=o*Math.pow(1+l,y-1),k=y<=e.botDepreciationYears?c*(1-e.hpSalvageRate)/e.botDepreciationYears:0;let $=0;y<=e.botDepreciationYears&&($=(g-b*(y-1))*e.botLoanInterestRate);const U=P+R+k+$+L,M=C-U,w=Math.max(0,M)*e.botIncomeTaxRate,V=M-w;d.revenue.push(I),d.vat.push(S),d.revenueNetVat.push(C),d.surtax.push(L),d.energyCost.push(P),d.opexCost.push(R),d.depreciation.push(k),d.interest.push($),d.totalCost.push(U),d.profitBeforeTax.push(M),d.incomeTax.push(w),d.netProfit.push(V);let q=(M+$)*(1-e.botIncomeTaxRate)+k,E=y<=e.botDepreciationYears?b:0,F=V+k-E;y===s&&(q+=m,F+=m),d.cf_TotalInvestment.push(q),d.cf_Equity.push(F)}const f=[-c,...d.cf_TotalInvestment],p=[-r,...d.cf_Equity],u={investment:c/1e4,equity:r/1e4,loan:g/1e4,irr:le(f),npv:j(f,t)/1e4,pbp:ie(f,t,s),equityIRR:le(p),equityNPV:j(p,t)/1e4,equityPBP:ie(p,t,s)},x=y=>y.reduce((I,C)=>I+C,0),h=y=>y.length>0?x(y)/y.length/1e4:0,v={revenue:h(d.revenue),vat:h(d.vat),revenueNetVat:h(d.revenueNetVat),surtax:h(d.surtax),energyCost:h(d.energyCost),opexCost:h(d.opexCost),depreciation:h(d.depreciation),interest:h(d.interest),totalCost:h(d.totalCost),profitBeforeTax:h(d.profitBeforeTax),incomeTax:h(d.incomeTax),netProfit:h(d.netProfit)};return{analysisMode:"bot",inputs:e,lccParams:a,botAnalysis:{summary:u,annualAvg:v,cashFlows:d}}}function Ge(e,a,n,o,s,t,i,l){const c={},{lccYears:r,discountRate:g,energyInflationRate:m,opexInflationRate:d,priceTiers:b,isHybridMode:f,gridFactor:p}=e;c.inputs=e,c.lccParams=a,c.isHybridMode=f,c.annualHeatingDemandKWh=t,c.weightedAvgElecPrice=n;const u=700;let x;const h=e.hpHostCapex+e.hpStorageCapex;if(f){const{hybridLoadShare:y,hybridAuxHeaterType:I,hybridAuxHeaterCapex:C,hybridAuxHeaterOpex:S}=e;c.hybridInputs={hybridLoadShare:y,hybridAuxHeaterType:I,hybridAuxHeaterCapex:C,hybridAuxHeaterOpex:S};const L=t*y,P=t*(1-y),R=e.hpCop>0?L/e.hpCop:0;let k=0;const $={tiers:[]};b.forEach(D=>{const oe=D.dist/100,ue=R*oe,me=ue*D.price;k+=me,$.tiers.push({name:D.name,elec:ue,price:D.price,cost:me})});const U=k+e.hpOpexCost,M=R*p,w=Y(k,r,g,m),V=Y(e.hpOpexCost,r,g,d),z=h*e.hpSalvageRate,X=z/Math.pow(1+g,r),q=h+w+V-X,E={isHybridPart:!0,name:"工业热泵 (混合)",energyCost:k,energyCostDetails:$,opexCost:e.hpOpexCost,opex:U,co2:M,lcc:{capex:h,capex_host:e.hpHostCapex,capex_storage:e.hpStorageCapex,energyNPV:w,opexNPV:V,salvageRate:e.hpSalvageRate,salvageNPV:X,salvageValue:z,total:q}};c.hp=E;const F=N(I,P,C,S,a,e,p,n);c.hybrid_aux=F;const H=t>0?t/u:0,K={isHybrid:!0,name:"混合系统 (工业热泵 + "+F.name+")",energyCost:E.energyCost+F.energyCost,opexCost:E.opexCost+F.opexCost,opex:E.opex+F.opex,co2:E.co2+F.co2,cost_per_kwh_heat:t>0?(E.energyCost+F.energyCost)/t:0,electricity_per_steam_ton:H>0?R/H:0,cost_per_steam_ton:H>0?(E.energyCost+F.energyCost)/H:0,lcc:{capex:E.lcc.capex+F.lcc.capex,energyNPV:E.lcc.energyNPV+F.lcc.energyNPV,opexNPV:E.lcc.opexNPV+F.lcc.opexNPV,salvageNPV:E.lcc.salvageNPV+F.lcc.salvageNPV,salvageValue:E.lcc.salvageValue+F.lcc.salvageValue,total:E.lcc.total+F.lcc.total}};c.hybridSystem=K,x=K}else{const y=o+e.hpOpexCost,I=l*p,C=Y(o,r,g,m),S=Y(e.hpOpexCost,r,g,d),L=h*e.hpSalvageRate,P=L/Math.pow(1+g,r),R=h+C+S-P,k=t>0?t/u:0,$={isHybrid:!1,name:"工业热泵系统",consumption:l,consumptionUnit:"kWh",energyCost:o,energyCostDetails:s,opexCost:e.hpOpexCost,opex:y,co2:I,cost_per_kwh_heat:e.hpCop>0?n/e.hpCop:0,electricity_per_steam_ton:k>0?l/k:0,cost_per_steam_ton:k>0?o/k:0,lcc:{capex:h,capex_host:e.hpHostCapex,capex_storage:e.hpStorageCapex,energyNPV:C,opexNPV:S,salvageRate:e.hpSalvageRate,salvageNPV:P,salvageValue:L,total:R}};c.hp=$,x=$}const v=[];return e.compare.gas&&v.push(N("gas",t,e.gasBoilerCapex,e.gasOpexCost,a,e,p,n)),e.compare.fuel&&v.push(N("fuel",t,e.fuelBoilerCapex,e.fuelOpexCost,a,e,p,n)),e.compare.coal&&v.push(N("coal",t,e.coalBoilerCapex,e.coalOpexCost,a,e,p,n)),e.compare.biomass&&v.push(N("biomass",t,e.biomassBoilerCapex,e.biomassOpexCost,a,e,p,n)),e.compare.electric&&v.push(N("electric",t,e.electricBoilerCapex,e.electricOpexCost,a,e,p,n)),e.compare.steam&&v.push(N("steam",t,e.steamCapex,e.steamOpexCost,a,e,p,n)),v.forEach(y=>{c[y.key]=y}),c.comparisons=v.map(y=>{const I=y.energyCost-x.energyCost;let C=y.energyCost>0?I/y.energyCost:x.energyCost<=0?0:-1/0,S=x.cost_per_kwh_heat>0&&y.cost_per_kwh_heat>0?y.cost_per_kwh_heat/x.cost_per_kwh_heat:null;const L=x.lcc.capex-y.lcc.capex,P=y.opex-x.opex;let R="无法收回投资";P>0&&L>0?R=(L/P).toFixed(2)+" 年":L<=0&&P>0?R="无需额外投资":L<=0&&P<=0&&(R="无额外投资/无节省");let k=L>0&&P>0?P/L:null;const $=y.co2-x.co2,U=$>0?$/18.3:0,M=y.lcc.total-x.lcc.total,w=M,V=[-L];for(let E=1;E<=r;E++){const F=x.energyCost*Math.pow(1+m,E-1),H=y.energyCost*Math.pow(1+m,E-1),K=x.opexCost*Math.pow(1+d,E-1),D=y.opexCost*Math.pow(1+d,E-1),oe=H+D-(F+K);V.push(oe)}const z=x.lcc.salvageValue-y.lcc.salvageValue;V[r]+=z;const X=le(V),q=ie(V,g,r);return{key:y.key,name:y.name,opex:y.opex,opexSaving:P,investmentDiff:L,paybackPeriod:R,co2Reduction:$,treesPlanted:U,lcc:y.lcc.total,lccSaving:M,npv:w,irr:X,dynamicPBP:q,simpleROI:k,electricalPriceRatio:S,energyCostSaving:I,energyCostSavingRate:C,consumption:y.consumption,consumptionUnit:y.consumptionUnit}}),c.analysisMode=i,c}function N(e,a,n,o,s,t,i,l){const{lccYears:c,discountRate:r,energyInflationRate:g,opexInflationRate:m}=s,d=a*3.6;let b=0,f=0,p=0,u=0,x="未知",h=0,v="";switch(e){case"gas":x="天然气锅炉",u=t.gasSalvageRate,v="m³",t.gasBoilerEfficiency>0&&t.gasCalorific>0&&(p=d/t.gasBoilerEfficiency/t.gasCalorific,b=p*t.gasPrice,f=p*t.gasFactor,h=t.gasPrice/(t.gasCalorific/3.6*t.gasBoilerEfficiency));break;case"fuel":x="燃油锅炉",u=t.fuelSalvageRate,v="吨",t.fuelBoilerEfficiency>0&&t.fuelCalorific>0&&(p=d/t.fuelBoilerEfficiency/t.fuelCalorific/1e3,b=p*t.fuelPrice,f=p*t.fuelFactor,h=t.fuelPrice/1e3/(t.fuelCalorific/3.6*t.fuelBoilerEfficiency));break;case"coal":x="燃煤锅炉",u=t.coalSalvageRate,v="吨",t.coalBoilerEfficiency>0&&t.coalCalorific>0&&(p=d/t.coalBoilerEfficiency/t.coalCalorific/1e3,b=p*t.coalPrice,f=p*t.coalFactor,h=t.coalPrice/1e3/(t.coalCalorific/3.6*t.coalBoilerEfficiency));break;case"biomass":x="生物质锅炉",u=t.biomassSalvageRate,v="吨",t.biomassBoilerEfficiency>0&&t.biomassCalorific>0&&(p=d/t.biomassBoilerEfficiency/t.biomassCalorific/1e3,b=p*t.biomassPrice,f=p*t.biomassFactor,h=t.biomassPrice/1e3/(t.biomassCalorific/3.6*t.biomassBoilerEfficiency));break;case"electric":x="电锅炉",u=t.electricSalvageRate,v="kWh",t.electricBoilerEfficiency>0&&(p=a/t.electricBoilerEfficiency,b=p*l,f=p*i,h=l/t.electricBoilerEfficiency);break;case"steam":if(x="管网蒸汽",u=t.steamSalvageRate,v="吨",t.steamEfficiency>0&&t.steamCalorific>0){const R=a/t.steamEfficiency;p=R/t.steamCalorific,b=p*t.steamPrice,f=R*t.steamFactor,h=t.steamPrice/(t.steamCalorific*t.steamEfficiency)}break}const y=b+o,I=Y(b,c,r,g),C=Y(o,c,r,m),S=n*u,L=S/Math.pow(1+r,c),P=n+I+C-L;return{key:e,name:x,energyCost:b,opexCost:o,opex:y,co2:f,consumption:p,consumptionUnit:v,cost_per_kwh_heat:h,lcc:{capex:n,energyNPV:I,opexNPV:C,salvageRate:u,salvageNPV:L,salvageValue:S,total:P}}}let de={},he=!1;function ze(){he&&(be(!0),Z("disabled","暂存当前工业热泵方案 (请先计算)"))}function Xe(){be(!1);const e=Re(we,G);if(!e)return;const a=je(e);console.log("--- [Debug] 计算刚刚完成，生成的完整 results 对象是: ---",a),de=a,he=!0,Oe(!0),He(a),setTimeout(()=>{Qe(a)},0),a.analysisMode!=="bot"?Z("enabled"):Z("disabled","BOT 模式不支持暂存")}function Qe(e){const{inputs:a,comparisons:n,isHybridMode:o,analysisMode:s}=e,t=s==="bot"?e.hp:o?e.hybridSystem:e.hp,i=(l,c)=>{const r=document.getElementById(l);if(r){const g=r.cloneNode(!0);r.parentNode.replaceChild(g,r),g.addEventListener("click",c)}else console.warn(`Button with id '${l}' not found after calculation.`)};i("toggle-details-btn",l=>{const c=document.getElementById("calculation-details");if(!c)return;const r=!c.classList.contains("hidden");c.classList.toggle("hidden"),l.target.textContent=r?"显示详细计算过程 (含公式)":"隐藏详细计算过程 (含公式)",r||Ue(de)}),i("toggle-risk-btn",l=>{const c=document.getElementById("risk-analysis-details");if(!c)return;const r=!c.classList.contains("hidden");c.classList.toggle("hidden"),l.target.textContent=r?"显示投资风险及对策分析":"隐藏投资风险及对策分析",r||qe(s)}),i("printReportBtn",()=>{Je(de),window.print()}),i("saveScenarioBtn",()=>{const l=a.projectName||"未命名方案",c=a.hpCop;if(s==="bot"){G("BOT 模式的方案暂存功能正在开发中","info");return}if(t&&n&&n.length>0){const r=n.find(g=>g.key==="gas")||n[0];Te(l,t,c,r),Z("saved")}else t&&(!n||n.length===0)?G("无法暂存，因为没有勾选任何对比方案。","error"):G("无法暂存，计算数据不存在。","error")})}document.addEventListener("DOMContentLoaded",()=>{Pe(ze,G),_e(Ve,G);const e=document.getElementById("calculateBtn");if(e)e.addEventListener("click",Xe);else{console.error("FATAL: Main 'calculateBtn' not found. Application cannot start.");const a=document.querySelector(".container");a&&(a.innerHTML='<div class="text-center p-8 bg-red-100 text-red-700 rounded-lg"><strong>严重错误:</strong> 无法找到核心计算按钮。页面无法正常工作。</div>')}Me()});
